<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס מכר | משרד עו"ד גיא הרשקוביץ</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <!-- Environment Configuration -->
    <script src="env-config.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --primary-blue-hover: #1d4ed8;
            --light-blue: #eff6ff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--light-blue) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
            padding-bottom: 72px;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }


        .logo-placeholder {
            width: 120px;
            height: 60px;
            background: var(--gray-200);
            border-radius: 8px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
            font-size: 12px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
        }

        .header p {
            color: var(--gray-500);
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .header p {
                font-size: 14px;
            }
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 40px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 8px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gray-200);
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
            transform: translateY(-50%);
            z-index: 2;
            transition: width 0.4s ease;
        }

        .step-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            border: 2px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-400);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .step-indicator.completed {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: var(--white);
        }

        .step-labels {
            display: flex;
            justify-content: space-between;
        }

        .step-label {
            font-size: 12px;
            color: var(--gray-400);
            text-align: center;
            width: 70px;
            transition: color 0.3s ease;
        }

        .step-label.active {
            color: var(--primary-blue);
            font-weight: 500;
        }

        /* Form Card */
        .form-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 32px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .form-card {
                padding: 24px 20px;
                border-radius: 12px;
            }
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .step-title {
                font-size: 18px;
                margin-bottom: 20px;
            }
        }

        .step-title-icon {
            width: 32px;
            height: 32px;
            background: var(--light-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Form Elements */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.15s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--light-blue);
        }

        .autocomplete-item-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .autocomplete-item-details {
            font-size: 13px;
            color: var(--gray-500);
        }

        .autocomplete-no-results {
            padding: 16px;
            text-align: center;
            color: var(--gray-400);
            font-size: 14px;
        }

        .autocomplete-loading {
            padding: 16px;
            text-align: center;
            color: var(--primary-blue);
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 500px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        label .required {
            color: var(--error);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Heebo', sans-serif;
            color: var(--gray-800);
            transition: all 0.2s ease;
            background: var(--white);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input::placeholder, textarea::placeholder {
            color: var(--gray-400);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            padding-left: 40px;
        }

        /* Radio & Checkbox Groups */
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-option, .checkbox-option {
            flex: 1;
            min-width: 120px;
        }

        .radio-option input, .checkbox-option input {
            display: none;
        }

        .radio-option label, .checkbox-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 400;
            text-align: center;
        }

        .radio-option input:checked + label,
        .checkbox-option input:checked + label {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            color: var(--primary-blue);
            font-weight: 500;
        }

        .radio-option label:hover,
        .checkbox-option label:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        /* Conditional Fields */
        .conditional-field {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .conditional-field.show {
            display: block;
        }

        /* Buttons */
        .buttons-row {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* User Selection */
        .user-selection {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 32px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .user-selection {
                padding: 24px 20px;
                border-radius: 12px;
            }
        }

        .user-selection h2 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .user-selection p {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        @media (max-width: 500px) {
            .user-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }

        .user-btn {
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Heebo', sans-serif;
        }

        .user-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #60a5fa 100%);
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 18px;
        }

        .user-name {
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Success Message */
        .success-screen {
            display: none;
            text-align: center;
            padding: 40px 20px;
            position: relative;
            overflow: hidden;
        }

        .success-screen.show {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border-radius: 50%;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        }

        @keyframes successPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .success-icon svg {
            width: 50px;
            height: 50px;
            color: var(--white);
            stroke-width: 3;
        }

        .celebration-emoji {
            font-size: 48px;
            margin-bottom: 16px;
            animation: bounce 0.8s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .success-screen h2 {
            font-size: 28px;
            color: var(--gray-800);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .success-screen .subtitle {
            color: var(--success);
            margin-bottom: 24px;
            font-size: 16px;
            font-weight: 600;
        }

        .sale-summary {
            background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            text-align: right;
        }

        .sale-summary-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
            text-align: center;
        }

        .sale-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
        }

        .sale-detail:last-child {
            border-bottom: none;
        }

        .sale-detail-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        .sale-detail-value {
            color: var(--gray-800);
            font-weight: 600;
            font-size: 15px;
        }

        .sale-amount {
            background: var(--success);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            font-size: 24px;
            font-weight: 700;
        }

        /* Confetti Animation */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti:nth-child(1) { left: 10%; background: #ff6b6b; animation-delay: 0s; }
        .confetti:nth-child(2) { left: 20%; background: #4ecdc4; animation-delay: 0.2s; }
        .confetti:nth-child(3) { left: 30%; background: #ffe66d; animation-delay: 0.4s; }
        .confetti:nth-child(4) { left: 40%; background: #a8e6cf; animation-delay: 0.6s; }
        .confetti:nth-child(5) { left: 50%; background: #ff8b94; animation-delay: 0.8s; }
        .confetti:nth-child(6) { left: 60%; background: #b4e7ce; animation-delay: 1s; }
        .confetti:nth-child(7) { left: 70%; background: #ffd3b6; animation-delay: 1.2s; }
        .confetti:nth-child(8) { left: 80%; background: #dcedc1; animation-delay: 1.4s; }
        .confetti:nth-child(9) { left: 90%; background: #a8dadc; animation-delay: 1.6s; }
        .confetti:nth-child(10) { left: 95%; background: #e4c1f9; animation-delay: 1.8s; }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Amount Reminder */
        .amount-reminder {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border: 2px solid #fb923c;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
            color: var(--gray-800);
            animation: fadeIn 0.3s ease;
        }

        .amount-reminder strong {
            color: #ea580c;
            font-size: 18px;
        }

        /* Encouragement Messages */
        .encouragement-message {
            background: rgba(37, 99, 235, 0.05);
            border-left: 3px solid #2563eb;
            border-radius: 8px;
            padding: 14px 18px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            animation: slideInFromRight 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .encouragement-message svg {
            width: 22px;
            height: 22px;
            color: #2563eb;
            flex-shrink: 0;
        }

        @keyframes slideInFromRight {
            0% {
                transform: translateX(20px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .encouragement-message.hide {
            display: none;
        }

        /* Error State */
        .error-message {
            color: var(--error);
            font-size: 13px;
            margin-top: 4px;
        }

        input.error, select.error {
            border-color: var(--error);
        }

        /* VAT Display */
        .vat-display {
            background: var(--light-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 10px;
            padding: 16px;
            margin-top: 12px;
            display: none;
        }

        .vat-display.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .vat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .vat-row:last-child {
            margin-bottom: 0;
            font-weight: 600;
            font-size: 16px;
            padding-top: 8px;
            border-top: 1px solid var(--primary-blue);
        }

        .vat-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        .vat-value {
            color: var(--gray-800);
            font-weight: 500;
        }

        /* File Upload */
        .file-upload-container {
            border: 2px dashed var(--gray-300);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-container:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .file-upload-container.has-file {
            border-color: var(--success);
            background: #f0fdf4;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            opacity: 0.6;
        }

        .upload-text {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .upload-subtext {
            color: var(--gray-400);
            font-size: 12px;
        }

        .file-preview {
            margin-top: 12px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .file-name {
            color: var(--success);
            font-weight: 500;
            font-size: 14px;
        }

        /* Split Payment Rows */
        .split-payment-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 12px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 10px;
            border: 1px solid var(--gray-200);
        }

        @media (max-width: 500px) {
            .split-payment-row {
                grid-template-columns: 1fr;
            }
        }

        .split-payment-row .form-group {
            margin-bottom: 0;
        }

        .split-payment-remove {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--error);
            background: var(--white);
            color: var(--error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
        }

        .split-payment-remove:hover {
            background: var(--error);
            color: var(--white);
        }

        .split-payment-remove svg {
            width: 20px;
            height: 20px;
        }

        /* Split Payment Method Details */
        .split-method-details {
            grid-column: 1 / -1; /* Takes full width */
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-300);
        }

        .split-cc-details,
        .split-checks-details {
            background: var(--white);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .conditional-subfield {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--gray-300);
        }

        .split-row-header {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        @media (max-width: 500px) {
            .split-row-header {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .billing-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .billing-modal-overlay.show {
            display: flex;
        }
        .billing-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .billing-modal-header {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .billing-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }
        .billing-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .billing-modal-close:hover { opacity: 1; }
        .billing-modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .billing-modal-body .form-group {
            margin-bottom: 16px;
        }
        .billing-modal-body label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: #374151;
        }
        .billing-modal-body input,
        .billing-modal-body select,
        .billing-modal-body textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .billing-modal-body input:focus,
        .billing-modal-body select:focus,
        .billing-modal-body textarea:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245,158,11,0.1);
        }
        .billing-modal-body .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .billing-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .billing-modal-footer button {
            padding: 10px 24px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        .billing-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }
        .billing-btn-cancel:hover { background: #e5e7eb; }
        .billing-btn-submit {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .billing-btn-submit:hover { background: linear-gradient(135deg, #059669, #047857); }
        .billing-btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .billing-search-container {
            position: relative;
        }
        .billing-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .billing-autocomplete.show { display: block; }
        .billing-autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }
        .billing-autocomplete-item:hover { background: #fef3c7; }
        .billing-autocomplete-item:last-child { border-bottom: none; }
        .billing-autocomplete-name { font-weight: 600; font-size: 14px; }
        .billing-autocomplete-details { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .billing-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            background: #fef3c7;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 16px 0 12px;
        }
        .billing-success-msg {
            text-align: center;
            padding: 24px;
        }
        .billing-success-msg .check-icon {
            width: 50px; height: 50px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            color: white;
            font-size: 24px;
        }

        /* ========== Billing Management View ========== */
        #billingManagement {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px 0;
        }
        #billingManagement.active { display: block; }

        .bm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .bm-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0;
        }
        .bm-back-btn {
            background: none;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .bm-back-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }
        .bm-sync-btn {
            background: none;
            border: 1px solid var(--primary-blue);
            color: var(--primary-blue);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .bm-sync-btn:hover {
            background: var(--primary-blue);
            color: white;
        }
        .bm-sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bm-sync-btn.syncing svg {
            animation: spin 1s linear infinite;
        }

        /* Summary Cards */
        .bm-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        @media (max-width: 768px) {
            .bm-summary { grid-template-columns: repeat(2, 1fr); }
        }
        .bm-stat {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .bm-stat-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--gray-800);
            line-height: 1.2;
        }
        .bm-stat-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }
        .bm-stat.blue .bm-stat-value { color: var(--primary-blue); }
        .bm-stat.green .bm-stat-value { color: var(--success); }
        .bm-stat.red .bm-stat-value { color: var(--error); }

        /* Toolbar: Filter + View Toggle + Search */
        .bm-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .bm-search {
            flex: 1;
            min-width: 180px;
            max-width: 280px;
            padding: 8px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            background: var(--white);
            transition: border-color 0.2s;
        }
        .bm-search:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .bm-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .bm-filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: var(--white);
            font-family: 'Heebo', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
        }
        .bm-filter-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        .bm-filter-btn.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }
        .bm-view-toggle {
            display: flex;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            overflow: hidden;
        }
        .bm-view-btn {
            padding: 6px 12px;
            border: none;
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
            transition: all 0.2s;
        }
        .bm-view-btn:not(:last-child) { border-left: 1px solid var(--gray-300); }
        .bm-view-btn.active {
            background: var(--primary-blue);
            color: var(--white);
        }

        /* Table View */
        .bm-table-wrap {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: var(--white);
        }
        .bm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: auto;
        }
        .bm-table th {
            background: var(--gray-50);
            padding: 10px 10px;
            text-align: right;
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
            font-size: 11px;
        }
        .bm-table td {
            padding: 10px 10px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            vertical-align: middle;
            font-size: 12px;
        }
        .bm-table tr:last-child td { border-bottom: none; }
        .bm-table tr:hover td { background: var(--gray-50); }
        @media (min-width: 1024px) {
            .bm-table-wrap { overflow-x: visible; }
        }

        .bm-amount {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        .bm-progress-bar {
            width: 60px;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-inline-start: 8px;
        }
        .bm-progress-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--primary-blue);
            transition: width 0.3s;
        }
        .bm-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.6;
        }
        .bm-badge.active { background: #dbeafe; color: #1d4ed8; }
        .bm-badge.completed { background: #d1fae5; color: #065f46; }
        .bm-badge.paused { background: #fef3c7; color: #92400e; }
        .bm-badge.cancelled { background: var(--gray-100); color: var(--gray-500); }

        /* Cards View */
        .bm-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 14px;
        }
        .bm-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 18px;
            transition: box-shadow 0.2s;
        }
        .bm-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .bm-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }
        .bm-card-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0 0 2px;
        }
        .bm-card-case {
            font-size: 12px;
            color: var(--gray-400);
        }
        .bm-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .bm-card-field {
            font-size: 12px;
        }
        .bm-card-field-label {
            color: var(--gray-400);
            margin-bottom: 2px;
        }
        .bm-card-field-value {
            font-weight: 600;
            color: var(--gray-700);
        }
        .bm-card-progress {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 10px 12px;
        }
        .bm-card-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--gray-500);
            margin-bottom: 6px;
        }
        .bm-card-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }
        .bm-card-progress-fill {
            height: 100%;
            border-radius: 3px;
            background: var(--primary-blue);
            transition: width 0.3s;
        }
        .bm-card-progress-fill.high { background: var(--success); }

        /* Empty State */
        .bm-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--gray-400);
        }
        .bm-empty svg {
            margin-bottom: 12px;
            opacity: 0.4;
        }
        .bm-empty p {
            font-size: 14px;
        }

        /* Loading */
        .bm-loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-400);
            font-size: 14px;
        }
        .bm-loading-spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        .bm-footer {
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--gray-200);
            text-align: center;
        }
        .bm-footer p {
            font-size: 12px;
            color: var(--gray-400);
            margin: 0;
            letter-spacing: 0.3px;
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: center;
            gap: 0;
            padding: 0;
            z-index: 100;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
        }
        .bottom-nav-item {
            flex: 1;
            max-width: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 8px 12px;
            border: none;
            background: none;
            color: var(--gray-400);
            font-family: 'Heebo', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .bottom-nav-item:hover {
            color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.04);
        }
        .bottom-nav-item.active {
            color: var(--primary-blue);
        }
        .bottom-nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--primary-blue);
            border-radius: 0 0 3px 3px;
        }
        .bottom-nav-item svg {
            width: 22px;
            height: 22px;
        }
        .bottom-nav-label {
            white-space: nowrap;
        }
        .bottom-nav-hidden {
            display: none;
        }
        @media (min-width: 768px) {
            .bottom-nav {
                gap: 8px;
            }
            .bottom-nav-item {
                font-size: 12px;
                padding: 12px 12px 14px;
            }
        }

        /* Login Screen */
        #loginScreen {
            max-width: 380px;
            margin: 80px auto;
            padding: 0 20px;
            text-align: center;
        }
        .login-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 32px 28px;
        }
        .login-card h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        .login-card p {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 24px;
        }
        .login-card .form-group {
            text-align: right;
            margin-bottom: 14px;
        }
        .login-card label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 4px;
        }
        .login-card input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .login-card input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .login-btn:hover { background: var(--primary-blue-hover); }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .login-error {
            color: var(--error);
            font-size: 13px;
            margin-top: 10px;
            min-height: 20px;
        }

        /* Edit Modal */
        .edit-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .edit-modal-overlay.show { display: flex; }
        .edit-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .edit-modal-header {
            background: var(--primary-blue);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .edit-modal-header h3 { margin: 0; font-size: 18px; }
        .edit-modal-close {
            background: none; border: none; color: white;
            font-size: 24px; cursor: pointer; padding: 0; line-height: 1; opacity: 0.8;
        }
        .edit-modal-close:hover { opacity: 1; }
        .edit-modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .edit-modal-body .form-group { margin-bottom: 16px; }
        .edit-modal-body label {
            display: block; margin-bottom: 6px;
            font-weight: 500; font-size: 14px; color: #374151;
        }
        .edit-modal-body input,
        .edit-modal-body select,
        .edit-modal-body textarea {
            width: 100%; padding: 10px 14px;
            border: 1px solid #d1d5db; border-radius: 8px;
            font-family: 'Heebo', sans-serif; font-size: 14px;
            box-sizing: border-box; transition: border-color 0.2s;
        }
        .edit-modal-body input:focus,
        .edit-modal-body select:focus,
        .edit-modal-body textarea:focus {
            outline: none; border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .edit-modal-body .form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .edit-modal-footer {
            padding: 16px 24px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 12px; justify-content: flex-end;
        }
        .edit-modal-footer button {
            padding: 10px 24px; border-radius: 8px;
            font-family: 'Heebo', sans-serif; font-size: 14px;
            font-weight: 600; cursor: pointer; border: none; transition: background 0.2s;
        }
        .edit-btn-cancel { background: #f3f4f6; color: #374151; }
        .edit-btn-cancel:hover { background: #e5e7eb; }
        .edit-btn-save { background: var(--primary-blue); color: white; }
        .edit-btn-save:hover { background: var(--primary-blue-hover); }
        .edit-btn-save:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Password Popup */
        .pw-popup-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.55);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .pw-popup-overlay.show { display: flex; }
        .pw-popup {
            background: var(--white);
            border-radius: 16px;
            width: 90%;
            max-width: 380px;
            padding: 32px 28px 24px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .pw-popup-icon {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 16px;
        }
        .pw-popup h3 {
            font-size: 18px; font-weight: 700;
            color: var(--gray-800); margin: 0 0 6px;
        }
        .pw-popup .pw-desc {
            font-size: 13px; color: var(--gray-500);
            margin-bottom: 18px; line-height: 1.6;
        }
        .pw-popup .pw-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            color: #991b1b;
            margin-bottom: 18px;
            text-align: right;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .pw-popup input[type="password"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 15px;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 14px;
            transition: border-color 0.2s;
        }
        .pw-popup input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .pw-popup-buttons {
            display: flex; gap: 10px;
        }
        .pw-popup-buttons button {
            flex: 1; padding: 10px;
            border-radius: 8px; font-family: 'Heebo', sans-serif;
            font-size: 14px; font-weight: 600;
            cursor: pointer; border: none; transition: background 0.2s;
        }
        .pw-popup-cancel {
            background: var(--gray-100); color: var(--gray-600);
        }
        .pw-popup-cancel:hover { background: var(--gray-200); }
        .pw-popup-confirm {
            background: var(--primary-blue); color: white;
        }
        .pw-popup-confirm:hover { background: var(--primary-blue-hover); }
        .pw-popup-error {
            color: var(--error); font-size: 12px;
            margin-top: 8px; min-height: 16px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <img src="‏‏logo - עותק.png" alt="לוגו" style="max-width: 140px; height: auto; margin-bottom: 16px;">
            <h2>כניסה למערכת</h2>
            <p>משרד עו"ד גיא הרשקוביץ ושות'</p>
            <div class="form-group">
                <label>מייל</label>
                <input type="email" id="loginEmail" placeholder="email@example.com" dir="ltr" style="text-align: left;">
            </div>
            <div class="form-group">
                <label>סיסמה</label>
                <input type="password" id="loginPassword" placeholder="הזן סיסמה">
            </div>
            <button class="login-btn" id="loginBtn" onclick="handleLogin()">כניסה</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <div id="mainContainer" class="container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <img src="‏‏logo - עותק.png" alt="לוגו משרד עו"ד גיא הרשקוביץ" style="max-width: 200px; max-height: 80px; width: auto; height: auto; margin-bottom: 10px; object-fit: contain;">
            <h1>טופס מכר</h1>
            <p>משרד עו"ד גיא הרשקוביץ ושות'</p>
        </div>

        <!-- User Selection Screen -->
        <div id="userSelection" class="user-selection">
            <h2>שלום! מי מזין את הטופס?</h2>
            <p>בחר/י את שמך להמשך</p>
            <div class="user-grid">
                <button class="user-btn" onclick="selectUser('גיא הרשקוביץ')">
                    <div class="user-avatar">ג</div>
                    <div class="user-name">גיא</div>
                </button>
                <button class="user-btn" onclick="selectUser('מירי טל')">
                    <div class="user-avatar">מ</div>
                    <div class="user-name">מירי</div>
                </button>
                <button class="user-btn" onclick="selectUser('רועי הרשקוביץ')">
                    <div class="user-avatar">ר</div>
                    <div class="user-name">רועי</div>
                </button>
                <button class="user-btn" onclick="selectUser('אורי שטיינברג')">
                    <div class="user-avatar">א</div>
                    <div class="user-name">אורי</div>
                </button>
                <button class="user-btn" onclick="selectUser('חיים')">
                    <div class="user-avatar">ח</div>
                    <div class="user-name">חיים</div>
                </button>
            </div>
        </div>

        <!-- Main Form -->
        <div id="mainForm" class="hidden">
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-steps">
                    <div class="progress-line" id="progressLine"></div>
                    <div class="step-indicator active" data-step="1">1</div>
                    <div class="step-indicator" data-step="2">2</div>
                    <div class="step-indicator" data-step="3">3</div>
                    <div class="step-indicator" data-step="4">4</div>
                </div>
                <div class="step-labels">
                    <span class="step-label active">פרטי לקוח</span>
                    <span class="step-label">העסקה</span>
                    <span class="step-label">תשלום</span>
                    <span class="step-label">סיכום</span>
                </div>
            </div>

            <form id="salesForm">
                <!-- Step 1: Client Details -->
                <div class="form-card form-step active" data-step="1">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </span>
                        פרטי הלקוח
                    </h3>

                    <div class="form-group">
                        <label>שם הלקוח <span class="required">*</span></label>
                        <input type="text" id="clientName" placeholder="שם מלא / שם החברה" required autocomplete="off">
                        <div id="clientAutocomplete" class="autocomplete-dropdown"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>טלפון <span class="required">*</span></label>
                            <input type="text" id="phone" placeholder="050-0000000 או +972-50-0000000" required style="direction: ltr; text-align: right;">
                        </div>
                        <div class="form-group">
                            <label>ת.ז / ח.פ <span class="required">*</span></label>
                            <input type="text" id="idNumber" placeholder="מספר זהות או ח.פ" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>מייל <span class="required">*</span></label>
                        <input type="email" id="email" placeholder="email@example.com" required>
                    </div>

                    <div class="form-group">
                        <label>כתובת</label>
                        <input type="text" id="address" placeholder="רחוב, עיר (אופציונלי)">
                    </div>

                    <div class="form-group">
                        <label>סטטוס לקוח</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="newClient" name="clientStatus" value="חדש" checked>
                                <label for="newClient">לקוח חדש</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="existingClient" name="clientStatus" value="קיים">
                                <label for="existingClient">לקוח קיים</label>
                            </div>
                        </div>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            המשך
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Transaction Details -->
                <div class="form-card form-step" data-step="2">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                        </span>
                        פרטי העסקה
                    </h3>

                    <div class="form-group">
                        <label>סוג העסקה <span class="required">*</span></label>
                        <select id="transactionType" required>
                            <option value="">בחר סוג עסקה</option>
                            <option value="פגישת ייעוץ">פגישת ייעוץ</option>
                            <option value="ריטיינר">ריטיינר</option>
                            <option value="תוכנית שעות">תוכנית שעות</option>
                            <option value="הליך משפטי - תקרת שעות">הליך משפטי - תקרת שעות</option>
                            <option value="הליך משפטי - פיקס">הליך משפטי - פיקס</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>

                    <!-- Conditional: Hours Package Fields -->
                    <div id="hoursPackageFields" class="conditional-field">
                        <div class="form-row">
                            <div class="form-group">
                                <label>כמות שעות <span class="required">*</span></label>
                                <input type="number" id="hoursQuantity" placeholder="מספר שעות" min="1" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>מחיר לשעה (לפני מע"מ) <span class="required">*</span></label>
                                <input type="number" id="hourlyRate" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="transactionDescriptionGroup">
                        <label>תיאור העסקה <span class="required">*</span></label>
                        <textarea id="transactionDescription" placeholder="תאר את העסקה בקצרה..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>סכום (לפני מע"מ) <span class="required">*</span></label>
                        <input type="number" id="amount" placeholder="0" min="0" step="any">
                    </div>

                    <!-- VAT Calculation Display -->
                    <div id="vatDisplay" class="vat-display">
                        <div class="vat-row">
                            <span class="vat-label">סכום לפני מע"מ:</span>
                            <span class="vat-value" id="amountBeforeVat">₪0</span>
                        </div>
                        <div class="vat-row">
                            <span class="vat-label">מע"מ (18%):</span>
                            <span class="vat-value" id="vatAmount">₪0</span>
                        </div>
                        <div class="vat-row">
                            <span class="vat-label">סכום כולל מע"מ:</span>
                            <span class="vat-value" id="amountWithVat">₪0</span>
                        </div>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                            חזור
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            המשך
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Payment -->
                <div class="form-card form-step" data-step="3">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                        </span>
                        פרטי תשלום
                    </h3>

                    <div class="form-group">
                        <label>אמצעי תשלום <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="creditCard" name="paymentMethod" value="כרטיס אשראי" required>
                                <label for="creditCard">אשראי</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bankTransfer" name="paymentMethod" value="העברה בנקאית">
                                <label for="bankTransfer">העברה</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="cash" name="paymentMethod" value="מזומן">
                                <label for="cash">מזומן</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bit" name="paymentMethod" value="ביט">
                                <label for="bit">ביט</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="checks" name="paymentMethod" value="שיקים דחויים">
                                <label for="checks">שיקים</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="splitPayment" name="paymentMethod" value="פיצול תשלום">
                                <label for="splitPayment">פיצול תשלום</label>
                            </div>
                        </div>
                    </div>

                    <!-- Encouragement Message (appears after payment method selection) -->
                    <div id="encouragementMessage" class="encouragement-message hide"></div>

                    <!-- Split Payment Details (conditional) -->
                    <div id="splitPaymentDetails" class="conditional-field">
                        <!-- Amount Reminder -->
                        <div class="amount-reminder">
                            💰 סכום העסקה: <strong id="splitAmountReminder">₪0</strong> (כולל מע"מ)
                        </div>

                        <div style="background: var(--light-blue); border: 2px solid var(--primary-blue); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--gray-800);">פרט את אמצעי התשלום:</div>
                            <div style="font-size: 13px; color: var(--gray-600);">הוסף כל אמצעי תשלום והסכום שלו</div>
                        </div>

                        <div id="splitPaymentRows">
                            <!-- Split payment rows will be added here dynamically -->
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="addSplitPaymentRow()" style="margin-bottom: 16px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            הוסף אמצעי תשלום
                        </button>

                        <div id="splitPaymentSummary" class="vat-display" style="display: none;">
                            <div class="vat-row">
                                <span class="vat-label">סכום כולל שהוזן:</span>
                                <span class="vat-value" id="splitTotalEntered">₪0</span>
                            </div>
                            <div class="vat-row">
                                <span class="vat-label">סכום נותר:</span>
                                <span class="vat-value" id="splitRemaining" style="color: var(--error); font-weight: 700;">₪0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Card Confirmation (conditional) -->
                    <div id="creditCardConfirmation" class="conditional-field">
                        <!-- Amount Reminder -->
                        <div class="amount-reminder">
                            💰 סכום העסקה: <strong id="ccAmountReminder">₪0</strong> (כולל מע"מ)
                        </div>

                        <div class="form-group">
                            <label>סטטוס החיוב באשראי <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="ccCharged" name="creditCardStatus" value="בוצע חיוב מלא">
                                    <label for="ccCharged">בוצע חיוב מלא</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ccMonthly" name="creditCardStatus" value="חיוב חודשי">
                                    <label for="ccMonthly">חיוב חודשי</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ccDeposit" name="creditCardStatus" value="פיקדון">
                                    <label for="ccDeposit">פיקדון</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ccTemporary" name="creditCardStatus" value="אשראי זמני - יוחלף">
                                    <label for="ccTemporary">אשראי זמני - יוחלף</label>
                                </div>
                            </div>
                        </div>

                        <!-- Full Charge Details (conditional) -->
                        <div id="fullChargeDetails" class="conditional-field">
                            <div class="form-group">
                                <label>מספר תשלומים <span class="required">*</span></label>
                                <input type="number" id="paymentsCount" placeholder="כמה תשלומים?" min="1" max="36">
                            </div>
                        </div>

                        <!-- Monthly Charge Details (conditional) -->
                        <div id="monthlyChargeDetails" class="conditional-field">
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #92400e;">
                                    הגדרת חיוב חודשי קבוע
                                </div>
                                <div style="font-size: 13px; color: #78350f;">
                                    המערכת תשלח תזכורות אוטומטיות יום לפני כל חיוב
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>סכום חיוב חודשי (כולל מע"מ) <span class="required">*</span></label>
                                    <input type="number" id="recurringMonthlyAmount" placeholder="0" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>מספר חודשים <span class="required">*</span></label>
                                    <input type="number" id="recurringMonthsCount" placeholder="כמה חודשים?" min="1" max="60">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>תאריך חיוב ראשון <span class="required">*</span></label>
                                    <input type="date" id="recurringStartDate">
                                </div>
                                <div class="form-group">
                                    <label>יום בחודש לחיוב</label>
                                    <input type="number" id="recurringDayOfMonth" placeholder="לדוגמה: 1, 15" min="1" max="28" value="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>הערות לגבייה</label>
                                <textarea id="recurringNotes" placeholder="הערות נוספות לגבי החיוב החודשי..."></textarea>
                            </div>
                        </div>

                        <!-- Deposit Details (conditional) -->
                        <div id="depositDetails" class="conditional-field">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>סכום חודשי לחיוב <span class="required">*</span></label>
                                    <input type="number" id="monthlyCharge" placeholder="0" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>מספר חודשים</label>
                                    <input type="number" id="monthsCount" placeholder="כמה חודשים?" min="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>פרטים נוספים על הפיקדון</label>
                                <textarea id="depositDetailsText" placeholder="תאריך תחילת חיוב, הערות..."></textarea>
                            </div>
                        </div>

                        <!-- Temporary Credit Card - Replacement Details (conditional) -->
                        <div id="temporaryCreditDetails" class="conditional-field">
                            <div class="form-group">
                                <label>פרטי החלפה <span class="required">*</span></label>
                                <textarea id="temporaryCreditText" placeholder="לדוגמה: יוחלף לצ'קים ב-01/03/2025, יוחלף להעברה בנקאית..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Checks Details (conditional) -->
                    <div id="checksDetails" class="conditional-field">
                        <!-- Amount Reminder -->
                        <div class="amount-reminder">
                            💰 סכום העסקה: <strong id="checksAmountReminder">₪0</strong> (כולל מע"מ)
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>מספר שיקים <span class="required">*</span></label>
                                <input type="number" id="checksCount" placeholder="כמה שיקים?" min="1">
                            </div>
                            <div class="form-group">
                                <label>סכום כולל <span class="required">*</span></label>
                                <input type="number" id="checksTotalAmount" placeholder="0" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>צילום שיקים <span class="required">*</span></label>
                            <div class="file-upload-container" id="checksUploadContainer" onclick="document.getElementById('checksPhoto').click()">
                                <input type="file" id="checksPhoto" accept="image/*,application/pdf" style="display: none;">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                </div>
                                <div class="upload-text">לחץ לצילום או בחירת תמונה</div>
                                <div class="upload-subtext">תמונה ברורה של השיקים</div>
                            </div>
                            <div class="file-preview" id="checksPreview">
                                <div class="file-name" id="checksFileName"></div>
                                <img id="checksImage" alt="צילום שיקים">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>פירוט שיקים</label>
                            <div id="checksDetailsContainer"></div>
                        </div>

                        <div class="form-group">
                            <label>הערות נוספות על השיקים (אופציונלי)</label>
                            <textarea id="checksDetailsText" placeholder="הערות נוספות..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>האם השיק יוחלף באמצעי תשלום אחר?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="checkWillChange" name="checkWillChange" value="כן">
                                    <label for="checkWillChange">כן</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="checkWillNotChange" name="checkWillChange" value="לא" checked>
                                    <label for="checkWillNotChange">לא</label>
                                </div>
                            </div>
                        </div>

                        <!-- Check Replacement Details (conditional) -->
                        <div id="checkReplacementDetails" class="form-group conditional-field">
                            <label>פרט את אמצעי התשלום החלופי <span class="required">*</span></label>
                            <textarea id="checkReplacementText" placeholder="לדוגמה: יוחלף בכרטיס אשראי ב-15/02/2025, העברה בנקאית וכו..."></textarea>
                        </div>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                            חזור
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            המשך
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Summary & Submit -->
                <div class="form-card form-step" data-step="4">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </span>
                        פרטים נוספים וסיכום
                    </h3>

                    <div class="form-group">
                        <label>עו"ד מטפל <span class="required">*</span></label>
                        <select id="attorney" required>
                            <option value="">בחר עו"ד</option>
                            <option value="גיא הרשקוביץ">גיא הרשקוביץ</option>
                            <option value="מירי טל">מירי טל</option>
                            <option value="רועי הרשקוביץ">רועי הרשקוביץ</option>
                            <option value="אורי שטיינברג">אורי שטיינברג</option>
                            <option value="חיים">חיים</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>מספר תיק בעודכנית</label>
                            <input type="text" id="caseNumber" placeholder="אם ידוע">
                        </div>
                        <div class="form-group">
                            <label>סניף</label>
                            <select id="branch">
                                <option value="תל אביב" selected>תל אביב</option>
                                <option value="רחובות">רחובות</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>הערות</label>
                        <textarea id="notes" placeholder="הערות נוספות (אופציונלי)"></textarea>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                            חזור
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span id="submitText">שלח טופס</span>
                            <div class="spinner hidden" id="submitSpinner"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="form-card success-screen">
            <!-- Confetti Elements -->
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>

            <div class="celebration-emoji">🎉</div>

            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>

            <h2>כל הכבוד! מכירה חדשה!</h2>
            <p class="subtitle">הרשומה נשמרה בהצלחה במערכת</p>

            <div class="sale-summary">
                <div class="sale-summary-title">📊 סיכום המכירה</div>

                <div class="sale-detail">
                    <span class="sale-detail-label">לקוח:</span>
                    <span class="sale-detail-value" id="summaryClientName">-</span>
                </div>

                <div class="sale-detail">
                    <span class="sale-detail-label">סוג עסקה:</span>
                    <span class="sale-detail-value" id="summaryTransactionType">-</span>
                </div>

                <div class="sale-detail">
                    <span class="sale-detail-label">אמצעי תשלום:</span>
                    <span class="sale-detail-value" id="summaryPaymentMethod">-</span>
                </div>

                <div class="sale-amount">
                    ₪<span id="summaryAmount">0</span>
                    <div style="font-size: 14px; font-weight: 400; margin-top: 4px;">כולל מע"מ</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="resetForm()" style="max-width: 250px; margin: 0 auto; font-size: 16px;">
                🚀 מכירה נוספת
            </button>
        </div>
    </div>

    <!-- Billing Management View -->
    <div id="billingManagement">
        <div class="bm-header">
            <h2>ניהול גבייה חודשית</h2>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="bm-sync-btn" id="bmSyncBtn" onclick="syncBillingToSheets()" title="סנכרון לקוחות קיימים לגיליון Google Sheets">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                    סנכרון לגיליון
                </button>
                <button class="bm-back-btn" onclick="hideBillingManagement()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    חזרה
                </button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="bm-summary">
            <div class="bm-stat blue">
                <div class="bm-stat-value" id="bmStatTotal">0</div>
                <div class="bm-stat-label">לקוחות פעילים</div>
            </div>
            <div class="bm-stat">
                <div class="bm-stat-value" id="bmStatMonthly">₪0</div>
                <div class="bm-stat-label">גבייה חודשית</div>
            </div>
            <div class="bm-stat green">
                <div class="bm-stat-value" id="bmStatPaid">₪0</div>
                <div class="bm-stat-label">שולם עד כה</div>
            </div>
            <div class="bm-stat red">
                <div class="bm-stat-value" id="bmStatRemaining">₪0</div>
                <div class="bm-stat-label">יתרה לגבייה</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bm-toolbar">
            <input type="text" class="bm-search" id="bmSearch" placeholder="חיפוש לקוח..." oninput="filterBillingView()">
            <div class="bm-filters">
                <button class="bm-filter-btn active" data-filter="all" onclick="setBillingFilter('all', this)">הכל</button>
                <button class="bm-filter-btn" data-filter="פעיל" onclick="setBillingFilter('פעיל', this)">פעילים</button>
                <button class="bm-filter-btn" data-filter="מושהה" onclick="setBillingFilter('מושהה', this)">מושהים</button>
                <button class="bm-filter-btn" data-filter="בוטל" onclick="setBillingFilter('בוטל', this)">בוטלו</button>
            </div>
            <div class="bm-view-toggle">
                <button class="bm-view-btn active" id="bmViewTable" onclick="setBillingViewMode('table')" title="תצוגת טבלה">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/></svg>
                </button>
                <button class="bm-view-btn" id="bmViewCards" onclick="setBillingViewMode('cards')" title="תצוגת כרטיסיות">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                </button>
            </div>
        </div>

        <!-- Table View -->
        <div id="bmTableView">
            <div class="bm-table-wrap">
                <table class="bm-table">
                    <thead>
                        <tr>
                            <th>לקוח</th>
                            <th>עו"ד מטפל</th>
                            <th>סכום חודשי</th>
                            <th>סה"כ עסקה</th>
                            <th>שולם</th>
                            <th>התקדמות</th>
                            <th>סטטוס</th>
                            <th>כרטיס</th>
                            <th>תזכורת הבאה</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="bmTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cards View -->
        <div id="bmCardsView" style="display: none;">
            <div class="bm-cards" id="bmCardsContainer">
            </div>
        </div>

        <!-- Loading -->
        <div id="bmLoading" class="bm-loading" style="display: none;">
            <div class="bm-loading-spinner"></div>
            טוען נתוני גבייה...
        </div>

        <!-- Empty State -->
        <div id="bmEmpty" class="bm-empty" style="display: none;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            <p>אין לקוחות בגבייה חודשית</p>
        </div>

        <!-- Footer -->
        <div class="bm-footer">
            <p>נבנה על ידי חיים פרץ | כל הזכויות שמורות למשרד עו"ד גיא הרשקוביץ &copy; 2026</p>
        </div>
    </div>

    <!-- Billing Modal -->
    <div id="billingModalOverlay" class="billing-modal-overlay" onclick="if(event.target===this) closeBillingModal()">
        <div class="billing-modal">
            <div class="billing-modal-header">
                <h3>הוספת לקוח לגבייה חודשית</h3>
                <button class="billing-modal-close" onclick="closeBillingModal()">&times;</button>
            </div>
            <div class="billing-modal-body" id="billingModalBody">
                <div class="billing-section-title">פרטי לקוח</div>

                <div class="form-group billing-search-container">
                    <label>חיפוש לקוח קיים</label>
                    <input type="text" id="billingClientSearch" placeholder="הקלד שם לקוח לחיפוש..." autocomplete="off">
                    <div id="billingAutocomplete" class="billing-autocomplete"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם הלקוח <span class="required">*</span></label>
                        <input type="text" id="billingClientName" placeholder="שם מלא / שם חברה" required>
                    </div>
                    <div class="form-group">
                        <label>טלפון</label>
                        <input type="tel" id="billingPhone" placeholder="050-0000000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>מייל</label>
                        <input type="email" id="billingEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>ח.פ / ת.ז</label>
                        <input type="text" id="billingIdNumber" placeholder="מספר זיהוי">
                    </div>
                </div>

                <div class="form-group">
                    <label>כתובת</label>
                    <input type="text" id="billingAddress" placeholder="כתובת הלקוח">
                </div>

                <div class="billing-section-title">פרטי גבייה חודשית</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>סכום חודשי (כולל מע"מ) <span class="required">*</span></label>
                        <input type="number" id="billingAmount" placeholder="0" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>מספר חודשים <span class="required">*</span></label>
                        <input type="number" id="billingMonths" placeholder="כמה חודשים?" min="1" max="60" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>תאריך חיוב ראשון <span class="required">*</span></label>
                        <input type="date" id="billingStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>יום בחודש לחיוב</label>
                        <input type="number" id="billingDayOfMonth" placeholder="1" min="1" max="28" value="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>חודשים ששולמו כבר</label>
                    <input type="number" id="billingPaidMonths" placeholder="0 (אם הלקוח חדש)" min="0" max="60" value="0">
                    <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">למקרה שהלקוח כבר שילם חלק מהתשלומים לפני ההכנסה למערכת</div>
                </div>

                <div class="billing-section-title">פרטי כרטיס אשראי</div>
                <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    המידע מוצפן ונשמר בצורה מאובטחת. לצפייה במספר המלא נדרשת סיסמת המשרד.
                </div>

                <div class="form-group">
                    <label>מספר כרטיס אשראי</label>
                    <input type="text" id="billingCardNumber" placeholder="0000 0000 0000 0000" maxlength="19" dir="ltr" style="text-align: left; letter-spacing: 2px; font-variant-numeric: tabular-nums;" autocomplete="off">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>תוקף</label>
                        <input type="text" id="billingCardExpiry" placeholder="MM/YY" maxlength="5" dir="ltr" style="text-align: left;" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>CVV (3 ספרות)</label>
                        <input type="password" id="billingCardCvv" placeholder="•••" maxlength="4" dir="ltr" style="text-align: center; letter-spacing: 4px;" autocomplete="off">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם בעל הכרטיס</label>
                        <input type="text" id="billingCardHolder" placeholder="שם כפי שמופיע על הכרטיס">
                    </div>
                    <div class="form-group">
                        <label>סוג כרטיס</label>
                        <select id="billingCardType">
                        <option value="">בחר סוג</option>
                        <option value="ויזה">ויזה (Visa)</option>
                        <option value="מאסטרקארד">מאסטרקארד (Mastercard)</option>
                        <option value="אמריקן אקספרס">אמריקן אקספרס (Amex)</option>
                        <option value="ישראכרט">ישראכרט</option>
                        <option value="דיינרס">דיינרס</option>
                        <option value="אחר">אחר</option>
                    </select>
                    </div>
                </div>

                <div class="billing-section-title">פרטים נוספים</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>עו"ד מטפל <span class="required">*</span></label>
                        <select id="billingAttorney" required>
                            <option value="">בחר עו"ד</option>
                            <option value="גיא הרשקוביץ">גיא הרשקוביץ</option>
                            <option value="מירי טל">מירי טל</option>
                            <option value="רועי הרשקוביץ">רועי הרשקוביץ</option>
                            <option value="אורי שטיינברג">אורי שטיינברג</option>
                            <option value="חיים">חיים</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>מספר תיק</label>
                        <input type="text" id="billingCaseNumber" placeholder="מספר תיק בעודכנית">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>סניף</label>
                        <select id="billingBranch">
                            <option value="תל אביב">תל אביב</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>סוג העסקה</label>
                        <select id="billingTransactionType">
                            <option value="ריטיינר">ריטיינר</option>
                            <option value="תוכנית שעות">תוכנית שעות</option>
                            <option value="הליך משפטי - פיקס">הליך משפטי - פיקס</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>הערות</label>
                    <textarea id="billingNotes" placeholder="הערות נוספות..." rows="2"></textarea>
                </div>
            </div>

            <div class="billing-modal-footer" id="billingModalFooter">
                <button class="billing-btn-cancel" onclick="closeBillingModal()">ביטול</button>
                <button class="billing-btn-submit" id="billingSubmitBtn" onclick="submitBillingForm()">
                    <span id="billingSubmitText">שמור וצור תזכורות</span>
                    <div class="spinner hidden" id="billingSpinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Billing Client Modal -->
    <div id="editModalOverlay" class="edit-modal-overlay" onclick="if(event.target===this) closeEditModal()">
        <div class="edit-modal">
            <div class="edit-modal-header">
                <h3>עריכת לקוח גבייה</h3>
                <button class="edit-modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <input type="hidden" id="editDocId">

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטי לקוח</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם הלקוח <span class="required">*</span></label>
                        <input type="text" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label>טלפון</label>
                        <input type="tel" id="editPhone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>מייל</label>
                        <input type="email" id="editEmail">
                    </div>
                    <div class="form-group">
                        <label>ח.פ / ת.ז</label>
                        <input type="text" id="editIdNumber">
                    </div>
                </div>
                <div class="form-group">
                    <label>כתובת</label>
                    <input type="text" id="editAddress">
                </div>

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטי גבייה</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>סכום חודשי (כולל מע"מ) <span class="required">*</span></label>
                        <input type="number" id="editAmount" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>מספר חודשים <span class="required">*</span></label>
                        <input type="number" id="editMonths" min="1" max="60" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>תאריך חיוב ראשון</label>
                        <input type="date" id="editStartDate">
                    </div>
                    <div class="form-group">
                        <label>יום בחודש לחיוב</label>
                        <input type="number" id="editDayOfMonth" min="1" max="28">
                    </div>
                </div>
                <div class="form-group">
                    <label>חודשים ששולמו כבר</label>
                    <input type="number" id="editPaidMonths" min="0" max="60">
                </div>
                <div class="form-group">
                    <label>סטטוס</label>
                    <select id="editStatus">
                        <option value="פעיל">פעיל</option>
                        <option value="מושהה">מושהה</option>
                        <option value="בוטל">בוטל</option>
                    </select>
                </div>

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטי כרטיס אשראי</div>
                <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <span id="editCardStatus">לא הוזן כרטיס</span>
                </div>
                <div class="form-group">
                    <label>מספר כרטיס חדש (השאר ריק לשמור הקיים)</label>
                    <input type="text" id="editCardNumber" placeholder="0000 0000 0000 0000" maxlength="19" dir="ltr" style="text-align:left;letter-spacing:2px;font-variant-numeric:tabular-nums;" autocomplete="off">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>תוקף</label>
                        <input type="text" id="editCardExpiry" placeholder="MM/YY" maxlength="5" dir="ltr" style="text-align:left;" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>CVV (3 ספרות)</label>
                        <input type="password" id="editCardCvv" placeholder="•••" maxlength="4" dir="ltr" style="text-align:center;letter-spacing:4px;" autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label>שם בעל הכרטיס</label>
                    <input type="text" id="editCardHolder">
                </div>
                <div class="form-group">
                    <label>סוג כרטיס</label>
                    <select id="editCardType">
                        <option value="">בחר סוג</option>
                        <option value="ויזה">ויזה (Visa)</option>
                        <option value="מאסטרקארד">מאסטרקארד (Mastercard)</option>
                        <option value="אמריקן אקספרס">אמריקן אקספרס (Amex)</option>
                        <option value="ישראכרט">ישראכרט</option>
                        <option value="דיינרס">דיינרס</option>
                        <option value="אחר">אחר</option>
                    </select>
                </div>

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטים נוספים</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>עו"ד מטפל</label>
                        <select id="editAttorney">
                            <option value="">בחר עו"ד</option>
                            <option value="גיא הרשקוביץ">גיא הרשקוביץ</option>
                            <option value="מירי טל">מירי טל</option>
                            <option value="רועי הרשקוביץ">רועי הרשקוביץ</option>
                            <option value="אורי שטיינברג">אורי שטיינברג</option>
                            <option value="חיים">חיים</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>מספר תיק</label>
                        <input type="text" id="editCaseNumber">
                    </div>
                </div>
                <div class="form-group">
                    <label>הערות</label>
                    <textarea id="editNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-btn-cancel" onclick="closeEditModal()">ביטול</button>
                <button class="edit-btn-save" id="editSaveBtn" onclick="saveEditBilling()">שמור שינויים</button>
            </div>
        </div>
    </div>

    <!-- Password Popup -->
    <div id="pwPopupOverlay" class="pw-popup-overlay">
        <div class="pw-popup">
            <div class="pw-popup-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
            </div>
            <h3 id="pwPopupTitle">סיסמת הצפנה</h3>
            <div class="pw-desc" id="pwPopupDesc">
                סיסמה זו משמשת להצפנת פרטי כרטיס האשראי של הלקוח.<br>
                רק מי שיודע את הסיסמה יוכל לצפות במספר הכרטיס המלא.
            </div>
            <div class="pw-warning">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;margin-top:1px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <span>שמור את הסיסמה במקום בטוח. <strong>אם הסיסמה תישכח - לא ניתן לשחזר את פרטי הכרטיסים.</strong> אל תשתף אותה בהודעות או במייל.</span>
            </div>
            <input type="password" id="pwPopupInput" placeholder="הזן סיסמה">
            <div class="pw-popup-buttons">
                <button class="pw-popup-cancel" id="pwPopupCancel">ביטול</button>
                <button class="pw-popup-confirm" id="pwPopupConfirm">אישור</button>
            </div>
            <div class="pw-popup-error" id="pwPopupError"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Using environment variables
        const firebaseConfig = {
            apiKey: window.ENV_CONFIG.FIREBASE_API_KEY,
            authDomain: window.ENV_CONFIG.FIREBASE_AUTH_DOMAIN,
            databaseURL: window.ENV_CONFIG.FIREBASE_DATABASE_URL,
            projectId: window.ENV_CONFIG.FIREBASE_PROJECT_ID,
            storageBucket: window.ENV_CONFIG.FIREBASE_STORAGE_BUCKET,
            messagingSenderId: window.ENV_CONFIG.FIREBASE_MESSAGING_SENDER_ID,
            appId: window.ENV_CONFIG.FIREBASE_APP_ID,
            measurementId: window.ENV_CONFIG.FIREBASE_MEASUREMENT_ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ========== Firebase Authentication ==========

        let authUser = null;

        auth.onAuthStateChanged(function(user) {
            if (user) {
                authUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = '';
            } else {
                authUser = null;
                document.getElementById('loginScreen').style.display = '';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('billingManagement').classList.remove('active');
            }
        });

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');

            errorEl.textContent = '';
            if (!email || !password) {
                errorEl.textContent = 'נא למלא מייל וסיסמה';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'מתחבר...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                const messages = {
                    'auth/user-not-found': 'המייל לא נמצא במערכת',
                    'auth/wrong-password': 'סיסמה שגויה',
                    'auth/invalid-email': 'כתובת מייל לא תקינה',
                    'auth/too-many-requests': 'יותר מדי ניסיונות, נסה שוב מאוחר יותר',
                    'auth/invalid-credential': 'מייל או סיסמה שגויים'
                };
                errorEl.textContent = messages[error.code] || 'שגיאת התחברות: ' + error.message;
            }

            btn.disabled = false;
            btn.textContent = 'כניסה';
        }

        // Enter key on login
        document.getElementById('loginPassword').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('loginEmail').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') document.getElementById('loginPassword').focus();
        });

        function handleLogout() {
            auth.signOut();
        }

        // ========== Audit Log ==========

        function logCardView(docId, clientName) {
            try {
                db.collection('audit_log').add({
                    action: 'card_view',
                    billingDocId: docId,
                    clientName: clientName || '',
                    viewedBy: authUser ? authUser.email : (currentUser || 'unknown'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error('Audit log error:', e);
            }
        }

        // Global Variables
        let currentStep = 1;
        let currentUser = '';
        const totalSteps = 4;
        let searchTimeout = null;

        // Client Autocomplete Functionality
        async function searchClients(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) {
                return [];
            }

            try {
                // Search by client name - case insensitive
                const searchLower = searchTerm.toLowerCase();

                const clientsMap = new Map();

                // Query both collections in parallel
                const [salesSnapshot, billingSnapshot] = await Promise.all([
                    db.collection('sales_records')
                        .orderBy('timestamp', 'desc')
                        .limit(100)
                        .get(),
                    db.collection('recurring_billing')
                        .orderBy('createdAt', 'desc')
                        .limit(100)
                        .get()
                ]);

                // Process sales_records
                salesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const clientName = data.clientName || '';
                    const clientNameLower = clientName.toLowerCase();

                    if (clientNameLower.includes(searchLower)) {
                        if (!clientsMap.has(clientName)) {
                            clientsMap.set(clientName, {
                                clientName: data.clientName,
                                phone: data.phone,
                                email: data.email,
                                idNumber: data.idNumber,
                                address: data.address || ''
                            });
                        }
                    }
                });

                // Process recurring_billing
                billingSnapshot.forEach(doc => {
                    const data = doc.data();
                    const clientName = data.clientName || '';
                    const clientNameLower = clientName.toLowerCase();

                    if (clientNameLower.includes(searchLower)) {
                        if (!clientsMap.has(clientName)) {
                            clientsMap.set(clientName, {
                                clientName: data.clientName,
                                phone: data.phone || '',
                                email: data.email || '',
                                idNumber: data.idNumber || '',
                                address: data.address || ''
                            });
                        }
                    }
                });

                return Array.from(clientsMap.values());
            } catch (error) {
                console.error('Error searching clients:', error);
                return [];
            }
        }

        window.fillClientData = function(client) {
            document.getElementById('clientName').value = client.clientName;
            document.getElementById('phone').value = client.phone;
            document.getElementById('email').value = client.email;
            document.getElementById('idNumber').value = client.idNumber;
            document.getElementById('address').value = client.address;

            // Hide dropdown
            document.getElementById('clientAutocomplete').classList.remove('show');
        };

        function displayAutocompleteResults(clients) {
            const dropdown = document.getElementById('clientAutocomplete');

            if (clients.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">לא נמצאו לקוחות</div>';
                dropdown.classList.add('show');
                return;
            }

            dropdown.innerHTML = clients.map(client => `
                <div class="autocomplete-item" onclick="fillClientData(${JSON.stringify(client).replace(/"/g, '&quot;')})">
                    <div class="autocomplete-item-name">${client.clientName}</div>
                    <div class="autocomplete-item-details">
                        ${client.phone} • ${client.email}
                    </div>
                </div>
            `).join('');

            dropdown.classList.add('show');
        }

        // Initialize autocomplete on client name input
        document.addEventListener('DOMContentLoaded', function() {
            const clientNameInput = document.getElementById('clientName');
            const dropdown = document.getElementById('clientAutocomplete');

            clientNameInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value;

                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Hide dropdown if input is too short
                if (searchTerm.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }

                // Show loading state
                dropdown.innerHTML = '<div class="autocomplete-loading">מחפש...</div>';
                dropdown.classList.add('show');

                // Debounce search - wait 300ms after user stops typing
                searchTimeout = setTimeout(async () => {
                    const results = await searchClients(searchTerm);
                    displayAutocompleteResults(results);
                }, 300);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!clientNameInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Prevent form submission when selecting from dropdown
            clientNameInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && dropdown.classList.contains('show')) {
                    e.preventDefault();
                }
            });
        });

        // User Selection
        function selectUser(userName) {
            currentUser = userName;
            document.getElementById('userSelection').classList.add('hidden');
            document.getElementById('mainForm').classList.remove('hidden');
        }

        // Step Navigation
        function updateProgress() {
            const progressLine = document.getElementById('progressLine');
            const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressLine.style.width = `${100 - percentage}%`;

            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    indicator.classList.add('completed');
                    indicator.innerHTML = '✓';
                } else if (index + 1 === currentStep) {
                    indicator.classList.add('active');
                    indicator.innerHTML = index + 1;
                } else {
                    indicator.innerHTML = index + 1;
                }
            });

            document.querySelectorAll('.step-label').forEach((label, index) => {
                label.classList.toggle('active', index + 1 === currentStep);
            });
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
            currentStep = step;
            updateProgress();
        }

        function validateStep(step) {
            const stepElement = document.querySelector(`.form-step[data-step="${step}"]`);
            const requiredFields = stepElement.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            // Special validation for radio buttons in step 3
            if (step === 3) {
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!paymentMethod) {
                    isValid = false;
                }
            }

            // Special validation for amount field in step 2
            if (step === 2) {
                const amountField = document.getElementById('amount');
                const amountValue = parseAmount(amountField.value);
                if (amountValue <= 0) {
                    amountField.classList.add('error');
                    isValid = false;
                } else {
                    amountField.classList.remove('error');
                }
            }

            return isValid;
        }

        function nextStep() {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    showStep(currentStep + 1);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        // Transaction Type Change Handler
        document.getElementById('transactionType').addEventListener('change', function() {
            const hoursPackageFields = document.getElementById('hoursPackageFields');
            const descriptionGroup = document.getElementById('transactionDescriptionGroup');
            const hoursQuantity = document.getElementById('hoursQuantity');
            const hourlyRate = document.getElementById('hourlyRate');

            if (this.value === 'תוכנית שעות') {
                hoursPackageFields.classList.add('show');
                descriptionGroup.style.display = 'none';
                document.getElementById('transactionDescription').removeAttribute('required');
                hoursQuantity.setAttribute('required', 'required');
                hourlyRate.setAttribute('required', 'required');
            } else {
                hoursPackageFields.classList.remove('show');
                descriptionGroup.style.display = 'block';
                document.getElementById('transactionDescription').setAttribute('required', 'required');
                hoursQuantity.removeAttribute('required');
                hourlyRate.removeAttribute('required');
                hoursQuantity.value = '';
                hourlyRate.value = '';
            }
        });

        // Hours Package Calculation
        function updateAmountFromHours() {
            const hours = parseFloat(document.getElementById('hoursQuantity').value) || 0;
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const totalAmount = hours * rate;

            if (totalAmount > 0) {
                document.getElementById('amount').value = totalAmount.toFixed(2);
                updateVatDisplay();
            }
        }

        document.getElementById('hoursQuantity').addEventListener('input', updateAmountFromHours);
        document.getElementById('hourlyRate').addEventListener('input', updateAmountFromHours);

        // Collect checks details
        function collectChecksDetails() {
            const count = parseInt(document.getElementById('checksCount').value) || 0;
            const checks = [];

            for (let i = 1; i <= count; i++) {
                const dateInput = document.getElementById(`check_date_${i}`);
                const amountInput = document.getElementById(`check_amount_${i}`);

                if (dateInput && amountInput) {
                    checks.push({
                        checkNumber: i,
                        date: dateInput.value,
                        amount: parseAmount(amountInput.value)
                    });
                }
            }

            return JSON.stringify(checks);
        }

        // Checks Details - Dynamic Fields
        document.getElementById('checksCount').addEventListener('input', function() {
            const count = parseInt(this.value) || 0;
            const container = document.getElementById('checksDetailsContainer');
            container.innerHTML = '';

            if (count > 0) {
                for (let i = 1; i <= count; i++) {
                    const checkRow = document.createElement('div');
                    checkRow.className = 'form-row';
                    checkRow.style.marginBottom = '12px';
                    checkRow.innerHTML = `
                        <div class="form-group" style="flex: 1;">
                            <label>שיק ${i} - תאריך <span class="required">*</span></label>
                            <input type="date" id="check_date_${i}" class="check-date" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>שיק ${i} - סכום <span class="required">*</span></label>
                            <input type="number" id="check_amount_${i}" class="check-amount" placeholder="0" min="0" step="any" required>
                        </div>
                    `;
                    container.appendChild(checkRow);
                }

                // Add event listeners for auto-calculation
                setTimeout(() => {
                    for (let i = 1; i <= count; i++) {
                        const amountInput = document.getElementById(`check_amount_${i}`);
                        if (amountInput) {
                            amountInput.addEventListener('input', autoCalculateLastCheck);
                        }
                    }
                }, 100);
            }
        });

        // Auto-calculate last check amount
        function autoCalculateLastCheck() {
            const checksCount = parseInt(document.getElementById('checksCount').value) || 0;
            if (checksCount <= 1) return;

            const totalAmount = parseAmount(document.getElementById('checksTotalAmount').value);
            if (totalAmount <= 0) return;

            let sum = 0;
            for (let i = 1; i < checksCount; i++) {
                const amountInput = document.getElementById(`check_amount_${i}`);
                if (amountInput) {
                    sum += parseAmount(amountInput.value);
                }
            }

            const lastCheckAmount = totalAmount - sum;
            const lastCheckInput = document.getElementById(`check_amount_${checksCount}`);

            if (lastCheckInput && lastCheckAmount >= 0) {
                lastCheckInput.value = lastCheckAmount.toFixed(2);
            }
        }

        // Helper function to parse amount - handles commas and multiple decimal places
        function parseAmount(value) {
            if (!value) return 0;
            // Remove commas and extra spaces
            const cleaned = value.toString().replace(/,/g, '').trim();
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        // VAT Calculation Display
        function updateVatDisplay() {
            const amountBeforeVat = parseAmount(document.getElementById('amount').value);

            if (amountBeforeVat > 0) {
                const vatAmount = amountBeforeVat * 0.18;
                const amountWithVat = amountBeforeVat + vatAmount;

                document.getElementById('amountBeforeVat').textContent = '₪' + amountBeforeVat.toFixed(2);
                document.getElementById('vatAmount').textContent = '₪' + vatAmount.toFixed(2);
                document.getElementById('amountWithVat').textContent = '₪' + amountWithVat.toFixed(2);
                document.getElementById('vatDisplay').classList.add('show');
            } else {
                document.getElementById('vatDisplay').classList.remove('show');
            }
        }

        document.getElementById('amount').addEventListener('input', updateVatDisplay);

        // Global variable for split payment rows
        let splitPaymentRowCounter = 0;

        // Payment Method Change Handler
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const ccConfirm = document.getElementById('creditCardConfirmation');
                const checksDetail = document.getElementById('checksDetails');
                const splitPaymentDetail = document.getElementById('splitPaymentDetails');
                const checksPhoto = document.getElementById('checksPhoto');
                const checksCount = document.getElementById('checksCount');
                const checksTotalAmount = document.getElementById('checksTotalAmount');

                ccConfirm.classList.remove('show');
                checksDetail.classList.remove('show');
                splitPaymentDetail.classList.remove('show');

                // Show encouragement message based on payment method
                showEncouragementMessage(this.value);

                if (this.value === 'כרטיס אשראי') {
                    ccConfirm.classList.add('show');
                    updateAmountReminder('cc');
                    checksPhoto.removeAttribute('required');
                    checksCount.removeAttribute('required');
                    checksTotalAmount.removeAttribute('required');
                } else if (this.value === 'שיקים דחויים') {
                    checksDetail.classList.add('show');
                    updateAmountReminder('checks');
                    checksPhoto.setAttribute('required', 'required');
                    checksCount.setAttribute('required', 'required');
                    checksTotalAmount.setAttribute('required', 'required');
                } else if (this.value === 'פיצול תשלום') {
                    splitPaymentDetail.classList.add('show');
                    updateAmountReminder('split');
                    checksPhoto.removeAttribute('required');
                    checksCount.removeAttribute('required');
                    checksTotalAmount.removeAttribute('required');

                    // Initialize with one row if empty
                    if (document.getElementById('splitPaymentRows').children.length === 0) {
                        addSplitPaymentRow();
                    }
                } else {
                    checksPhoto.removeAttribute('required');
                    checksCount.removeAttribute('required');
                    checksTotalAmount.removeAttribute('required');
                }
            });
        });

        // Show Encouragement Message Function
        function showEncouragementMessage(paymentMethod) {
            const messageElement = document.getElementById('encouragementMessage');
            let icon = '';
            let text = '';

            switch(paymentMethod) {
                case 'מזומן':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                    text = 'אללק! קאש זה קינג! בואו נמשיך...';
                    break;
                case 'כרטיס אשראי':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>';
                    text = 'יפה! חכם ומודרני. בואו נמשיך...';
                    break;
                case 'שיקים דחויים':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';
                    text = 'קלאסי ואמין! בואו למלא את הפרטים...';
                    break;
                case 'העברה בנקאית':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                    text = 'מקצוען! ישר וברור. בואו נמשיך...';
                    break;
                case 'ביט':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>';
                    text = 'דיגיטלי עד הסוף! יאללה להמשיך...';
                    break;
                case 'פיצול תשלום':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                    text = 'גמישות מקסימלית! בואו נפרט את התשלומים...';
                    break;
                default:
                    icon = '';
                    text = '';
            }

            if (text) {
                messageElement.innerHTML = icon + '<span>' + text + '</span>';
                messageElement.classList.remove('hide');

                // Hide after 4 seconds with fade out
                setTimeout(() => {
                    messageElement.classList.add('hide');
                }, 4000);
            }
        }

        // Update Amount Reminder Function
        function updateAmountReminder(type) {
            const amountBeforeVat = parseFloat(document.getElementById('amount').value) || 0;
            if (amountBeforeVat > 0) {
                const amountWithVat = amountBeforeVat * 1.18;
                const formattedAmount = '₪' + amountWithVat.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                if (type === 'cc') {
                    document.getElementById('ccAmountReminder').textContent = formattedAmount;
                } else if (type === 'checks') {
                    document.getElementById('checksAmountReminder').textContent = formattedAmount;
                } else if (type === 'split') {
                    document.getElementById('splitAmountReminder').textContent = formattedAmount;
                }
            }
        }

        // Add Split Payment Row
        function addSplitPaymentRow() {
            splitPaymentRowCounter++;
            const rowId = 'splitRow_' + splitPaymentRowCounter;
            const container = document.getElementById('splitPaymentRows');

            const rowHTML = `
                <div class="split-payment-row" id="${rowId}" data-row-id="${rowId}">
                    <div class="split-row-header">
                        <div class="form-group">
                            <label>אמצעי תשלום</label>
                            <select class="split-payment-method" onchange="handleSplitMethodChange('${rowId}')">
                                <option value="">בחר אמצעי תשלום</option>
                                <option value="מזומן">מזומן</option>
                                <option value="כרטיס אשראי">כרטיס אשראי</option>
                                <option value="העברה בנקאית">העברה בנקאית</option>
                                <option value="ביט">ביט</option>
                                <option value="שיקים דחויים">שיקים דחויים</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>סכום (כולל מע"מ)</label>
                            <input type="number" class="split-payment-amount" placeholder="0" min="0" step="0.01" oninput="updateSplitPaymentSummary()">
                        </div>
                        <button type="button" class="split-payment-remove" onclick="removeSplitPaymentRow('${rowId}')" title="הסר">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <!-- אזור לשדות מפורטים - יוכנס דינמית -->
                    <div class="split-method-details" id="details_${rowId}"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', rowHTML);
            updateSplitPaymentSummary();
        }

        // Remove Split Payment Row
        function removeSplitPaymentRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateSplitPaymentSummary();
            }
        }

        // Handle Split Method Change - Show method-specific fields
        function handleSplitMethodChange(rowId) {
            const row = document.getElementById(rowId);
            const method = row.querySelector('.split-payment-method').value;
            const detailsContainer = document.getElementById('details_' + rowId);

            // Clear previous details
            detailsContainer.innerHTML = '';

            // Add method-specific fields
            if (method === 'כרטיס אשראי') {
                detailsContainer.innerHTML = getCreditCardDetailsHTML(rowId);
            } else if (method === 'שיקים דחויים') {
                detailsContainer.innerHTML = getChecksDetailsHTML(rowId);
            }

            updateSplitPaymentSummary();
        }

        // Get Credit Card Details HTML
        function getCreditCardDetailsHTML(rowId) {
            return `
                <div class="split-cc-details">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">פרטי כרטיס אשראי:</div>

                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="cc_full_${rowId}" name="cc_status_${rowId}" value="חיוב מלא" onchange="handleCreditCardStatusChange('${rowId}')">
                            <label for="cc_full_${rowId}">בוצע חיוב מלא</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="cc_deposit_${rowId}" name="cc_status_${rowId}" value="פיקדון" onchange="handleCreditCardStatusChange('${rowId}')">
                            <label for="cc_deposit_${rowId}">פיקדון</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="cc_temp_${rowId}" name="cc_status_${rowId}" value="אשראי זמני" onchange="handleCreditCardStatusChange('${rowId}')">
                            <label for="cc_temp_${rowId}">אשראי זמני - יוחלף</label>
                        </div>
                    </div>

                    <!-- חיוב מלא -->
                    <div id="cc_full_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>מספר תשלומים</label>
                            <input type="number" id="cc_payments_${rowId}" min="1" max="36" placeholder="1">
                        </div>
                    </div>

                    <!-- פיקדון -->
                    <div id="cc_deposit_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>חיוב חודשי</label>
                            <input type="number" id="cc_monthly_${rowId}" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>למשך כמה חודשים</label>
                            <input type="number" id="cc_months_${rowId}" min="1" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>פרטי פיקדון</label>
                            <textarea id="cc_deposit_text_${rowId}" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- אשראי זמני -->
                    <div id="cc_temp_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>פרטי החלפה</label>
                            <textarea id="cc_temp_text_${rowId}" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get Checks Details HTML
        function getChecksDetailsHTML(rowId) {
            return `
                <div class="split-checks-details">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">פרטי שיקים:</div>

                    <div class="form-group">
                        <label>כמה צ'קים?</label>
                        <input type="number" id="checks_count_${rowId}" min="1" placeholder="1">
                    </div>

                    <div class="form-group">
                        <label>סכום כל צ'ק</label>
                        <input type="number" id="checks_amount_${rowId}" step="0.01" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>צילום צ'ק</label>
                        <input type="file" id="checks_photo_${rowId}" accept="image/*,application/pdf">
                    </div>

                    <div class="form-group">
                        <label>פרטי צ'קים נוספים (אופציונלי)</label>
                        <textarea id="checks_details_${rowId}" rows="2" placeholder="תאריכים, מספרי צ'קים וכו'"></textarea>
                    </div>

                    <div style="margin-top: 12px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">האם הצ'ק יוחלף?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="check_replace_no_${rowId}" name="check_replace_${rowId}" value="לא" checked onchange="handleCheckReplaceChange('${rowId}')">
                                <label for="check_replace_no_${rowId}">לא</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="check_replace_yes_${rowId}" name="check_replace_${rowId}" value="כן" onchange="handleCheckReplaceChange('${rowId}')">
                                <label for="check_replace_yes_${rowId}">כן</label>
                            </div>
                        </div>
                    </div>

                    <div id="check_replace_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>באיזה אופן יוחלף?</label>
                            <textarea id="check_replace_text_${rowId}" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // Handle Credit Card Status Change
        function handleCreditCardStatusChange(rowId) {
            const fullDetails = document.getElementById('cc_full_details_' + rowId);
            const depositDetails = document.getElementById('cc_deposit_details_' + rowId);
            const tempDetails = document.getElementById('cc_temp_details_' + rowId);

            fullDetails.style.display = 'none';
            depositDetails.style.display = 'none';
            tempDetails.style.display = 'none';

            const selectedStatus = document.querySelector(`input[name="cc_status_${rowId}"]:checked`)?.value;

            if (selectedStatus === 'חיוב מלא') {
                fullDetails.style.display = 'block';
            } else if (selectedStatus === 'פיקדון') {
                depositDetails.style.display = 'block';
            } else if (selectedStatus === 'אשראי זמני') {
                tempDetails.style.display = 'block';
            }
        }

        // Handle Check Replace Change
        function handleCheckReplaceChange(rowId) {
            const replaceDetails = document.getElementById('check_replace_details_' + rowId);
            const willReplace = document.querySelector(`input[name="check_replace_${rowId}"]:checked`)?.value;

            replaceDetails.style.display = (willReplace === 'כן') ? 'block' : 'none';
        }

        // Update Split Payment Summary
        function updateSplitPaymentSummary() {
            const rows = document.querySelectorAll('.split-payment-row');
            let totalEntered = 0;

            rows.forEach(row => {
                const amount = parseFloat(row.querySelector('.split-payment-amount').value) || 0;
                totalEntered += amount;
            });

            const amountBeforeVat = parseFloat(document.getElementById('amount').value) || 0;
            const totalRequired = amountBeforeVat * 1.18;
            const remaining = totalRequired - totalEntered;

            document.getElementById('splitTotalEntered').textContent = '₪' + totalEntered.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('splitRemaining').textContent = '₪' + remaining.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Change color based on remaining amount
            const remainingElement = document.getElementById('splitRemaining');
            if (remaining === 0) {
                remainingElement.style.color = 'var(--success)';
            } else if (remaining < 0) {
                remainingElement.style.color = 'var(--error)';
            } else {
                remainingElement.style.color = 'var(--error)';
            }

            // Show/hide summary
            if (rows.length > 0 && totalEntered > 0) {
                document.getElementById('splitPaymentSummary').style.display = 'block';
            } else {
                document.getElementById('splitPaymentSummary').style.display = 'none';
            }
        }

        // Get Split Payment Data
        async function getSplitPaymentData() {
            const rows = document.querySelectorAll('.split-payment-row');
            const splitPayments = [];

            for (const row of rows) {
                const rowId = row.getAttribute('data-row-id');
                const method = row.querySelector('.split-payment-method').value;
                const amount = parseFloat(row.querySelector('.split-payment-amount').value) || 0;

                if (!method || amount <= 0) continue;

                const paymentData = {
                    method: method,
                    amount: amount
                };

                // Collect method-specific details
                if (method === 'כרטיס אשראי') {
                    const ccStatus = document.querySelector(`input[name="cc_status_${rowId}"]:checked`)?.value || '';
                    paymentData.creditCardStatus = ccStatus;

                    if (ccStatus === 'חיוב מלא') {
                        paymentData.paymentsCount = document.getElementById('cc_payments_' + rowId)?.value || '';
                    } else if (ccStatus === 'פיקדון') {
                        paymentData.monthlyCharge = document.getElementById('cc_monthly_' + rowId)?.value || '';
                        paymentData.monthsCount = document.getElementById('cc_months_' + rowId)?.value || '';
                        paymentData.depositDetails = document.getElementById('cc_deposit_text_' + rowId)?.value || '';
                    } else if (ccStatus === 'אשראי זמני') {
                        paymentData.temporaryCreditDetails = document.getElementById('cc_temp_text_' + rowId)?.value || '';
                    }
                } else if (method === 'שיקים דחויים') {
                    paymentData.checksCount = document.getElementById('checks_count_' + rowId)?.value || '';
                    paymentData.checksAmount = document.getElementById('checks_amount_' + rowId)?.value || '';
                    paymentData.checksDetails = document.getElementById('checks_details_' + rowId)?.value || '';

                    const checkReplace = document.querySelector(`input[name="check_replace_${rowId}"]:checked`)?.value || 'לא';
                    paymentData.checkWillChange = checkReplace;

                    if (checkReplace === 'כן') {
                        paymentData.checkReplacementDetails = document.getElementById('check_replace_text_' + rowId)?.value || '';
                    }

                    // Upload check photo
                    const checksPhotoFile = document.getElementById('checks_photo_' + rowId)?.files[0];
                    if (checksPhotoFile) {
                        const timestamp = Date.now();
                        const fileName = `checks/${timestamp}_${rowId}_${checksPhotoFile.name}`;
                        paymentData.checksPhotoURL = await uploadFile(checksPhotoFile, fileName);
                    }
                }

                splitPayments.push(paymentData);
            }

            return splitPayments;
        }

        // Credit Card Status Change Handler
        document.querySelectorAll('input[name="creditCardStatus"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const fullChargeDetails = document.getElementById('fullChargeDetails');
                const monthlyChargeDetails = document.getElementById('monthlyChargeDetails');
                const depositDetails = document.getElementById('depositDetails');
                const temporaryCreditDetails = document.getElementById('temporaryCreditDetails');
                const paymentsCount = document.getElementById('paymentsCount');
                const monthlyCharge = document.getElementById('monthlyCharge');
                const temporaryCreditText = document.getElementById('temporaryCreditText');
                const recurringMonthlyAmount = document.getElementById('recurringMonthlyAmount');
                const recurringMonthsCount = document.getElementById('recurringMonthsCount');
                const recurringStartDate = document.getElementById('recurringStartDate');

                // Reset all sections
                fullChargeDetails.classList.remove('show');
                monthlyChargeDetails.classList.remove('show');
                depositDetails.classList.remove('show');
                temporaryCreditDetails.classList.remove('show');
                paymentsCount.removeAttribute('required');
                monthlyCharge.removeAttribute('required');
                temporaryCreditText.removeAttribute('required');
                recurringMonthlyAmount.removeAttribute('required');
                recurringMonthsCount.removeAttribute('required');
                recurringStartDate.removeAttribute('required');

                if (this.value === 'בוצע חיוב מלא') {
                    fullChargeDetails.classList.add('show');
                    paymentsCount.setAttribute('required', 'required');
                } else if (this.value === 'חיוב חודשי') {
                    monthlyChargeDetails.classList.add('show');
                    recurringMonthlyAmount.setAttribute('required', 'required');
                    recurringMonthsCount.setAttribute('required', 'required');
                    recurringStartDate.setAttribute('required', 'required');
                } else if (this.value === 'פיקדון') {
                    depositDetails.classList.add('show');
                    monthlyCharge.setAttribute('required', 'required');
                } else if (this.value === 'אשראי זמני - יוחלף') {
                    temporaryCreditDetails.classList.add('show');
                    temporaryCreditText.setAttribute('required', 'required');
                } else {
                    // Reset all fields
                    paymentsCount.value = '';
                    monthlyCharge.value = '';
                    temporaryCreditText.value = '';
                    document.getElementById('monthsCount').value = '';
                    document.getElementById('depositDetailsText').value = '';
                    recurringMonthlyAmount.value = '';
                    recurringMonthsCount.value = '';
                    recurringStartDate.value = '';
                }
            });
        });

        // Check Will Change Handler
        document.querySelectorAll('input[name="checkWillChange"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const checkReplacementDetails = document.getElementById('checkReplacementDetails');
                const checkReplacementText = document.getElementById('checkReplacementText');

                if (this.value === 'כן') {
                    checkReplacementDetails.classList.add('show');
                    checkReplacementText.setAttribute('required', 'required');
                } else {
                    checkReplacementDetails.classList.remove('show');
                    checkReplacementText.removeAttribute('required');
                    checkReplacementText.value = '';
                }
            });
        });

        // File Upload Handler
        document.getElementById('checksPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const container = document.getElementById('checksUploadContainer');
                const preview = document.getElementById('checksPreview');
                const fileName = document.getElementById('checksFileName');
                const image = document.getElementById('checksImage');

                container.classList.add('has-file');
                fileName.textContent = '✓ ' + file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    image.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Upload File to Firebase Storage
        async function uploadFile(file, path) {
            if (!file) return null;

            try {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(path);

                // Upload file
                const uploadTask = await fileRef.put(file, {
                    contentType: file.type,
                    customMetadata: {
                        'uploadedBy': currentUser,
                        'uploadDate': new Date().toISOString()
                    }
                });

                // Get download URL
                const downloadURL = await uploadTask.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('שגיאה בהעלאת התמונה: ' + error.message);
                throw error;
            }
        }

        // Form Submission
        document.getElementById('salesForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validateStep(4)) return;

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');

            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            try {
                const transactionType = document.getElementById('transactionType').value;
                const amountBeforeVat = parseFloat(document.getElementById('amount').value);
                const vatAmount = amountBeforeVat * 0.18;
                const amountWithVat = amountBeforeVat + vatAmount;

                let transactionDescription = document.getElementById('transactionDescription').value;

                // If hours package, build description from hours and rate
                if (transactionType === 'תוכנית שעות') {
                    const hours = document.getElementById('hoursQuantity').value;
                    const rate = document.getElementById('hourlyRate').value;
                    transactionDescription = `תוכנית ${hours} שעות במחיר ₪${rate} לשעה`;
                }

                // Upload checks photo if exists
                let checksPhotoURL = '';
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || '';

                if (paymentMethod === 'שיקים דחויים') {
                    const checksPhotoFile = document.getElementById('checksPhoto').files[0];
                    if (checksPhotoFile) {
                        const timestamp = Date.now();
                        const fileName = `checks/${timestamp}_${checksPhotoFile.name}`;
                        checksPhotoURL = await uploadFile(checksPhotoFile, fileName);
                    }
                }

                // Handle split payment data
                let paymentBreakdown = '';
                let paymentBreakdownText = '';
                let isSplitPayment = false;

                if (paymentMethod === 'פיצול תשלום') {
                    isSplitPayment = true;
                    const splitPayments = await getSplitPaymentData();
                    paymentBreakdown = JSON.stringify(splitPayments);

                    // Create detailed readable text for Google Sheets
                    paymentBreakdownText = splitPayments.map(p => {
                        let text = `${p.method}: ₪${p.amount.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                        // Add additional details
                        if (p.method === 'כרטיס אשראי' && p.creditCardStatus) {
                            if (p.creditCardStatus === 'חיוב מלא' && p.paymentsCount) {
                                text += ` (${p.paymentsCount} תשלומים)`;
                            } else if (p.creditCardStatus === 'פיקדון' && p.monthlyCharge) {
                                text += ` (₪${p.monthlyCharge} × ${p.monthsCount} חודשים)`;
                            }
                        } else if (p.method === 'שיקים דחויים' && p.checksCount) {
                            text += ` (${p.checksCount} צ'קים)`;
                        }

                        return text;
                    }).join(' + ');
                }

                const formData = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString().split('T')[0],
                    formFillerName: currentUser,
                    clientName: document.getElementById('clientName').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    idNumber: document.getElementById('idNumber').value,
                    address: document.getElementById('address').value || '',
                    clientStatus: document.querySelector('input[name="clientStatus"]:checked')?.value || 'חדש',
                    transactionType: transactionType,
                    transactionDescription: transactionDescription,
                    hoursQuantity: document.getElementById('hoursQuantity').value || '',
                    hourlyRate: document.getElementById('hourlyRate').value || '',
                    amountBeforeVat: amountBeforeVat,
                    vatAmount: vatAmount,
                    amountWithVat: amountWithVat,
                    amount: amountBeforeVat, // Keep for backwards compatibility
                    paymentMethod: paymentMethod,
                    isSplitPayment: isSplitPayment,
                    paymentBreakdown: paymentBreakdown,
                    paymentBreakdownText: paymentBreakdownText,
                    // Credit Card fields
                    creditCardStatus: document.querySelector('input[name="creditCardStatus"]:checked')?.value || '',
                    paymentsCount: document.getElementById('paymentsCount').value || '',
                    monthlyCharge: document.getElementById('monthlyCharge').value || '',
                    monthsCount: document.getElementById('monthsCount').value || '',
                    depositDetails: document.getElementById('depositDetailsText').value || '',
                    temporaryCreditDetails: document.getElementById('temporaryCreditText').value || '',
                    // Recurring billing fields
                    recurringBilling: document.querySelector('input[name="creditCardStatus"]:checked')?.value === 'חיוב חודשי',
                    recurringMonthlyAmount: document.getElementById('recurringMonthlyAmount').value || '',
                    recurringMonthsCount: document.getElementById('recurringMonthsCount').value || '',
                    recurringStartDate: document.getElementById('recurringStartDate').value || '',
                    recurringDayOfMonth: document.getElementById('recurringDayOfMonth').value || '1',
                    recurringNotes: document.getElementById('recurringNotes').value || '',
                    // Checks fields
                    checksCount: document.getElementById('checksCount').value || '',
                    checksTotalAmount: document.getElementById('checksTotalAmount').value || '',
                    checksPhotoURL: checksPhotoURL,
                    checksDetailedList: collectChecksDetails(),
                    checksDetails: document.getElementById('checksDetailsText').value || '',
                    checkWillChange: document.querySelector('input[name="checkWillChange"]:checked')?.value || '',
                    checkReplacementDetails: document.getElementById('checkReplacementText').value || '',
                    attorney: document.getElementById('attorney').value,
                    caseNumber: document.getElementById('caseNumber').value || '',
                    branch: document.getElementById('branch').value,
                    notes: document.getElementById('notes').value || '',
                    invoiceNumber: '',
                    receiptNumber: ''
                };

                // Save to Firestore
                await db.collection('sales_records').add(formData);

                // Sync to Google Sheets
                await syncToSheets(formData);

                // Update success screen with sale details
                document.getElementById('summaryClientName').textContent = formData.clientName;
                document.getElementById('summaryTransactionType').textContent = formData.transactionType;

                // Handle payment method display for split payment
                if (formData.isSplitPayment) {
                    const splitPayments = JSON.parse(formData.paymentBreakdown);
                    const paymentSummary = splitPayments.map(p => `${p.method}: ₪${p.amount.toLocaleString('he-IL')}`).join(', ');
                    document.getElementById('summaryPaymentMethod').textContent = `פיצול תשלום (${paymentSummary})`;
                } else {
                    document.getElementById('summaryPaymentMethod').textContent = formData.paymentMethod;
                }

                document.getElementById('summaryAmount').textContent = formData.amountWithVat.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                // Show success
                document.getElementById('mainForm').classList.add('hidden');
                document.getElementById('successScreen').classList.add('show');

            } catch (error) {
                console.error('Error submitting form:', error);
                alert('אירעה שגיאה בשליחת הטופס. נסה שנית.');
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        // Sync to Google Sheets
        async function syncToSheets(data) {
            const WEBHOOK_URL = window.ENV_CONFIG.GOOGLE_SHEETS_WEBHOOK;

            console.log('🔵 ========== DEBUG: syncToSheets START ==========');
            console.log('🔵 Original data received:', data);
            console.log('🔵 Webhook URL:', WEBHOOK_URL);

            try {
                // Create a clean copy of the data for Google Sheets
                const sheetsData = {
                    ...data,
                    // Convert Firebase timestamp to ISO string
                    timestamp: new Date().toISOString(),
                    // Ensure date is in the correct format (YYYY-MM-DD)
                    date: data.date || new Date().toISOString().split('T')[0]
                };

                console.log('🟢 Cleaned data for sheets:', sheetsData);
                console.log('🟢 JSON string being sent:', JSON.stringify(sheetsData));
                console.log('🟢 JSON string length:', JSON.stringify(sheetsData).length);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetsData)
                });

                console.log('🟡 Fetch completed with no-cors mode');
                console.log('🟡 Response type:', response.type);
                console.log('✅ Data sent to Google Sheets (cannot read response in no-cors mode)');

            } catch (error) {
                console.error('🔴 Error syncing to sheets:', error);
                console.error('🔴 Error details:', error.message, error.stack);
                // Continue even if sync fails - data is safe in Firestore
            }

            console.log('🔵 ========== DEBUG: syncToSheets END ==========');
        }

        // Reset Form
        function resetForm() {
            document.getElementById('salesForm').reset();
            document.getElementById('successScreen').classList.remove('show');
            document.getElementById('mainForm').classList.remove('hidden');

            // Reset conditional fields
            document.getElementById('hoursPackageFields').classList.remove('show');
            document.getElementById('transactionDescriptionGroup').style.display = 'block';
            document.getElementById('vatDisplay').classList.remove('show');
            document.getElementById('creditCardConfirmation').classList.remove('show');
            document.getElementById('fullChargeDetails').classList.remove('show');
            document.getElementById('monthlyChargeDetails').classList.remove('show');
            document.getElementById('depositDetails').classList.remove('show');
            document.getElementById('temporaryCreditDetails').classList.remove('show');

            // Reset recurring billing fields
            document.getElementById('recurringMonthlyAmount').value = '';
            document.getElementById('recurringMonthsCount').value = '';
            document.getElementById('recurringStartDate').value = '';
            document.getElementById('recurringDayOfMonth').value = '1';
            document.getElementById('recurringNotes').value = '';
            document.getElementById('checksDetails').classList.remove('show');
            document.getElementById('checkReplacementDetails').classList.remove('show');
            document.getElementById('splitPaymentDetails').classList.remove('show');
            document.getElementById('encouragementMessage').classList.add('hide');

            // Reset split payment rows
            document.getElementById('splitPaymentRows').innerHTML = '';
            splitPaymentRowCounter = 0;
            document.getElementById('splitPaymentSummary').style.display = 'none';

            // Reset file upload
            document.getElementById('checksUploadContainer').classList.remove('has-file');
            document.getElementById('checksPreview').classList.remove('show');
            document.getElementById('checksImage').src = '';

            // Reset to step 1
            showStep(1);
        }

        // ========== הצפנת כרטיס אשראי ==========

        function encryptCardData(cardNumber, passphrase) {
            return CryptoJS.AES.encrypt(cardNumber, passphrase).toString();
        }

        function decryptCardData(encryptedData, passphrase) {
            try {
                var bytes = CryptoJS.AES.decrypt(encryptedData, passphrase);
                var decrypted = bytes.toString(CryptoJS.enc.Utf8);
                if (!decrypted) return null;
                return decrypted;
            } catch (e) {
                return null;
            }
        }

        // פופאפ סיסמת הצפנה מעוצב
        function requestPassword(mode) {
            return new Promise(function(resolve) {
                var overlay = document.getElementById('pwPopupOverlay');
                var input = document.getElementById('pwPopupInput');
                var errorEl = document.getElementById('pwPopupError');
                var title = document.getElementById('pwPopupTitle');
                var desc = document.getElementById('pwPopupDesc');

                if (mode === 'decrypt') {
                    title.textContent = 'צפייה בפרטי כרטיס';
                    desc.innerHTML = 'הזן את סיסמת המשרד כדי לצפות במספר הכרטיס המלא.<br>פעולה זו נרשמת ביומן הביקורת.';
                } else {
                    title.textContent = 'הצפנת פרטי כרטיס';
                    desc.innerHTML = 'סיסמה זו משמשת להצפנת פרטי כרטיס האשראי של הלקוח.<br>רק מי שיודע את הסיסמה יוכל לצפות במספר הכרטיס המלא.';
                }

                input.value = '';
                errorEl.textContent = '';
                overlay.classList.add('show');
                setTimeout(function() { input.focus(); }, 100);

                function cleanup() {
                    overlay.classList.remove('show');
                    document.getElementById('pwPopupConfirm').removeEventListener('click', onConfirm);
                    document.getElementById('pwPopupCancel').removeEventListener('click', onCancel);
                    input.removeEventListener('keydown', onKeydown);
                }

                function onConfirm() {
                    var val = input.value;
                    if (!val) {
                        errorEl.textContent = 'נא להזין סיסמה';
                        return;
                    }
                    cleanup();
                    resolve(val);
                }

                function onCancel() {
                    cleanup();
                    resolve(null);
                }

                function onKeydown(e) {
                    if (e.key === 'Enter') onConfirm();
                    if (e.key === 'Escape') onCancel();
                }

                document.getElementById('pwPopupConfirm').addEventListener('click', onConfirm);
                document.getElementById('pwPopupCancel').addEventListener('click', onCancel);
                input.addEventListener('keydown', onKeydown);
            });
        }

        // פורמט מספר כרטיס - רווח כל 4 ספרות
        document.addEventListener('DOMContentLoaded', function() {
            var cardInput = document.getElementById('billingCardNumber');
            if (cardInput) {
                cardInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 16);
                    var formatted = val.replace(/(\d{4})(?=\d)/g, '$1 ');
                    e.target.value = formatted;
                });
            }

            var expiryInput = document.getElementById('billingCardExpiry');
            if (expiryInput) {
                expiryInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 4);
                    if (val.length >= 3) {
                        val = val.substring(0, 2) + '/' + val.substring(2);
                    }
                    e.target.value = val;
                });
            }
        });

        // ========== מודאל גבייה חודשית ==========

        let billingSearchTimeout = null;

        function openBillingModal() {
            document.getElementById('billingModalOverlay').classList.add('show');
            // Reset form
            document.getElementById('billingClientSearch').value = '';
            document.getElementById('billingClientName').value = '';
            document.getElementById('billingPhone').value = '';
            document.getElementById('billingEmail').value = '';
            document.getElementById('billingIdNumber').value = '';
            document.getElementById('billingAddress').value = '';
            document.getElementById('billingAmount').value = '';
            document.getElementById('billingMonths').value = '';
            document.getElementById('billingStartDate').value = '';
            document.getElementById('billingDayOfMonth').value = '1';
            document.getElementById('billingPaidMonths').value = '0';
            document.getElementById('billingAttorney').value = '';
            document.getElementById('billingCaseNumber').value = '';
            document.getElementById('billingTransactionType').value = 'ריטיינר';
            document.getElementById('billingNotes').value = '';
            document.getElementById('billingCardNumber').value = '';
            document.getElementById('billingCardExpiry').value = '';
            document.getElementById('billingCardCvv').value = '';
            document.getElementById('billingCardHolder').value = '';
            document.getElementById('billingCardType').value = '';
            document.getElementById('billingAutocomplete').classList.remove('show');

            // Restore form view (in case success was shown)
            document.getElementById('billingModalBody').style.display = '';
            document.getElementById('billingModalFooter').style.display = '';
        }

        function closeBillingModal() {
            document.getElementById('billingModalOverlay').classList.remove('show');
        }

        // Autocomplete for billing modal
        document.getElementById('billingClientSearch').addEventListener('input', function(e) {
            const term = e.target.value.trim();
            clearTimeout(billingSearchTimeout);

            if (term.length < 2) {
                document.getElementById('billingAutocomplete').classList.remove('show');
                return;
            }

            billingSearchTimeout = setTimeout(async () => {
                const dropdown = document.getElementById('billingAutocomplete');
                dropdown.innerHTML = '<div class="billing-autocomplete-item" style="color:#6b7280;cursor:default;">מחפש...</div>';
                dropdown.classList.add('show');

                const clients = await searchClients(term);

                if (clients.length === 0) {
                    dropdown.innerHTML = '<div class="billing-autocomplete-item" style="color:#6b7280;cursor:default;">לא נמצאו לקוחות</div>';
                    return;
                }

                dropdown.innerHTML = clients.map(client =>
                    `<div class="billing-autocomplete-item" onclick='fillBillingClientData(${JSON.stringify(client).replace(/'/g, "&#39;")})'>
                        <div class="billing-autocomplete-name">${client.clientName}</div>
                        <div class="billing-autocomplete-details">${client.phone || ''} ${client.email ? '| ' + client.email : ''}</div>
                    </div>`
                ).join('');
            }, 300);
        });

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            const search = document.getElementById('billingClientSearch');
            const dropdown = document.getElementById('billingAutocomplete');
            if (search && dropdown && !search.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        window.fillBillingClientData = function(client) {
            document.getElementById('billingClientName').value = client.clientName || '';
            document.getElementById('billingPhone').value = client.phone || '';
            document.getElementById('billingEmail').value = client.email || '';
            document.getElementById('billingIdNumber').value = client.idNumber || '';
            document.getElementById('billingAddress').value = client.address || '';
            document.getElementById('billingClientSearch').value = client.clientName || '';
            document.getElementById('billingAutocomplete').classList.remove('show');
        };

        async function submitBillingForm() {
            // Validation
            const clientName = document.getElementById('billingClientName').value.trim();
            const amount = document.getElementById('billingAmount').value;
            const months = document.getElementById('billingMonths').value;
            const startDate = document.getElementById('billingStartDate').value;
            const attorney = document.getElementById('billingAttorney').value;

            if (!clientName || !amount || !months || !startDate || !attorney) {
                alert('נא למלא את כל השדות המסומנים בכוכבית');
                return;
            }

            const submitBtn = document.getElementById('billingSubmitBtn');
            submitBtn.disabled = true;
            document.getElementById('billingSubmitText').textContent = 'שומר...';

            try {
                // הצפנת פרטי כרטיס אשראי
                const cardNumber = (document.getElementById('billingCardNumber').value || '').replace(/\s/g, '');
                const cardExpiry = document.getElementById('billingCardExpiry').value || '';
                const cardCvv = document.getElementById('billingCardCvv').value || '';
                const cardHolder = document.getElementById('billingCardHolder').value || '';
                const cardType = document.getElementById('billingCardType').value || '';
                let cardEncrypted = '';
                let cvvEncrypted = '';
                let cardLast4 = '';

                if (cardNumber) {
                    const passphrase = await requestPassword('encrypt');
                    if (!passphrase) {
                        submitBtn.disabled = false;
                        document.getElementById('billingSubmitText').textContent = 'שמור וצור תזכורות';
                        return;
                    }
                    cardEncrypted = encryptCardData(cardNumber, passphrase);
                    cardLast4 = cardNumber.slice(-4);
                    if (cardCvv) {
                        cvvEncrypted = encryptCardData(cardCvv, passphrase);
                    }
                }

                const billingData = {
                    clientName: clientName,
                    phone: document.getElementById('billingPhone').value || '',
                    email: document.getElementById('billingEmail').value || '',
                    idNumber: document.getElementById('billingIdNumber').value || '',
                    address: document.getElementById('billingAddress').value || '',
                    recurringMonthlyAmount: amount,
                    recurringMonthsCount: months,
                    recurringStartDate: startDate,
                    recurringDayOfMonth: document.getElementById('billingDayOfMonth').value || '1',
                    paidMonthsAlready: parseInt(document.getElementById('billingPaidMonths').value) || 0,
                    attorney: attorney,
                    caseNumber: document.getElementById('billingCaseNumber').value || '',
                    branch: document.getElementById('billingBranch').value || 'תל אביב',
                    transactionType: document.getElementById('billingTransactionType').value || 'ריטיינר',
                    transactionDescription: 'חיוב חודשי - ' + clientName,
                    recurringNotes: document.getElementById('billingNotes').value || '',
                    recurringBilling: true,
                    creditCardStatus: 'חיוב חודשי',
                    paymentMethod: 'כרטיס אשראי',
                    status: 'פעיל',
                    cardEncrypted: cardEncrypted,
                    cvvEncrypted: cvvEncrypted,
                    cardLast4: cardLast4,
                    cardExpiry: cardExpiry,
                    cardHolder: cardHolder,
                    cardType: cardType,
                    createdBy: currentUser || 'לא ידוע',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // שמירה ב-Firestore
                await db.collection('recurring_billing').add(billingData);

                // שליחה ל-webhook (ליצירת שורות בגיליון גבייה חודשית)
                const webhookData = {
                    ...billingData,
                    action: 'addRecurringBilling',
                    timestamp: new Date().toISOString()
                };

                const WEBHOOK_URL = window.ENV_CONFIG.GOOGLE_SHEETS_WEBHOOK;
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookData)
                });

                // הצגת הודעת הצלחה
                document.getElementById('billingModalBody').innerHTML =
                    '<div class="billing-success-msg">' +
                        '<div class="check-icon">&#10004;</div>' +
                        '<h3 style="margin:0 0 8px;color:#1f2937;">הלקוח נוסף לגבייה בהצלחה!</h3>' +
                        '<p style="color:#6b7280;margin:0 0 4px;">' + clientName + '</p>' +
                        '<p style="color:#6b7280;margin:0;">₪' + parseFloat(amount).toLocaleString('he-IL') + ' × ' + months + ' חודשים</p>' +
                        '<p style="color:#9ca3af;font-size:12px;margin-top:12px;">תזכורות יישלחו אוטומטית יום לפני כל חיוב</p>' +
                    '</div>';
                document.getElementById('billingModalFooter').innerHTML =
                    '<button class="billing-btn-submit" onclick="closeBillingModal()" style="width:100%;">סגור</button>';

            } catch (error) {
                console.error('Error saving billing data:', error);
                alert('שגיאה בשמירה: ' + error.message);
                submitBtn.disabled = false;
                document.getElementById('billingSubmitText').textContent = 'שמור וצור תזכורות';
            }
        }

        // ========== ניהול גבייה חודשית - Management View ==========

        let billingClients = [];
        let billingFilter = 'all';
        let billingViewMode = 'table';

        function showBillingManagement() {
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('billingManagement').classList.add('active');
            loadBillingData();
        }

        function hideBillingManagement() {
            document.getElementById('billingManagement').classList.remove('active');
            document.getElementById('mainContainer').style.display = '';
        }

        // סנכרון לקוחות קיימים מ-Firestore לגיליון Google Sheets
        async function syncBillingToSheets() {
            const btn = document.getElementById('bmSyncBtn');
            const originalText = btn.innerHTML;

            if (!confirm('פעולה זו תשלח את כל הלקוחות הקיימים מ-Firestore לגיליון Google Sheets.\nלקוחות שכבר קיימים בגיליון לא ייכפלו.\n\nלהמשיך?')) {
                return;
            }

            btn.disabled = true;
            btn.classList.add('syncing');
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg> מסנכרן...';

            try {
                const snapshot = await db.collection('recurring_billing').get();
                const total = snapshot.size;
                let sent = 0;
                let errors = 0;

                const WEBHOOK_URL = window.ENV_CONFIG.GOOGLE_SHEETS_WEBHOOK;

                for (const doc of snapshot.docs) {
                    const data = doc.data();

                    // דלג על לקוחות מבוטלים
                    if (data.status === 'בוטל') {
                        sent++;
                        continue;
                    }

                    const webhookData = {
                        action: 'addRecurringBilling',
                        clientName: data.clientName || '',
                        phone: data.phone || '',
                        email: data.email || '',
                        idNumber: data.idNumber || '',
                        address: data.address || '',
                        recurringMonthlyAmount: data.recurringMonthlyAmount || '',
                        recurringMonthsCount: data.recurringMonthsCount || '',
                        recurringStartDate: data.recurringStartDate || '',
                        recurringDayOfMonth: data.recurringDayOfMonth || '1',
                        paidMonthsAlready: data.paidMonthsAlready || 0,
                        attorney: data.attorney || '',
                        caseNumber: data.caseNumber || '',
                        branch: data.branch || 'תל אביב',
                        transactionType: data.transactionType || 'ריטיינר',
                        transactionDescription: data.transactionDescription || 'חיוב חודשי - ' + (data.clientName || ''),
                        recurringNotes: data.recurringNotes || '',
                        recurringBilling: true,
                        creditCardStatus: 'חיוב חודשי',
                        paymentMethod: 'כרטיס אשראי',
                        timestamp: new Date().toISOString()
                    };

                    try {
                        await fetch(WEBHOOK_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(webhookData)
                        });
                        sent++;
                    } catch (err) {
                        console.error('Sync error for ' + data.clientName + ':', err);
                        errors++;
                    }

                    // עדכון כפתור עם התקדמות
                    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg> ' + sent + '/' + total;

                    // המתנה קצרה בין בקשות כדי לא להעמיס
                    await new Promise(r => setTimeout(r, 500));
                }

                const msg = 'סנכרון הושלם!\n' + sent + ' לקוחות נשלחו לגיליון.' +
                    (errors > 0 ? '\n' + errors + ' שגיאות.' : '');
                alert(msg);

            } catch (error) {
                console.error('Sync error:', error);
                alert('שגיאה בסנכרון: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.classList.remove('syncing');
                btn.innerHTML = originalText;
            }
        }

        async function loadBillingData() {
            const loading = document.getElementById('bmLoading');
            const empty = document.getElementById('bmEmpty');
            const tableView = document.getElementById('bmTableView');
            const cardsView = document.getElementById('bmCardsView');

            loading.style.display = '';
            tableView.style.display = 'none';
            cardsView.style.display = 'none';
            empty.style.display = 'none';

            try {
                const snapshot = await db.collection('recurring_billing')
                    .orderBy('createdAt', 'desc')
                    .get();

                billingClients = [];
                snapshot.forEach(doc => {
                    billingClients.push({ id: doc.id, ...doc.data() });
                });

                loading.style.display = 'none';

                if (billingClients.length === 0) {
                    empty.style.display = '';
                    return;
                }

                updateBillingSummary();
                renderBillingView();
            } catch (error) {
                console.error('Error loading billing data:', error);
                loading.innerHTML = '<p style="color:var(--error);">שגיאה בטעינת הנתונים</p>';
            }
        }

        function updateBillingSummary() {
            const active = billingClients.filter(c => c.status === 'פעיל' || !c.status);
            const totalMonthly = active.reduce((sum, c) => sum + (parseFloat(c.recurringMonthlyAmount) || 0), 0);

            let totalPaid = 0;
            let totalRemaining = 0;

            billingClients.forEach(c => {
                const amount = parseFloat(c.recurringMonthlyAmount) || 0;
                const totalMonths = parseInt(c.recurringMonthsCount) || 0;
                const totalDeal = amount * totalMonths;

                // Calculate paid months based on start date
                const paidMonths = calculatePaidMonths(c);
                totalPaid += amount * paidMonths;
                totalRemaining += totalDeal - (amount * paidMonths);
            });

            document.getElementById('bmStatTotal').textContent = active.length;
            document.getElementById('bmStatMonthly').textContent = '₪' + totalMonthly.toLocaleString('he-IL');
            document.getElementById('bmStatPaid').textContent = '₪' + totalPaid.toLocaleString('he-IL');
            document.getElementById('bmStatRemaining').textContent = '₪' + Math.max(0, totalRemaining).toLocaleString('he-IL');
        }

        function calculatePaidMonths(client) {
            const alreadyPaid = parseInt(client.paidMonthsAlready) || 0;
            if (!client.recurringStartDate) return alreadyPaid;
            const start = new Date(client.recurringStartDate);
            const now = new Date();
            const totalMonths = parseInt(client.recurringMonthsCount) || 0;

            if (client.status === 'בוטל') return alreadyPaid;

            // diffMonths = כמה חודשים עברו מתאריך ההתחלה המקורי
            let diffMonths = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
            if (now.getDate() >= (parseInt(client.recurringDayOfMonth) || 1)) {
                diffMonths += 1;
            }
            diffMonths = Math.max(0, diffMonths);

            // alreadyPaid משמש כרצפה - למקרה שתאריך ההתחלה עתידי
            // אבל לא מצטבר מעל diffMonths כי הוא כבר נכלל בספירת החודשים
            return Math.min(Math.max(diffMonths, alreadyPaid), totalMonths);
        }

        function getNextReminderDate(client) {
            if (client.status === 'בוטל' || client.status === 'מושהה') return null;
            const start = new Date(client.recurringStartDate);
            const totalMonths = parseInt(client.recurringMonthsCount) || 0;
            const dayOfMonth = parseInt(client.recurringDayOfMonth) || 1;
            const now = new Date();

            for (let i = 0; i < totalMonths; i++) {
                const chargeDate = new Date(start.getFullYear(), start.getMonth() + i, dayOfMonth);
                if (chargeDate > now) {
                    return chargeDate;
                }
            }
            return null;
        }

        function formatDate(date) {
            if (!date) return '—';
            const d = date instanceof Date ? date : new Date(date);
            if (isNaN(d.getTime())) return '—';
            return d.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function getStatusBadge(status) {
            const s = status || 'פעיל';
            const map = { 'פעיל': 'active', 'מושהה': 'paused', 'בוטל': 'cancelled' };
            const cls = map[s] || 'active';
            return '<span class="bm-badge ' + cls + '">' + s + '</span>';
        }

        function setBillingFilter(filter, btn) {
            billingFilter = filter;
            document.querySelectorAll('.bm-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBillingView();
        }

        function setBillingViewMode(mode) {
            billingViewMode = mode;
            document.getElementById('bmViewTable').classList.toggle('active', mode === 'table');
            document.getElementById('bmViewCards').classList.toggle('active', mode === 'cards');
            document.getElementById('bmTableView').style.display = mode === 'table' ? '' : 'none';
            document.getElementById('bmCardsView').style.display = mode === 'cards' ? '' : 'none';
        }

        function filterBillingView() {
            renderBillingView();
        }

        function getFilteredClients() {
            let filtered = billingClients;

            if (billingFilter !== 'all') {
                filtered = filtered.filter(c => (c.status || 'פעיל') === billingFilter);
            }

            const search = (document.getElementById('bmSearch').value || '').trim().toLowerCase();
            if (search) {
                filtered = filtered.filter(c =>
                    (c.clientName || '').toLowerCase().includes(search) ||
                    (c.attorney || '').toLowerCase().includes(search) ||
                    (c.caseNumber || '').toLowerCase().includes(search) ||
                    (c.phone || '').includes(search)
                );
            }

            return filtered;
        }

        function renderBillingView() {
            const filtered = getFilteredClients();
            const tableView = document.getElementById('bmTableView');
            const cardsView = document.getElementById('bmCardsView');
            const empty = document.getElementById('bmEmpty');

            if (filtered.length === 0) {
                tableView.style.display = 'none';
                cardsView.style.display = 'none';
                empty.style.display = '';
                return;
            }

            empty.style.display = 'none';
            tableView.style.display = billingViewMode === 'table' ? '' : 'none';
            cardsView.style.display = billingViewMode === 'cards' ? '' : 'none';

            renderTableView(filtered);
            renderCardsView(filtered);
        }

        function renderTableView(clients) {
            const tbody = document.getElementById('bmTableBody');
            tbody.innerHTML = clients.map(c => {
                const amount = parseFloat(c.recurringMonthlyAmount) || 0;
                const totalMonths = parseInt(c.recurringMonthsCount) || 0;
                const totalDeal = amount * totalMonths;
                const paidMonths = calculatePaidMonths(c);
                const paidAmount = amount * paidMonths;
                const progressPct = totalMonths > 0 ? Math.round((paidMonths / totalMonths) * 100) : 0;
                const nextDate = getNextReminderDate(c);

                return '<tr>' +
                    '<td><strong>' + (c.clientName || '') + '</strong>' +
                        (c.caseNumber ? '<br><span style="font-size:11px;color:var(--gray-400);">תיק ' + c.caseNumber + '</span>' : '') +
                    '</td>' +
                    '<td>' + (c.attorney || '—') + '</td>' +
                    '<td class="bm-amount">₪' + amount.toLocaleString('he-IL') + '</td>' +
                    '<td class="bm-amount">₪' + totalDeal.toLocaleString('he-IL') + '</td>' +
                    '<td class="bm-amount" style="color:var(--success);">₪' + paidAmount.toLocaleString('he-IL') + '</td>' +
                    '<td>' + paidMonths + '/' + totalMonths +
                        '<div class="bm-progress-bar"><div class="bm-progress-fill" style="width:' + progressPct + '%"></div></div>' +
                    '</td>' +
                    '<td>' + getStatusBadge(c.status) + '</td>' +
                    '<td style="font-size:12px;white-space:nowrap;">' +
                        (c.cardLast4
                            ? '<span style="font-variant-numeric:tabular-nums;">•••• ' + c.cardLast4 + '</span>' +
                              (c.cardType ? '<br><span style="color:var(--gray-400);font-size:11px;">' + c.cardType + '</span>' : '') +
                              ' <button onclick="revealCard(\'' + c.id + '\')" style="background:none;border:none;color:var(--primary-blue);cursor:pointer;font-size:11px;font-family:Heebo,sans-serif;padding:0;">הצג</button>'
                            : '<span style="color:var(--gray-300);">—</span>') +
                    '</td>' +
                    '<td style="font-size:12px;">' + formatDate(nextDate) + '</td>' +
                    '<td style="white-space:nowrap;">' +
                        '<div style="display:flex;gap:6px;">' +
                            '<button onclick="openEditModal(\'' + c.id + '\')" style="background:none;border:1px solid var(--gray-300);color:var(--gray-500);border-radius:6px;padding:4px 10px;font-size:11px;font-family:Heebo,sans-serif;cursor:pointer;">עריכה</button>' +
                            '<a href="https://merchant.sensepass.com/apps/transactions/list" target="_blank" style="background:none;border:1px solid #10b981;color:#10b981;border-radius:6px;padding:4px 10px;font-size:11px;font-family:Heebo,sans-serif;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:3px;">סליקה</a>' +
                            (c.cardEncrypted ? '<button onclick="revealAndCopy(\'' + c.id + '\')" style="background:none;border:1px solid #f59e0b;color:#f59e0b;border-radius:6px;padding:4px 10px;font-size:11px;font-family:Heebo,sans-serif;cursor:pointer;">העתק כרטיס</button>' : '') +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function renderCardsView(clients) {
            const container = document.getElementById('bmCardsContainer');
            container.innerHTML = clients.map(c => {
                const amount = parseFloat(c.recurringMonthlyAmount) || 0;
                const totalMonths = parseInt(c.recurringMonthsCount) || 0;
                const totalDeal = amount * totalMonths;
                const paidMonths = calculatePaidMonths(c);
                const paidAmount = amount * paidMonths;
                const remainingAmount = Math.max(0, totalDeal - paidAmount);
                const progressPct = totalMonths > 0 ? Math.round((paidMonths / totalMonths) * 100) : 0;
                const nextDate = getNextReminderDate(c);
                const progressClass = progressPct >= 80 ? ' high' : '';

                return '<div class="bm-card">' +
                    '<div class="bm-card-top">' +
                        '<div>' +
                            '<div class="bm-card-name">' + (c.clientName || '') + '</div>' +
                            '<div class="bm-card-case">' + (c.caseNumber ? 'תיק ' + c.caseNumber : '') + (c.attorney ? ' | ' + c.attorney : '') + '</div>' +
                        '</div>' +
                        '<div style="display:flex;align-items:center;gap:8px;">' +
                            getStatusBadge(c.status) +
                            '<button onclick="openEditModal(\'' + c.id + '\')" style="background:none;border:1px solid var(--gray-300);color:var(--gray-500);border-radius:6px;padding:3px 8px;font-size:11px;font-family:Heebo,sans-serif;cursor:pointer;">עריכה</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="bm-card-body">' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">סכום חודשי</div>' +
                            '<div class="bm-card-field-value">₪' + amount.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">סה"כ עסקה</div>' +
                            '<div class="bm-card-field-value">₪' + totalDeal.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">שולם</div>' +
                            '<div class="bm-card-field-value" style="color:var(--success);">₪' + paidAmount.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">נותר</div>' +
                            '<div class="bm-card-field-value" style="color:var(--error);">₪' + remainingAmount.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                    '</div>' +
                    (c.cardLast4 ?
                        '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:1px solid var(--gray-100);margin-bottom:6px;">' +
                            '<span style="font-size:12px;color:var(--gray-500);font-variant-numeric:tabular-nums;">•••• ' + c.cardLast4 +
                                (c.cardType ? ' <span style="color:var(--gray-400);">(' + c.cardType + ')</span>' : '') +
                                (c.cardExpiry ? ' <span style="color:var(--gray-400);">' + c.cardExpiry + '</span>' : '') +
                            '</span>' +
                            '<button onclick="revealCard(\'' + c.id + '\')" style="background:none;border:1px solid var(--primary-blue);color:var(--primary-blue);border-radius:6px;padding:3px 10px;font-size:11px;font-family:Heebo,sans-serif;cursor:pointer;">הצג מספר</button>' +
                        '</div>' : '') +
                    '<div class="bm-card-progress">' +
                        '<div class="bm-card-progress-text">' +
                            '<span>' + paidMonths + ' מתוך ' + totalMonths + ' תשלומים</span>' +
                            '<span>' + progressPct + '%</span>' +
                        '</div>' +
                        '<div class="bm-card-progress-bar"><div class="bm-card-progress-fill' + progressClass + '" style="width:' + progressPct + '%"></div></div>' +
                    '</div>' +
                    (nextDate ? '<div style="margin-top:10px;font-size:11px;color:var(--gray-400);">תזכורת הבאה: ' + formatDate(nextDate) + '</div>' : '') +
                    '<div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--gray-100);">' +
                        '<a href="https://merchant.sensepass.com/apps/transactions/list" target="_blank" style="flex:1;text-align:center;background:#10b981;color:white;border:none;border-radius:8px;padding:8px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;text-decoration:none;display:inline-block;">סליקת אשראי</a>' +
                        (c.cardEncrypted ? '<button onclick="revealAndCopy(\'' + c.id + '\')" style="flex:1;background:none;border:1px solid #f59e0b;color:#f59e0b;border-radius:8px;padding:8px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק פרטי כרטיס</button>' : '') +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // ========== חשיפת מספר כרטיס מוצפן ==========

        async function revealCard(docId) {
            const passphrase = await requestPassword('decrypt');
            if (!passphrase) return;

            try {
                const doc = await db.collection('recurring_billing').doc(docId).get();
                if (!doc.exists) {
                    alert('הרשומה לא נמצאה');
                    return;
                }

                const data = doc.data();
                if (!data.cardEncrypted) {
                    alert('אין מספר כרטיס מוצפן לרשומה זו');
                    return;
                }

                const decrypted = decryptCardData(data.cardEncrypted, passphrase);
                if (!decrypted) {
                    alert('סיסמה שגויה');
                    return;
                }

                // רישום לוג צפייה
                logCardView(docId, data.clientName);

                // פענוח CVV אם קיים
                var cvvDecrypted = '';
                if (data.cvvEncrypted) {
                    cvvDecrypted = decryptCardData(data.cvvEncrypted, passphrase) || '';
                }

                // הצגת המספר בחלון מעוצב שנסגר אוטומטית
                var formatted = decrypted.replace(/(\d{4})(?=\d)/g, '$1 ');
                var overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;';
                overlay.innerHTML =
                    '<div style="background:white;border-radius:16px;padding:28px;max-width:360px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">' +
                        '<div style="margin-bottom:16px;">' +
                            '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>' +
                        '</div>' +
                        '<div style="font-size:13px;color:#6b7280;margin-bottom:8px;">' + (data.cardHolder || data.clientName || '') + '</div>' +
                        '<div style="font-size:22px;font-weight:700;letter-spacing:3px;direction:ltr;font-variant-numeric:tabular-nums;color:#1f2937;margin-bottom:6px;">' + formatted + '</div>' +
                        '<div style="display:flex;justify-content:center;gap:20px;margin-top:10px;">' +
                            (data.cardExpiry ? '<div><div style="font-size:11px;color:#9ca3af;">תוקף</div><div style="font-size:15px;font-weight:600;color:#374151;direction:ltr;">' + data.cardExpiry + '</div></div>' : '') +
                            (cvvDecrypted ? '<div><div style="font-size:11px;color:#9ca3af;">CVV</div><div style="font-size:15px;font-weight:600;color:#374151;direction:ltr;">' + cvvDecrypted + '</div></div>' : '') +
                        '</div>' +
                        (data.cardType ? '<div style="font-size:12px;color:#9ca3af;margin-top:8px;">' + data.cardType + '</div>' : '') +
                        '<div style="font-size:11px;color:#ef4444;margin-top:14px;">החלון ייסגר אוטומטית בעוד 30 שניות</div>' +
                        '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="margin-top:14px;background:#2563eb;color:white;border:none;padding:8px 28px;border-radius:8px;font-family:Heebo,sans-serif;font-size:14px;font-weight:600;cursor:pointer;">סגור</button>' +
                    '</div>';
                document.body.appendChild(overlay);
                overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });

                // סגירה אוטומטית אחרי 30 שניות
                setTimeout(function() { if (overlay.parentNode) overlay.remove(); }, 30000);

            } catch (error) {
                console.error('Error revealing card:', error);
                alert('שגיאה בטעינת הנתונים');
            }
        }

        // ========== העתקת פרטי כרטיס ==========

        async function revealAndCopy(docId) {
            const passphrase = await requestPassword('decrypt');
            if (!passphrase) return;

            try {
                const doc = await db.collection('recurring_billing').doc(docId).get();
                if (!doc.exists) { alert('הרשומה לא נמצאה'); return; }

                const data = doc.data();
                if (!data.cardEncrypted) { alert('אין פרטי כרטיס לרשומה זו'); return; }

                const decrypted = decryptCardData(data.cardEncrypted, passphrase);
                if (!decrypted) { alert('סיסמה שגויה'); return; }

                logCardView(docId, data.clientName);

                var cvvDecrypted = data.cvvEncrypted ? (decryptCardData(data.cvvEncrypted, passphrase) || '') : '';
                var formatted = decrypted.replace(/(\d{4})(?=\d)/g, '$1 ');

                var overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.55);z-index:2000;display:flex;align-items:center;justify-content:center;';
                overlay.innerHTML =
                    '<div style="background:white;border-radius:16px;padding:28px;max-width:400px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">' +
                        '<div style="text-align:center;margin-bottom:18px;">' +
                            '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>' +
                            '<div style="font-size:15px;font-weight:700;color:#1f2937;margin-top:8px;">' + (data.clientName || '') + '</div>' +
                        '</div>' +
                        '<div style="display:flex;flex-direction:column;gap:8px;">' +
                            '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">מספר כרטיס</div><div style="font-size:16px;font-weight:600;direction:ltr;font-variant-numeric:tabular-nums;color:#1f2937;">' + formatted + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + decrypted + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;white-space:nowrap;">העתק</button>' +
                            '</div>' +
                            (data.cardExpiry ? '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">תוקף</div><div style="font-size:15px;font-weight:600;direction:ltr;color:#1f2937;">' + data.cardExpiry + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + data.cardExpiry + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק</button>' +
                            '</div>' : '') +
                            (cvvDecrypted ? '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">CVV</div><div style="font-size:15px;font-weight:600;direction:ltr;color:#1f2937;">' + cvvDecrypted + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + cvvDecrypted + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק</button>' +
                            '</div>' : '') +
                            (data.cardHolder ? '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">שם בעל הכרטיס</div><div style="font-size:14px;font-weight:600;color:#1f2937;">' + data.cardHolder + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + (data.cardHolder || '').replace(/'/g, "\\'") + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק</button>' +
                            '</div>' : '') +
                        '</div>' +
                        '<div style="text-align:center;margin-top:16px;">' +
                            '<div style="font-size:11px;color:#ef4444;margin-bottom:10px;">החלון ייסגר אוטומטית בעוד 30 שניות</div>' +
                            '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:#2563eb;color:white;border:none;padding:8px 28px;border-radius:8px;font-family:Heebo,sans-serif;font-size:14px;font-weight:600;cursor:pointer;">סגור</button>' +
                        '</div>' +
                    '</div>';
                document.body.appendChild(overlay);
                overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
                setTimeout(function() { if (overlay.parentNode) overlay.remove(); }, 30000);

            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בטעינת הנתונים');
            }
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(function() {
                var original = btn.textContent;
                btn.textContent = 'הועתק!';
                btn.style.background = '#10b981';
                setTimeout(function() {
                    btn.textContent = original;
                    btn.style.background = '#2563eb';
                }, 1500);
            }).catch(function() {
                // fallback
                var input = document.createElement('input');
                input.value = text;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                var original = btn.textContent;
                btn.textContent = 'הועתק!';
                btn.style.background = '#10b981';
                setTimeout(function() {
                    btn.textContent = original;
                    btn.style.background = '#2563eb';
                }, 1500);
            });
        }

        // ========== עריכת לקוח גבייה ==========

        let editingDocId = null;

        async function openEditModal(docId) {
            editingDocId = docId;
            try {
                const doc = await db.collection('recurring_billing').doc(docId).get();
                if (!doc.exists) {
                    alert('הרשומה לא נמצאה');
                    return;
                }
                const d = doc.data();

                document.getElementById('editDocId').value = docId;
                document.getElementById('editClientName').value = d.clientName || '';
                document.getElementById('editPhone').value = d.phone || '';
                document.getElementById('editEmail').value = d.email || '';
                document.getElementById('editIdNumber').value = d.idNumber || '';
                document.getElementById('editAddress').value = d.address || '';
                document.getElementById('editAmount').value = d.recurringMonthlyAmount || '';
                document.getElementById('editMonths').value = d.recurringMonthsCount || '';
                document.getElementById('editStartDate').value = d.recurringStartDate || '';
                document.getElementById('editDayOfMonth').value = d.recurringDayOfMonth || '1';
                document.getElementById('editPaidMonths').value = d.paidMonthsAlready || '0';
                document.getElementById('editStatus').value = d.status || 'פעיל';
                document.getElementById('editAttorney').value = d.attorney || '';
                document.getElementById('editCaseNumber').value = d.caseNumber || '';
                document.getElementById('editNotes').value = d.recurringNotes || '';

                // Card fields
                document.getElementById('editCardNumber').value = '';
                document.getElementById('editCardCvv').value = '';
                document.getElementById('editCardExpiry').value = d.cardExpiry || '';
                document.getElementById('editCardHolder').value = d.cardHolder || '';
                document.getElementById('editCardType').value = d.cardType || '';
                document.getElementById('editCardStatus').textContent = d.cardLast4
                    ? 'כרטיס קיים: •••• ' + d.cardLast4 + (d.cardType ? ' (' + d.cardType + ')' : '')
                    : 'לא הוזן כרטיס';

                document.getElementById('editModalOverlay').classList.add('show');
            } catch (error) {
                console.error('Error loading client:', error);
                alert('שגיאה בטעינת הנתונים');
            }
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').classList.remove('show');
            editingDocId = null;
        }

        async function saveEditBilling() {
            const docId = document.getElementById('editDocId').value;
            const clientName = document.getElementById('editClientName').value.trim();
            const amount = document.getElementById('editAmount').value;
            const months = document.getElementById('editMonths').value;

            if (!clientName || !amount || !months) {
                alert('נא למלא שם לקוח, סכום ומספר חודשים');
                return;
            }

            const saveBtn = document.getElementById('editSaveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'שומר...';

            try {
                const updateData = {
                    clientName: clientName,
                    phone: document.getElementById('editPhone').value || '',
                    email: document.getElementById('editEmail').value || '',
                    idNumber: document.getElementById('editIdNumber').value || '',
                    address: document.getElementById('editAddress').value || '',
                    recurringMonthlyAmount: amount,
                    recurringMonthsCount: months,
                    recurringStartDate: document.getElementById('editStartDate').value || '',
                    recurringDayOfMonth: document.getElementById('editDayOfMonth').value || '1',
                    paidMonthsAlready: parseInt(document.getElementById('editPaidMonths').value) || 0,
                    status: document.getElementById('editStatus').value || 'פעיל',
                    attorney: document.getElementById('editAttorney').value || '',
                    caseNumber: document.getElementById('editCaseNumber').value || '',
                    recurringNotes: document.getElementById('editNotes').value || '',
                    cardExpiry: document.getElementById('editCardExpiry').value || '',
                    cardHolder: document.getElementById('editCardHolder').value || '',
                    cardType: document.getElementById('editCardType').value || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: authUser ? authUser.email : (currentUser || 'לא ידוע')
                };

                // הצפנת כרטיס חדש אם הוזן
                const newCardNumber = (document.getElementById('editCardNumber').value || '').replace(/\s/g, '');
                if (newCardNumber && newCardNumber.length >= 13) {
                    const passphrase = await requestPassword('encrypt');
                    if (!passphrase) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'שמור שינויים';
                        return;
                    }
                    updateData.cardEncrypted = encryptCardData(newCardNumber, passphrase);
                    updateData.cardLast4 = newCardNumber.slice(-4);
                    const newCvv = document.getElementById('editCardCvv').value || '';
                    if (newCvv) {
                        updateData.cvvEncrypted = encryptCardData(newCvv, passphrase);
                    }
                }

                await db.collection('recurring_billing').doc(docId).update(updateData);

                closeEditModal();
                loadBillingData(); // רענון התצוגה
            } catch (error) {
                console.error('Error saving edit:', error);
                alert('שגיאה בשמירה: ' + error.message);
            }

            saveBtn.disabled = false;
            saveBtn.textContent = 'שמור שינויים';
        }

        // Card number formatting in edit modal
        document.addEventListener('DOMContentLoaded', function() {
            var editCardInput = document.getElementById('editCardNumber');
            if (editCardInput) {
                editCardInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 16);
                    e.target.value = val.replace(/(\d{4})(?=\d)/g, '$1 ');
                });
            }
            var editExpiryInput = document.getElementById('editCardExpiry');
            if (editExpiryInput) {
                editExpiryInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 4);
                    if (val.length >= 3) val = val.substring(0, 2) + '/' + val.substring(2);
                    e.target.value = val;
                });
            }
        });

        // Initialize
        updateProgress();

        // ========== Bottom Navigation ==========
        function setActiveNav(id) {
            document.querySelectorAll('.bottom-nav-item').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function navHome() {
            hideBillingManagement();
            document.getElementById('mainContainer').style.display = '';
            document.getElementById('userSelection').classList.remove('hidden');
            document.getElementById('mainForm').classList.add('hidden');
            document.getElementById('successScreen').classList.remove('show');
            setActiveNav('navHomeBtn');
        }

        function navNewSale() {
            hideBillingManagement();
            document.getElementById('mainContainer').style.display = '';
            if (!currentUser) {
                document.getElementById('userSelection').classList.remove('hidden');
                document.getElementById('mainForm').classList.add('hidden');
            }
            setActiveNav('navNewSaleBtn');
        }

        function navAddBilling() {
            openBillingModal();
            setActiveNav('navAddBillingBtn');
        }

        function navBillingMgmt() {
            showBillingManagement();
            setActiveNav('navBillingMgmtBtn');
        }

        function navLogout() {
            handleLogout();
        }

        // Show/hide bottom nav based on auth state
        function updateBottomNav(show) {
            var nav = document.getElementById('bottomNav');
            if (nav) {
                nav.classList.toggle('bottom-nav-hidden', !show);
            }
        }

        // Hook into auth state
        var _origAuthCallback = null;
        var authUnsub = auth.onAuthStateChanged(function(user) {
            updateBottomNav(!!user);
        });
    </script>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav bottom-nav-hidden" id="bottomNav">
        <button class="bottom-nav-item active" id="navHomeBtn" onclick="navHome()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="bottom-nav-label">ראשי</span>
        </button>
        <button class="bottom-nav-item" id="navNewSaleBtn" onclick="navNewSale()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
            <span class="bottom-nav-label">טופס מכר</span>
        </button>
        <button class="bottom-nav-item" id="navAddBillingBtn" onclick="navAddBilling()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></svg>
            <span class="bottom-nav-label">הוספת גבייה</span>
        </button>
        <button class="bottom-nav-item" id="navBillingMgmtBtn" onclick="navBillingMgmt()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            <span class="bottom-nav-label">ניהול גבייה</span>
        </button>
        <button class="bottom-nav-item" onclick="navLogout()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            <span class="bottom-nav-label">התנתק</span>
        </button>
    </nav>
</body>
</html>
