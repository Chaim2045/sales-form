<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טופס מכר | משרד עו"ד גיא הרשקוביץ</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Environment Configuration -->
    <script src="env-config.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --primary-blue-hover: #1d4ed8;
            --light-blue: #eff6ff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --white: #ffffff;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--light-blue) 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
            padding-bottom: 72px;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }


        .logo-placeholder {
            width: 120px;
            height: 60px;
            background: var(--gray-200);
            border-radius: 8px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
            font-size: 12px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
        }

        .header p {
            color: var(--gray-500);
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .header p {
                font-size: 14px;
            }
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 40px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 8px;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gray-200);
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
            transform: translateY(-50%);
            z-index: 2;
            transition: width 0.4s ease;
        }

        .step-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            border: 2px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-400);
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }

        .step-indicator.active {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .step-indicator.completed {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: var(--white);
        }

        .step-labels {
            display: flex;
            justify-content: space-between;
        }

        .step-label {
            font-size: 12px;
            color: var(--gray-400);
            text-align: center;
            width: 70px;
            transition: color 0.3s ease;
        }

        .step-label.active {
            color: var(--primary-blue);
            font-weight: 500;
        }

        /* Form Card */
        .form-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 32px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .form-card {
                padding: 24px 20px;
                border-radius: 12px;
            }
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .step-title {
                font-size: 18px;
                margin-bottom: 20px;
            }
        }

        .step-title-icon {
            width: 32px;
            height: 32px;
            background: var(--light-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Form Elements */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.15s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--light-blue);
        }

        .autocomplete-item-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .autocomplete-item-details {
            font-size: 13px;
            color: var(--gray-500);
        }

        .autocomplete-no-results {
            padding: 16px;
            text-align: center;
            color: var(--gray-400);
            font-size: 14px;
        }

        .autocomplete-loading {
            padding: 16px;
            text-align: center;
            color: var(--primary-blue);
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 500px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        label .required {
            color: var(--error);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Heebo', sans-serif;
            color: var(--gray-800);
            transition: all 0.2s ease;
            background: var(--white);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input::placeholder, textarea::placeholder {
            color: var(--gray-400);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 20px;
            padding-left: 40px;
        }

        /* Radio & Checkbox Groups */
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-option, .checkbox-option {
            flex: 1;
            min-width: 120px;
        }

        .radio-option input, .checkbox-option input {
            display: none;
        }

        .radio-option label, .checkbox-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 400;
            text-align: center;
        }

        .radio-option input:checked + label,
        .checkbox-option input:checked + label {
            border-color: var(--primary-blue);
            background: var(--light-blue);
            color: var(--primary-blue);
            font-weight: 500;
        }

        .radio-option label:hover,
        .checkbox-option label:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        /* Conditional Fields */
        .conditional-field {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .conditional-field.show {
            display: block;
        }

        /* Buttons */
        .buttons-row {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-blue-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* User Selection */
        .user-selection {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 32px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .user-selection {
                padding: 24px 20px;
                border-radius: 12px;
            }
        }

        .user-selection h2 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .user-selection p {
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        @media (max-width: 500px) {
            .user-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }

        .user-btn {
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Heebo', sans-serif;
        }

        .user-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #60a5fa 100%);
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 600;
            font-size: 18px;
        }

        .user-name {
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Success Message */
        .success-screen {
            display: none;
            text-align: center;
            padding: 40px 20px;
            position: relative;
            overflow: hidden;
        }

        .success-screen.show {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border-radius: 50%;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
        }

        @keyframes successPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .success-icon svg {
            width: 50px;
            height: 50px;
            color: var(--white);
            stroke-width: 3;
        }

        .celebration-emoji {
            font-size: 48px;
            margin-bottom: 16px;
            animation: bounce 0.8s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .success-screen h2 {
            font-size: 28px;
            color: var(--gray-800);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .success-screen .subtitle {
            color: var(--success);
            margin-bottom: 24px;
            font-size: 16px;
            font-weight: 600;
        }

        .sale-summary {
            background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            text-align: right;
        }

        .sale-summary-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
            text-align: center;
        }

        .sale-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
        }

        .sale-detail:last-child {
            border-bottom: none;
        }

        .sale-detail-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        .sale-detail-value {
            color: var(--gray-800);
            font-weight: 600;
            font-size: 15px;
        }

        .sale-amount {
            background: var(--success);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            font-size: 24px;
            font-weight: 700;
        }

        /* Confetti Animation */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti:nth-child(1) { left: 10%; background: #ff6b6b; animation-delay: 0s; }
        .confetti:nth-child(2) { left: 20%; background: #4ecdc4; animation-delay: 0.2s; }
        .confetti:nth-child(3) { left: 30%; background: #ffe66d; animation-delay: 0.4s; }
        .confetti:nth-child(4) { left: 40%; background: #a8e6cf; animation-delay: 0.6s; }
        .confetti:nth-child(5) { left: 50%; background: #ff8b94; animation-delay: 0.8s; }
        .confetti:nth-child(6) { left: 60%; background: #b4e7ce; animation-delay: 1s; }
        .confetti:nth-child(7) { left: 70%; background: #ffd3b6; animation-delay: 1.2s; }
        .confetti:nth-child(8) { left: 80%; background: #dcedc1; animation-delay: 1.4s; }
        .confetti:nth-child(9) { left: 90%; background: #a8dadc; animation-delay: 1.6s; }
        .confetti:nth-child(10) { left: 95%; background: #e4c1f9; animation-delay: 1.8s; }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Amount Reminder */
        .amount-reminder {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border: 2px solid #fb923c;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
            color: var(--gray-800);
            animation: fadeIn 0.3s ease;
        }

        .amount-reminder strong {
            color: #ea580c;
            font-size: 18px;
        }

        /* Encouragement Messages */
        .encouragement-message {
            background: rgba(37, 99, 235, 0.05);
            border-left: 3px solid #2563eb;
            border-radius: 8px;
            padding: 14px 18px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            animation: slideInFromRight 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .encouragement-message svg {
            width: 22px;
            height: 22px;
            color: #2563eb;
            flex-shrink: 0;
        }

        @keyframes slideInFromRight {
            0% {
                transform: translateX(20px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .encouragement-message.hide {
            display: none;
        }

        /* Error State */
        .error-message {
            color: var(--error);
            font-size: 13px;
            margin-top: 4px;
        }

        input.error, select.error {
            border-color: var(--error);
        }

        /* VAT Display */
        .vat-display {
            background: var(--light-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 10px;
            padding: 16px;
            margin-top: 12px;
            display: none;
        }

        .vat-display.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .vat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .vat-row:last-child {
            margin-bottom: 0;
            font-weight: 600;
            font-size: 16px;
            padding-top: 8px;
            border-top: 1px solid var(--primary-blue);
        }

        .vat-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        .vat-value {
            color: var(--gray-800);
            font-weight: 500;
        }

        /* File Upload */
        .file-upload-container {
            border: 2px dashed var(--gray-300);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-container:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .file-upload-container.has-file {
            border-color: var(--success);
            background: #f0fdf4;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            opacity: 0.6;
        }

        .upload-text {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .upload-subtext {
            color: var(--gray-400);
            font-size: 12px;
        }

        .file-preview {
            margin-top: 12px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .file-name {
            color: var(--success);
            font-weight: 500;
            font-size: 14px;
        }

        /* Split Payment Rows */
        .split-payment-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 12px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 10px;
            border: 1px solid var(--gray-200);
        }

        @media (max-width: 500px) {
            .split-payment-row {
                grid-template-columns: 1fr;
            }
        }

        .split-payment-row .form-group {
            margin-bottom: 0;
        }

        .split-payment-remove {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--error);
            background: var(--white);
            color: var(--error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
        }

        .split-payment-remove:hover {
            background: var(--error);
            color: var(--white);
        }

        .split-payment-remove svg {
            width: 20px;
            height: 20px;
        }

        /* Split Payment Method Details */
        .split-method-details {
            grid-column: 1 / -1; /* Takes full width */
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-300);
        }

        .split-cc-details,
        .split-checks-details {
            background: var(--white);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .conditional-subfield {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--gray-300);
        }

        .split-row-header {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        @media (max-width: 500px) {
            .split-row-header {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .billing-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .billing-modal-overlay.show {
            display: flex;
        }
        .billing-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .billing-modal-header {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .billing-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }
        .billing-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
        }
        .billing-modal-close:hover { opacity: 1; }
        .billing-modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .billing-modal-body .form-group {
            margin-bottom: 16px;
        }
        .billing-modal-body label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: #374151;
        }
        .billing-modal-body input,
        .billing-modal-body select,
        .billing-modal-body textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .billing-modal-body input:focus,
        .billing-modal-body select:focus,
        .billing-modal-body textarea:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245,158,11,0.1);
        }
        .billing-modal-body .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .billing-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .billing-modal-footer button {
            padding: 10px 24px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }
        .billing-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }
        .billing-btn-cancel:hover { background: #e5e7eb; }
        .billing-btn-submit {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .billing-btn-submit:hover { background: linear-gradient(135deg, #059669, #047857); }
        .billing-btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .billing-search-container {
            position: relative;
        }
        .billing-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .billing-autocomplete.show { display: block; }
        .billing-autocomplete-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }
        .billing-autocomplete-item:hover { background: #fef3c7; }
        .billing-autocomplete-item:last-child { border-bottom: none; }
        .billing-autocomplete-name { font-weight: 600; font-size: 14px; }
        .billing-autocomplete-details { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .billing-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            background: #fef3c7;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 16px 0 12px;
        }
        .billing-success-msg {
            text-align: center;
            padding: 24px;
        }
        .billing-success-msg .check-icon {
            width: 50px; height: 50px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            color: white;
            font-size: 24px;
        }

        /* ========== Billing Management View ========== */
        #billingManagement {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px 0;
        }
        #billingManagement.active { display: block; }

        .bm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .bm-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 0;
        }
        .bm-back-btn {
            background: none;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .bm-back-btn:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }
        .bm-sync-btn {
            background: none;
            border: 1px solid var(--primary-blue);
            color: var(--primary-blue);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .bm-sync-btn:hover {
            background: var(--primary-blue);
            color: white;
        }
        .bm-sync-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bm-sync-btn.syncing svg {
            animation: spin 1s linear infinite;
        }

        /* Summary Cards */
        .bm-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        @media (max-width: 768px) {
            .bm-summary { grid-template-columns: repeat(2, 1fr); }
        }
        .bm-stat {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .bm-stat-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--gray-800);
            line-height: 1.2;
        }
        .bm-stat-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }
        .bm-stat.blue .bm-stat-value { color: var(--primary-blue); }
        .bm-stat.green .bm-stat-value { color: var(--success); }
        .bm-stat.red .bm-stat-value { color: var(--error); }

        /* Toolbar: Filter + View Toggle + Search */
        .bm-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }
        .bm-search {
            flex: 1;
            min-width: 180px;
            max-width: 280px;
            padding: 8px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            background: var(--white);
            transition: border-color 0.2s;
        }
        .bm-search:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .bm-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .bm-filter-btn {
            padding: 6px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            background: var(--white);
            font-family: 'Heebo', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
        }
        .bm-filter-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        .bm-filter-btn.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }
        .bm-view-toggle {
            display: flex;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            overflow: hidden;
        }
        .bm-view-btn {
            padding: 6px 12px;
            border: none;
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
            transition: all 0.2s;
        }
        .bm-view-btn:not(:last-child) { border-left: 1px solid var(--gray-300); }
        .bm-view-btn.active {
            background: var(--primary-blue);
            color: var(--white);
        }

        /* Table View */
        .bm-table-wrap {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: var(--white);
        }
        .bm-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: auto;
        }
        .bm-table th {
            background: var(--gray-50);
            padding: 10px 10px;
            text-align: right;
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
            font-size: 11px;
        }
        .bm-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--gray-700);
            vertical-align: middle;
            font-size: 13px;
        }
        .bm-table tr:last-child td { border-bottom: none; }
        .bm-table tr:hover td { background: #f8fafc; }
        @media (min-width: 1024px) {
            .bm-table-wrap { overflow-x: visible; }
        }

        .bm-amount {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        .bm-progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }
        .bm-progress-fill {
            height: 100%;
            border-radius: 4px;
            background: #0f172a;
            transition: width 0.3s;
        }
        .bm-progress-fill.high { background: #16a34a; }
        .bm-progress-text {
            font-size: 13px;
            font-weight: 700;
            color: #0f172a;
        }
        .bm-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.6;
        }
        .bm-badge.active { background: #dbeafe; color: #1d4ed8; }
        .bm-badge.completed { background: #d1fae5; color: #065f46; }
        .bm-badge.paused { background: #fef3c7; color: #92400e; }
        .bm-badge.cancelled { background: #f1f5f9; color: #64748b; }
        /* כפתורי פעולה בטבלה */
        .bm-action-primary {
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 12px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .bm-action-primary:hover { background: #1e293b; }
        .bm-action-secondary {
            background: none;
            border: 1px solid #e2e8f0;
            color: #475569;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        .bm-action-secondary:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .bm-actions-dropdown {
            position: relative;
            display: inline-block;
        }
        .bm-actions-toggle {
            background: none;
            border: 1px solid #e2e8f0;
            color: #64748b;
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
            transition: all 0.2s;
        }
        .bm-actions-toggle:hover { background: #f1f5f9; }
        .bm-actions-menu {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(15,23,42,0.12);
            z-index: 100;
            min-width: 150px;
            padding: 4px;
        }
        .bm-actions-menu.show { display: block; }
        .bm-actions-menu a,
        .bm-actions-menu button {
            display: block;
            width: 100%;
            text-align: right;
            padding: 8px 12px;
            border: none;
            background: none;
            color: #334155;
            font-size: 12px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            border-radius: 6px;
            text-decoration: none;
            transition: background 0.15s;
        }
        .bm-actions-menu a:hover,
        .bm-actions-menu button:hover { background: #f1f5f9; }

        /* Cards View */
        .bm-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 14px;
        }
        .bm-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 18px;
            transition: box-shadow 0.2s;
        }
        .bm-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        .bm-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }
        .bm-card-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0 0 2px;
        }
        .bm-card-case {
            font-size: 12px;
            color: var(--gray-400);
        }
        .bm-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .bm-card-field {
            font-size: 12px;
        }
        .bm-card-field-label {
            color: var(--gray-400);
            margin-bottom: 2px;
        }
        .bm-card-field-value {
            font-weight: 600;
            color: var(--gray-700);
        }
        .bm-card-progress {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 14px;
        }
        .bm-card-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #0f172a;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .bm-card-progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .bm-card-progress-fill {
            height: 100%;
            border-radius: 4px;
            background: #0f172a;
            transition: width 0.3s;
        }
        .bm-card-progress-fill.high { background: #16a34a; }

        /* Empty State */
        .bm-empty {
            text-align: center;
            padding: 48px 24px;
            color: var(--gray-400);
        }
        .bm-empty svg {
            margin-bottom: 12px;
            opacity: 0.4;
        }
        .bm-empty p {
            font-size: 14px;
        }

        /* Loading */
        .bm-loading {
            text-align: center;
            padding: 40px;
            color: var(--gray-400);
            font-size: 14px;
        }
        .bm-loading-spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        .bm-footer {
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid var(--gray-200);
            text-align: center;
        }
        .bm-footer p {
            font-size: 12px;
            color: var(--gray-400);
            margin: 0;
            letter-spacing: 0.3px;
        }

        /* ========== Invoices Management View ========== */
        #invoicesManagement {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px 0;
        }
        #invoicesManagement.active { display: block; }

        .inv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .inv-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
        }
        .inv-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .inv-new-btn {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            transition: transform 0.15s;
        }
        .inv-new-btn:hover { transform: scale(1.03); }
        .inv-back-btn {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
        }

        .inv-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }
        .inv-stat {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .inv-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }
        .inv-stat-label {
            font-size: 12px;
            color: var(--gray-400);
            margin-top: 2px;
        }

        .inv-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .inv-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Heebo', sans-serif;
        }
        .inv-month-filter {
            padding: 10px 14px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Heebo', sans-serif;
            background: var(--white);
        }

        .inv-table-wrap {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: var(--white);
            margin-bottom: 24px;
        }
        .inv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .inv-table th {
            background: var(--gray-50);
            padding: 10px 12px;
            text-align: right;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
        }
        .inv-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            color: var(--gray-700);
        }
        .inv-table tr:hover td { background: #f8fafc; }

        .inv-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .inv-badge.draft { background: #fef3c7; color: #92400e; }
        .inv-badge.sent { background: #dbeafe; color: #1d4ed8; }
        .inv-badge.paid { background: #d1fae5; color: #065f46; }

        .inv-action-btn {
            padding: 4px 8px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            background: var(--white);
            color: var(--gray-600);
            transition: background 0.15s;
        }
        .inv-action-btn:hover { background: var(--gray-50); }
        .inv-action-btn.primary { background: #0f172a; color: #fff; border-color: #0f172a; }
        .inv-action-btn.primary:hover { background: #1e293b; }
        .inv-action-btn.whatsapp { background: #25d366; color: #fff; border-color: #25d366; }
        .inv-action-btn.whatsapp:hover { background: #20bd5a; }
        .inv-action-btn.danger { color: #ef4444; border-color: #fecaca; }
        .inv-action-btn.danger:hover { background: #fef2f2; }

        .inv-footer {
            text-align: center;
            padding: 20px;
            color: var(--gray-400);
            font-size: 12px;
        }

        /* Invoice Create Modal */
        .inv-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .inv-modal-overlay.show { display: flex; }
        .inv-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .inv-modal-header {
            background: linear-gradient(135deg, #0f172a, #334155);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inv-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }
        .inv-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .inv-modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .inv-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .inv-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #1d4ed8;
            background: #dbeafe;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 16px 0 12px;
        }

        .inv-line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 13px;
        }
        .inv-line-items-table th {
            background: #f8fafc;
            padding: 8px 10px;
            text-align: right;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }
        .inv-line-items-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        .inv-line-items-table input,
        .inv-line-items-table textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Heebo', sans-serif;
            box-sizing: border-box;
        }
        .inv-line-items-table .inv-line-total {
            font-weight: 700;
            color: #0f172a;
            text-align: center;
            min-width: 80px;
        }
        .inv-remove-line {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 6px;
        }
        .inv-add-line-btn {
            background: var(--gray-50);
            border: 1px dashed var(--gray-300);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: 'Heebo', sans-serif;
            color: var(--gray-500);
            width: 100%;
            margin-top: 8px;
        }
        .inv-add-line-btn:hover { background: var(--gray-100); }

        .inv-totals {
            margin-top: 16px;
            border-top: 2px solid var(--gray-200);
            padding-top: 12px;
        }
        .inv-totals-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 14px;
        }
        .inv-totals-row.grand {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            border-top: 2px solid #0f172a;
            padding-top: 8px;
            margin-top: 4px;
        }

        /* Invoice PDF Preview (hidden, used for html2canvas) */
        .inv-pdf-preview {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 794px;
            background: white;
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            padding: 40px;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .inv-toolbar { flex-direction: column; }
            .inv-search { min-width: 100%; }
            .inv-table { font-size: 11px; }
            .inv-table td, .inv-table th { padding: 8px 6px; }
            .inv-modal { margin: 10px; }
            .inv-modal-body { padding: 16px; }
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: center;
            gap: 0;
            padding: 0;
            z-index: 100;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
        }
        .bottom-nav-item {
            flex: 1;
            max-width: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 8px 12px;
            border: none;
            background: none;
            color: var(--gray-400);
            font-family: 'Heebo', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .bottom-nav-item:hover {
            color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.04);
        }
        .bottom-nav-item.active {
            color: var(--primary-blue);
        }
        .bottom-nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--primary-blue);
            border-radius: 0 0 3px 3px;
        }
        .bottom-nav-item svg {
            width: 22px;
            height: 22px;
        }
        .bottom-nav-label {
            white-space: nowrap;
        }
        .bottom-nav-hidden {
            display: none;
        }
        @media (min-width: 768px) {
            .bottom-nav {
                gap: 8px;
            }
            .bottom-nav-item {
                font-size: 12px;
                padding: 12px 12px 14px;
            }
        }

        /* Login Screen */
        #loginScreen {
            max-width: 380px;
            margin: 80px auto;
            padding: 0 20px;
            text-align: center;
        }
        .login-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 32px 28px;
        }
        .login-card h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        .login-card p {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 24px;
        }
        .login-card .form-group {
            text-align: right;
            margin-bottom: 14px;
        }
        .login-card label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 4px;
        }
        .login-card input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .login-card input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .login-btn:hover { background: var(--primary-blue-hover); }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .login-error {
            color: var(--error);
            font-size: 13px;
            margin-top: 10px;
            min-height: 20px;
        }

        /* Edit Modal */
        .edit-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .edit-modal-overlay.show { display: flex; }
        .edit-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 520px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .edit-modal-header {
            background: var(--primary-blue);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .edit-modal-header h3 { margin: 0; font-size: 18px; }
        .edit-modal-close {
            background: none; border: none; color: white;
            font-size: 24px; cursor: pointer; padding: 0; line-height: 1; opacity: 0.8;
        }
        .edit-modal-close:hover { opacity: 1; }
        .edit-modal-body {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .edit-modal-body .form-group { margin-bottom: 16px; }
        .edit-modal-body label {
            display: block; margin-bottom: 6px;
            font-weight: 500; font-size: 14px; color: #374151;
        }
        .edit-modal-body input,
        .edit-modal-body select,
        .edit-modal-body textarea {
            width: 100%; padding: 10px 14px;
            border: 1px solid #d1d5db; border-radius: 8px;
            font-family: 'Heebo', sans-serif; font-size: 14px;
            box-sizing: border-box; transition: border-color 0.2s;
        }
        .edit-modal-body input:focus,
        .edit-modal-body select:focus,
        .edit-modal-body textarea:focus {
            outline: none; border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .edit-modal-body .form-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        .edit-modal-footer {
            padding: 16px 24px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 12px; justify-content: flex-end;
        }
        .edit-modal-footer button {
            padding: 10px 24px; border-radius: 8px;
            font-family: 'Heebo', sans-serif; font-size: 14px;
            font-weight: 600; cursor: pointer; border: none; transition: background 0.2s;
        }
        .edit-btn-cancel { background: #f3f4f6; color: #374151; }
        .edit-btn-cancel:hover { background: #e5e7eb; }
        .edit-btn-save { background: var(--primary-blue); color: white; }
        .edit-btn-save:hover { background: var(--primary-blue-hover); }
        .edit-btn-save:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Payment Details Modal */
        .pm-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15,23,42,0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1600;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        .pm-overlay.show { display: flex; }
        .pm-modal {
            background: #ffffff;
            border-radius: 14px;
            width: 100%;
            max-width: 740px;
            margin: 20px auto;
            box-shadow: 0 25px 60px rgba(15,23,42,0.25), 0 0 0 1px rgba(15,23,42,0.06);
            animation: modalSlideIn 0.3s ease;
            overflow: hidden;
        }
        .pm-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 22px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pm-header h3 {
            margin: 0;
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.2px;
        }
        .pm-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: rgba(255,255,255,0.7);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .pm-close:hover { background: rgba(255,255,255,0.2); color: white; }
        .pm-body {
            padding: 24px 28px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .pm-client-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }
        .pm-summary-item {
            text-align: center;
            padding: 14px 10px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .pm-summary-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .pm-summary-value {
            font-size: 17px;
            font-weight: 800;
            color: #0f172a;
        }
        .pm-list-header {
            display: grid;
            grid-template-columns: 36px 1fr 100px 100px 110px;
            gap: 10px;
            padding: 10px 16px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            font-weight: 700;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 4px;
        }
        .pm-payment-row {
            display: grid;
            grid-template-columns: 36px 1fr 100px 100px 110px;
            gap: 10px;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.15s;
        }
        .pm-payment-row:last-child { border-bottom: none; }
        .pm-payment-row:hover { background: #f8fafc; }
        .pm-payment-row.completed { background: #f0fdf4; }
        .pm-payment-row.overdue { background: #fef2f2; }
        .pm-payment-row.cancelled { background: #f9fafb; opacity: 0.5; }
        .pm-month-num {
            width: 30px; height: 30px;
            border-radius: 8px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: #475569;
        }
        .pm-payment-row.completed .pm-month-num {
            background: #0f172a;
            color: white;
        }
        .pm-payment-row.overdue .pm-month-num {
            background: #dc2626;
            color: white;
        }
        .pm-amount-input {
            width: 88px;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            text-align: center;
            direction: ltr;
            background: #fff;
            transition: border-color 0.2s;
        }
        .pm-amount-input:focus {
            outline: none;
            border-color: #0f172a;
            box-shadow: 0 0 0 3px rgba(15,23,42,0.08);
        }
        .pm-mark-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            font-family: 'Heebo', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pm-mark-btn.mark-done {
            background: #0f172a;
            color: white;
        }
        .pm-mark-btn.mark-done:hover {
            background: #1e293b;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(15,23,42,0.2);
        }
        .pm-mark-btn.already-done {
            background: #f0fdf4;
            color: #16a34a;
            cursor: default;
            font-size: 11px;
            border: 1px solid #bbf7d0;
        }
        .pm-footer {
            padding: 18px 28px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }
        .pm-footer-btn {
            background: none;
            border: 1px solid #e2e8f0;
            color: #475569;
            border-radius: 8px;
            padding: 8px 16px;
            font-family: 'Heebo', sans-serif;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .pm-footer-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .pm-footer-btn.danger { border-color: #fecaca; color: #dc2626; }
        .pm-footer-btn.danger:hover { background: #fef2f2; }
        .pm-footer-btn.primary {
            background: #0f172a;
            color: white;
            border-color: #0f172a;
        }
        .pm-footer-btn.primary:hover { background: #1e293b; }
        .pm-footer-btn.primary:disabled { opacity: 0.4; cursor: not-allowed; }
        .pm-accounting {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .pm-accounting-title {
            font-weight: 700;
            font-size: 14px;
            color: #0f172a;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .pm-accounting-row {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            font-size: 13px;
            color: #475569;
        }
        .pm-accounting-row.total {
            border-top: 2px solid #0f172a;
            margin-top: 10px;
            padding-top: 12px;
            font-weight: 700;
            font-size: 14px;
            color: #0f172a;
        }
        .bm-quick-mark {
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .bm-quick-mark:hover { background: #1e293b; }
        .bm-quick-mark:disabled { opacity: 0.4; cursor: not-allowed; }
        .bm-payments-btn {
            background: none;
            border: 1px solid #cbd5e1;
            color: #475569;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            font-family: 'Heebo', sans-serif;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .bm-payments-btn:hover { background: #0f172a; color: white; border-color: #0f172a; }
        @media (max-width: 600px) {
            .pm-client-summary { grid-template-columns: repeat(2, 1fr); }
            .pm-list-header,
            .pm-payment-row { grid-template-columns: 32px 1fr 80px 90px; }
            .pm-list-header .pm-date-col,
            .pm-payment-row .pm-date-col { display: none; }
            .pm-header { padding: 18px 20px; }
            .pm-body { padding: 18px 20px; }
            .pm-footer { padding: 14px 20px; flex-wrap: wrap; }
        }

        /* Password Popup */
        .pw-popup-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.55);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .pw-popup-overlay.show { display: flex; }
        .pw-popup {
            background: var(--white);
            border-radius: 16px;
            width: 90%;
            max-width: 380px;
            padding: 32px 28px 24px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .pw-popup-icon {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, #dbeafe, #eff6ff);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 16px;
        }
        .pw-popup h3 {
            font-size: 18px; font-weight: 700;
            color: var(--gray-800); margin: 0 0 6px;
        }
        .pw-popup .pw-desc {
            font-size: 13px; color: var(--gray-500);
            margin-bottom: 18px; line-height: 1.6;
        }
        .pw-popup .pw-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            color: #991b1b;
            margin-bottom: 18px;
            text-align: right;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .pw-popup input[type="password"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 15px;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 14px;
            transition: border-color 0.2s;
        }
        .pw-popup input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .pw-popup-buttons {
            display: flex; gap: 10px;
        }
        .pw-popup-buttons button {
            flex: 1; padding: 10px;
            border-radius: 8px; font-family: 'Heebo', sans-serif;
            font-size: 14px; font-weight: 600;
            cursor: pointer; border: none; transition: background 0.2s;
        }
        .pw-popup-cancel {
            background: var(--gray-100); color: var(--gray-600);
        }
        .pw-popup-cancel:hover { background: var(--gray-200); }
        .pw-popup-confirm {
            background: var(--primary-blue); color: white;
        }
        .pw-popup-confirm:hover { background: var(--primary-blue-hover); }
        .pw-popup-error {
            color: var(--error); font-size: 12px;
            margin-top: 8px; min-height: 16px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <img src="‏‏logo - עותק.png" alt="לוגו" style="max-width: 140px; height: auto; margin-bottom: 16px;">
            <h2>כניסה למערכת</h2>
            <p>משרד עו"ד גיא הרשקוביץ ושות'</p>
            <div class="form-group">
                <label>מייל</label>
                <input type="email" id="loginEmail" placeholder="email@example.com" dir="ltr" style="text-align: left;">
            </div>
            <div class="form-group">
                <label>סיסמה</label>
                <input type="password" id="loginPassword" placeholder="הזן סיסמה">
            </div>
            <button class="login-btn" id="loginBtn" onclick="handleLogin()">כניסה</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <div id="mainContainer" class="container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <img src="‏‏logo - עותק.png" alt="לוגו משרד עו"ד גיא הרשקוביץ" style="max-width: 200px; max-height: 80px; width: auto; height: auto; margin-bottom: 10px; object-fit: contain;">
            <h1>טופס מכר</h1>
            <p>משרד עו"ד גיא הרשקוביץ ושות'</p>
        </div>

        <!-- User Selection Screen -->
        <div id="userSelection" class="user-selection">
            <h2>שלום! מי מזין את הטופס?</h2>
            <p>בחר/י את שמך להמשך</p>
            <div class="user-grid">
                <button class="user-btn" onclick="selectUser('גיא הרשקוביץ')">
                    <div class="user-avatar">ג</div>
                    <div class="user-name">גיא</div>
                </button>
                <button class="user-btn" onclick="selectUser('מירי טל')">
                    <div class="user-avatar">מ</div>
                    <div class="user-name">מירי</div>
                </button>
                <button class="user-btn" onclick="selectUser('רועי הרשקוביץ')">
                    <div class="user-avatar">ר</div>
                    <div class="user-name">רועי</div>
                </button>
                <button class="user-btn" onclick="selectUser('אורי שטיינברג')">
                    <div class="user-avatar">א</div>
                    <div class="user-name">אורי</div>
                </button>
                <button class="user-btn" onclick="selectUser('חיים')">
                    <div class="user-avatar">ח</div>
                    <div class="user-name">חיים</div>
                </button>
            </div>
        </div>

        <!-- Main Form -->
        <div id="mainForm" class="hidden">
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-steps">
                    <div class="progress-line" id="progressLine"></div>
                    <div class="step-indicator active" data-step="1">1</div>
                    <div class="step-indicator" data-step="2">2</div>
                    <div class="step-indicator" data-step="3">3</div>
                    <div class="step-indicator" data-step="4">4</div>
                </div>
                <div class="step-labels">
                    <span class="step-label active">פרטי לקוח</span>
                    <span class="step-label">העסקה</span>
                    <span class="step-label">תשלום</span>
                    <span class="step-label">סיכום</span>
                </div>
            </div>

            <form id="salesForm">
                <!-- Step 1: Client Details -->
                <div class="form-card form-step active" data-step="1">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </span>
                        פרטי הלקוח
                    </h3>

                    <div class="form-group">
                        <label>שם הלקוח <span class="required">*</span></label>
                        <input type="text" id="clientName" placeholder="שם מלא / שם החברה" required autocomplete="off">
                        <div id="clientAutocomplete" class="autocomplete-dropdown"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>טלפון <span class="required">*</span></label>
                            <input type="text" id="phone" placeholder="050-0000000 או +972-50-0000000" required style="direction: ltr; text-align: right;">
                        </div>
                        <div class="form-group">
                            <label>ת.ז / ח.פ <span class="required">*</span></label>
                            <input type="text" id="idNumber" placeholder="מספר זהות או ח.פ" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>מייל <span class="required">*</span></label>
                        <input type="email" id="email" placeholder="email@example.com" required>
                    </div>

                    <div class="form-group">
                        <label>כתובת</label>
                        <input type="text" id="address" placeholder="רחוב, עיר (אופציונלי)">
                    </div>

                    <div class="form-group">
                        <label>סטטוס לקוח</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="newClient" name="clientStatus" value="חדש" checked>
                                <label for="newClient">לקוח חדש</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="existingClient" name="clientStatus" value="קיים">
                                <label for="existingClient">לקוח קיים</label>
                            </div>
                        </div>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            המשך
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Transaction Details -->
                <div class="form-card form-step" data-step="2">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                        </span>
                        פרטי העסקה
                    </h3>

                    <div class="form-group">
                        <label>סוג העסקה <span class="required">*</span></label>
                        <select id="transactionType" required>
                            <option value="">בחר סוג עסקה</option>
                            <option value="פגישת ייעוץ">פגישת ייעוץ</option>
                            <option value="ריטיינר">ריטיינר</option>
                            <option value="תוכנית שעות">תוכנית שעות</option>
                            <option value="הליך משפטי - תקרת שעות">הליך משפטי - תקרת שעות</option>
                            <option value="הליך משפטי - פיקס">הליך משפטי - פיקס</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>

                    <!-- Conditional: Hours Package Fields -->
                    <div id="hoursPackageFields" class="conditional-field">
                        <div class="form-row">
                            <div class="form-group">
                                <label>כמות שעות <span class="required">*</span></label>
                                <input type="number" id="hoursQuantity" placeholder="מספר שעות" min="1" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>מחיר לשעה (לפני מע"מ) <span class="required">*</span></label>
                                <input type="number" id="hourlyRate" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="transactionDescriptionGroup">
                        <label>תיאור העסקה <span class="required">*</span></label>
                        <textarea id="transactionDescription" placeholder="תאר את העסקה בקצרה..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>סכום (לפני מע"מ) <span class="required">*</span></label>
                        <input type="number" id="amount" placeholder="0" min="0" step="any">
                    </div>

                    <!-- VAT Calculation Display -->
                    <div id="vatDisplay" class="vat-display">
                        <div class="vat-row">
                            <span class="vat-label">סכום לפני מע"מ:</span>
                            <span class="vat-value" id="amountBeforeVat">₪0</span>
                        </div>
                        <div class="vat-row">
                            <span class="vat-label">מע"מ (18%):</span>
                            <span class="vat-value" id="vatAmount">₪0</span>
                        </div>
                        <div class="vat-row">
                            <span class="vat-label">סכום כולל מע"מ:</span>
                            <span class="vat-value" id="amountWithVat">₪0</span>
                        </div>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                            חזור
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            המשך
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Payment -->
                <div class="form-card form-step" data-step="3">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                        </span>
                        פרטי תשלום
                    </h3>

                    <div class="form-group">
                        <label>אמצעי תשלום <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="creditCard" name="paymentMethod" value="כרטיס אשראי" required>
                                <label for="creditCard">אשראי</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bankTransfer" name="paymentMethod" value="העברה בנקאית">
                                <label for="bankTransfer">העברה</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="cash" name="paymentMethod" value="מזומן">
                                <label for="cash">מזומן</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="bit" name="paymentMethod" value="ביט">
                                <label for="bit">ביט</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="checks" name="paymentMethod" value="שיקים דחויים">
                                <label for="checks">שיקים</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="splitPayment" name="paymentMethod" value="פיצול תשלום">
                                <label for="splitPayment">פיצול תשלום</label>
                            </div>
                        </div>
                    </div>

                    <!-- Encouragement Message (appears after payment method selection) -->
                    <div id="encouragementMessage" class="encouragement-message hide"></div>

                    <!-- Split Payment Details (conditional) -->
                    <div id="splitPaymentDetails" class="conditional-field">
                        <!-- Amount Reminder -->
                        <div class="amount-reminder">
                            💰 סכום העסקה: <strong id="splitAmountReminder">₪0</strong> (כולל מע"מ)
                        </div>

                        <div style="background: var(--light-blue); border: 2px solid var(--primary-blue); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--gray-800);">פרט את אמצעי התשלום:</div>
                            <div style="font-size: 13px; color: var(--gray-600);">הוסף כל אמצעי תשלום והסכום שלו</div>
                        </div>

                        <div id="splitPaymentRows">
                            <!-- Split payment rows will be added here dynamically -->
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="addSplitPaymentRow()" style="margin-bottom: 16px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            הוסף אמצעי תשלום
                        </button>

                        <div id="splitPaymentSummary" class="vat-display" style="display: none;">
                            <div class="vat-row">
                                <span class="vat-label">סכום כולל שהוזן:</span>
                                <span class="vat-value" id="splitTotalEntered">₪0</span>
                            </div>
                            <div class="vat-row">
                                <span class="vat-label">סכום נותר:</span>
                                <span class="vat-value" id="splitRemaining" style="color: var(--error); font-weight: 700;">₪0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Card Confirmation (conditional) -->
                    <div id="creditCardConfirmation" class="conditional-field">
                        <!-- Amount Reminder -->
                        <div class="amount-reminder">
                            💰 סכום העסקה: <strong id="ccAmountReminder">₪0</strong> (כולל מע"מ)
                        </div>

                        <div class="form-group">
                            <label>סטטוס החיוב באשראי <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="ccCharged" name="creditCardStatus" value="בוצע חיוב מלא">
                                    <label for="ccCharged">בוצע חיוב מלא</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ccMonthly" name="creditCardStatus" value="חיוב חודשי">
                                    <label for="ccMonthly">חיוב חודשי</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ccDeposit" name="creditCardStatus" value="פיקדון">
                                    <label for="ccDeposit">פיקדון</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="ccTemporary" name="creditCardStatus" value="אשראי זמני - יוחלף">
                                    <label for="ccTemporary">אשראי זמני - יוחלף</label>
                                </div>
                            </div>
                        </div>

                        <!-- Full Charge Details (conditional) -->
                        <div id="fullChargeDetails" class="conditional-field">
                            <div class="form-group">
                                <label>מספר תשלומים <span class="required">*</span></label>
                                <input type="number" id="paymentsCount" placeholder="כמה תשלומים?" min="1" max="36">
                            </div>
                        </div>

                        <!-- Monthly Charge Details (conditional) -->
                        <div id="monthlyChargeDetails" class="conditional-field">
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #92400e;">
                                    הגדרת חיוב חודשי קבוע
                                </div>
                                <div style="font-size: 13px; color: #78350f;">
                                    המערכת תשלח תזכורות אוטומטיות יום לפני כל חיוב
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>סכום חיוב חודשי (כולל מע"מ) <span class="required">*</span></label>
                                    <input type="number" id="recurringMonthlyAmount" placeholder="0" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>מספר חודשים <span class="required">*</span></label>
                                    <input type="number" id="recurringMonthsCount" placeholder="כמה חודשים?" min="1" max="60">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>תאריך חיוב ראשון <span class="required">*</span></label>
                                    <input type="date" id="recurringStartDate">
                                </div>
                                <div class="form-group">
                                    <label>יום בחודש לחיוב</label>
                                    <input type="number" id="recurringDayOfMonth" placeholder="לדוגמה: 1, 15" min="1" max="28" value="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>הערות לגבייה</label>
                                <textarea id="recurringNotes" placeholder="הערות נוספות לגבי החיוב החודשי..."></textarea>
                            </div>
                        </div>

                        <!-- Deposit Details (conditional) -->
                        <div id="depositDetails" class="conditional-field">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>סכום חודשי לחיוב <span class="required">*</span></label>
                                    <input type="number" id="monthlyCharge" placeholder="0" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>מספר חודשים</label>
                                    <input type="number" id="monthsCount" placeholder="כמה חודשים?" min="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>פרטים נוספים על הפיקדון</label>
                                <textarea id="depositDetailsText" placeholder="תאריך תחילת חיוב, הערות..."></textarea>
                            </div>
                        </div>

                        <!-- Temporary Credit Card - Replacement Details (conditional) -->
                        <div id="temporaryCreditDetails" class="conditional-field">
                            <div class="form-group">
                                <label>פרטי החלפה <span class="required">*</span></label>
                                <textarea id="temporaryCreditText" placeholder="לדוגמה: יוחלף לצ'קים ב-01/03/2025, יוחלף להעברה בנקאית..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Checks Details (conditional) -->
                    <div id="checksDetails" class="conditional-field">
                        <!-- Amount Reminder -->
                        <div class="amount-reminder">
                            💰 סכום העסקה: <strong id="checksAmountReminder">₪0</strong> (כולל מע"מ)
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>מספר שיקים <span class="required">*</span></label>
                                <input type="number" id="checksCount" placeholder="כמה שיקים?" min="1">
                            </div>
                            <div class="form-group">
                                <label>סכום כולל <span class="required">*</span></label>
                                <input type="number" id="checksTotalAmount" placeholder="0" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>צילום שיקים <span class="required">*</span></label>
                            <div class="file-upload-container" id="checksUploadContainer" onclick="document.getElementById('checksPhoto').click()">
                                <input type="file" id="checksPhoto" accept="image/*,application/pdf" style="display: none;">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                </div>
                                <div class="upload-text">לחץ לצילום או בחירת תמונה</div>
                                <div class="upload-subtext">תמונה ברורה של השיקים</div>
                            </div>
                            <div class="file-preview" id="checksPreview">
                                <div class="file-name" id="checksFileName"></div>
                                <img id="checksImage" alt="צילום שיקים">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>פירוט שיקים</label>
                            <div id="checksDetailsContainer"></div>
                        </div>

                        <div class="form-group">
                            <label>הערות נוספות על השיקים (אופציונלי)</label>
                            <textarea id="checksDetailsText" placeholder="הערות נוספות..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>האם השיק יוחלף באמצעי תשלום אחר?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="checkWillChange" name="checkWillChange" value="כן">
                                    <label for="checkWillChange">כן</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="checkWillNotChange" name="checkWillChange" value="לא" checked>
                                    <label for="checkWillNotChange">לא</label>
                                </div>
                            </div>
                        </div>

                        <!-- Check Replacement Details (conditional) -->
                        <div id="checkReplacementDetails" class="form-group conditional-field">
                            <label>פרט את אמצעי התשלום החלופי <span class="required">*</span></label>
                            <textarea id="checkReplacementText" placeholder="לדוגמה: יוחלף בכרטיס אשראי ב-15/02/2025, העברה בנקאית וכו..."></textarea>
                        </div>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                            חזור
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            המשך
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Summary & Submit -->
                <div class="form-card form-step" data-step="4">
                    <h3 class="step-title">
                        <span class="step-title-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </span>
                        פרטים נוספים וסיכום
                    </h3>

                    <div class="form-group">
                        <label>עו"ד מטפל <span class="required">*</span></label>
                        <select id="attorney" required>
                            <option value="">בחר עו"ד</option>
                            <option value="גיא הרשקוביץ">גיא הרשקוביץ</option>
                            <option value="מירי טל">מירי טל</option>
                            <option value="רועי הרשקוביץ">רועי הרשקוביץ</option>
                            <option value="אורי שטיינברג">אורי שטיינברג</option>
                            <option value="חיים">חיים</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>מספר תיק בעודכנית</label>
                            <input type="text" id="caseNumber" placeholder="אם ידוע">
                        </div>
                        <div class="form-group">
                            <label>סניף</label>
                            <select id="branch">
                                <option value="תל אביב" selected>תל אביב</option>
                                <option value="רחובות">רחובות</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>הערות</label>
                        <textarea id="notes" placeholder="הערות נוספות (אופציונלי)"></textarea>
                    </div>

                    <div class="buttons-row">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                            חזור
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span id="submitText">שלח טופס</span>
                            <div class="spinner hidden" id="submitSpinner"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="form-card success-screen">
            <!-- Confetti Elements -->
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>
            <div class="confetti"></div>

            <div class="celebration-emoji">🎉</div>

            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>

            <h2>כל הכבוד! מכירה חדשה!</h2>
            <p class="subtitle">הרשומה נשמרה בהצלחה במערכת</p>

            <div class="sale-summary">
                <div class="sale-summary-title">📊 סיכום המכירה</div>

                <div class="sale-detail">
                    <span class="sale-detail-label">לקוח:</span>
                    <span class="sale-detail-value" id="summaryClientName">-</span>
                </div>

                <div class="sale-detail">
                    <span class="sale-detail-label">סוג עסקה:</span>
                    <span class="sale-detail-value" id="summaryTransactionType">-</span>
                </div>

                <div class="sale-detail">
                    <span class="sale-detail-label">אמצעי תשלום:</span>
                    <span class="sale-detail-value" id="summaryPaymentMethod">-</span>
                </div>

                <div class="sale-amount">
                    ₪<span id="summaryAmount">0</span>
                    <div style="font-size: 14px; font-weight: 400; margin-top: 4px;">כולל מע"מ</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="resetForm()" style="max-width: 250px; margin: 0 auto; font-size: 16px;">
                🚀 מכירה נוספת
            </button>
        </div>
    </div>

    <!-- Billing Management View -->
    <div id="billingManagement">
        <div class="bm-header">
            <h2>ניהול גבייה חודשית</h2>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="bm-sync-btn" id="bmExportBtn" onclick="exportBillingReport()" title="ייצוא דוח גבייה לקובץ CSV">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    ייצוא דוח
                </button>
                <button class="bm-back-btn" onclick="hideBillingManagement()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    חזרה
                </button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="bm-summary">
            <div class="bm-stat blue">
                <div class="bm-stat-value" id="bmStatTotal">0</div>
                <div class="bm-stat-label">לקוחות פעילים</div>
            </div>
            <div class="bm-stat">
                <div class="bm-stat-value" id="bmStatMonthly">₪0</div>
                <div class="bm-stat-label">גבייה חודשית</div>
            </div>
            <div class="bm-stat green">
                <div class="bm-stat-value" id="bmStatPaid">₪0</div>
                <div class="bm-stat-label">שולם עד כה</div>
            </div>
            <div class="bm-stat red">
                <div class="bm-stat-value" id="bmStatRemaining">₪0</div>
                <div class="bm-stat-label">יתרה לגבייה</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="bm-toolbar">
            <input type="text" class="bm-search" id="bmSearch" placeholder="חיפוש לקוח..." oninput="filterBillingView()">
            <div class="bm-filters">
                <button class="bm-filter-btn active" data-filter="all" onclick="setBillingFilter('all', this)">הכל</button>
                <button class="bm-filter-btn" data-filter="פעיל" onclick="setBillingFilter('פעיל', this)">פעילים</button>
                <button class="bm-filter-btn" data-filter="מושהה" onclick="setBillingFilter('מושהה', this)">מושהים</button>
                <button class="bm-filter-btn" data-filter="בוטל" onclick="setBillingFilter('בוטל', this)">בוטלו</button>
            </div>
            <div class="bm-view-toggle">
                <button class="bm-view-btn active" id="bmViewTable" onclick="setBillingViewMode('table')" title="תצוגת טבלה">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/></svg>
                </button>
                <button class="bm-view-btn" id="bmViewCards" onclick="setBillingViewMode('cards')" title="תצוגת כרטיסיות">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                </button>
            </div>
        </div>

        <!-- Table View -->
        <div id="bmTableView">
            <div class="bm-table-wrap">
                <table class="bm-table">
                    <thead>
                        <tr>
                            <th>לקוח</th>
                            <th>עו"ד מטפל</th>
                            <th>חיוב הבא <span style="font-weight:400;font-size:10px;color:#94a3b8;">(כולל מע"מ)</span></th>
                            <th>סה"כ עסקה</th>
                            <th>שולם</th>
                            <th>התקדמות</th>
                            <th>סטטוס</th>
                            <th>חיוב הבא</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="bmTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cards View -->
        <div id="bmCardsView" style="display: none;">
            <div class="bm-cards" id="bmCardsContainer">
            </div>
        </div>

        <!-- Loading -->
        <div id="bmLoading" class="bm-loading" style="display: none;">
            <div class="bm-loading-spinner"></div>
            טוען נתוני גבייה...
        </div>

        <!-- Empty State -->
        <div id="bmEmpty" class="bm-empty" style="display: none;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            <p>אין לקוחות בגבייה חודשית</p>
        </div>

        <!-- Footer -->
        <div class="bm-footer">
            <p>נבנה על ידי חיים פרץ | כל הזכויות שמורות למשרד עו"ד גיא הרשקוביץ &copy; 2026</p>
        </div>
    </div>

    <!-- ========== Invoices Management ========== -->
    <div id="invoicesManagement">
        <div class="inv-header">
            <h2>חשבונות עסקה</h2>
            <div class="inv-header-actions">
                <button class="inv-new-btn" onclick="openInvoiceModal()">+ חשבון חדש</button>
                <button class="inv-back-btn" onclick="hideInvoicesManagement()">← חזרה</button>
            </div>
        </div>

        <div class="inv-summary">
            <div class="inv-stat">
                <div class="inv-stat-value" id="invStatTotal">0</div>
                <div class="inv-stat-label">סה"כ חשבונות</div>
            </div>
            <div class="inv-stat">
                <div class="inv-stat-value" id="invStatAmount">₪0</div>
                <div class="inv-stat-label">סכום כולל (כולל מע"מ)</div>
            </div>
            <div class="inv-stat">
                <div class="inv-stat-value" id="invStatMonth">0</div>
                <div class="inv-stat-label">חשבונות החודש</div>
            </div>
        </div>

        <div class="inv-toolbar">
            <input type="text" class="inv-search" id="invSearch" placeholder="חיפוש לפי שם לקוח או מספר חשבון..." oninput="filterInvoices()">
            <input type="month" class="inv-month-filter" id="invMonthFilter" onchange="filterInvoices()">
        </div>

        <div id="invLoading" style="display:none;text-align:center;padding:40px;">
            <div style="width:36px;height:36px;border:3px solid #e2e8f0;border-top-color:#0f172a;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto;"></div>
            <p style="color:#64748b;margin-top:12px;">טוען חשבונות...</p>
        </div>

        <div id="invEmpty" style="display:none;text-align:center;padding:40px;color:#94a3b8;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 12px;display:block;opacity:0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            <p>אין חשבונות עסקה עדיין</p>
            <p style="font-size:13px;">לחץ על "+ חשבון חדש" כדי ליצור חשבון ראשון</p>
        </div>

        <div id="invTableView">
            <div class="inv-table-wrap">
                <table class="inv-table">
                    <thead>
                        <tr>
                            <th>מספר</th>
                            <th>תאריך</th>
                            <th>לקוח</th>
                            <th>נושא</th>
                            <th>סכום לפני מע"מ</th>
                            <th>מע"מ</th>
                            <th>סה"כ לתשלום</th>
                            <th>סטטוס</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="invTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="inv-footer">
            <p>נבנה על ידי חיים פרץ | כל הזכויות שמורות למשרד עו"ד גיא הרשקוביץ &copy; 2026</p>
        </div>
    </div>

    <!-- Invoice Create Modal -->
    <div class="inv-modal-overlay" id="invModalOverlay" onclick="if(event.target===this) closeInvoiceModal()">
        <div class="inv-modal">
            <div class="inv-modal-header">
                <h3 id="invModalTitle">חשבון עסקה חדש</h3>
                <button class="inv-modal-close" onclick="closeInvoiceModal()">✕</button>
            </div>
            <div class="inv-modal-body" id="invModalBody">
                <div class="inv-section-title">פרטי לקוח</div>

                <div class="form-group" style="position:relative;">
                    <label>חיפוש לקוח מגבייה</label>
                    <input type="text" id="invClientSearch" placeholder="הקלד שם לקוח לחיפוש..." autocomplete="off">
                    <div id="invAutocomplete" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid #e2e8f0;border-radius:8px;max-height:150px;overflow-y:auto;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם לקוח / חברה <span class="required">*</span></label>
                        <input type="text" id="invClientName" required>
                    </div>
                    <div class="form-group">
                        <label>ח.פ / ת.ז</label>
                        <input type="text" id="invClientIdNumber">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>טלפון</label>
                        <input type="text" id="invClientPhone">
                    </div>
                    <div class="form-group">
                        <label>מייל</label>
                        <input type="email" id="invClientEmail">
                    </div>
                </div>

                <input type="hidden" id="invBillingClientId" value="">

                <div class="inv-section-title">פרטי חשבון</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>מספר חשבון</label>
                        <input type="number" id="invNumber" readonly style="background:#f8fafc;color:#64748b;font-weight:700;">
                    </div>
                    <div class="form-group">
                        <label>תאריך חשבון <span class="required">*</span></label>
                        <input type="date" id="invDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>לתשלום עד</label>
                        <input type="date" id="invDueDate">
                    </div>
                    <div class="form-group">
                        <label>עורך דין אחראי</label>
                        <input type="text" id="invAttorney">
                    </div>
                </div>
                <div class="form-group">
                    <label>כותרת / נושא <span class="required">*</span></label>
                    <input type="text" id="invSubject" placeholder="למשל: חריגה מתקרת שעות – שלב ג' בהתאם להסכם שכר טרחה">
                </div>

                <div class="inv-section-title">שורות פירוט</div>

                <table class="inv-line-items-table">
                    <thead>
                        <tr>
                            <th style="width:40%;">פירוט</th>
                            <th style="width:12%;">כמות</th>
                            <th style="width:18%;">מחיר ליחידה ₪</th>
                            <th style="width:18%;">סה"כ ₪</th>
                            <th style="width:12%;"></th>
                        </tr>
                    </thead>
                    <tbody id="invLineItems">
                        <tr class="inv-line-row">
                            <td><input type="text" class="inv-line-desc" placeholder="תיאור השירות"></td>
                            <td><input type="number" class="inv-line-qty" value="1" min="0" step="0.01" onchange="calcInvoiceTotals()" oninput="calcInvoiceTotals()"></td>
                            <td><input type="number" class="inv-line-price" value="0" min="0" step="0.01" onchange="calcInvoiceTotals()" oninput="calcInvoiceTotals()"></td>
                            <td class="inv-line-total">₪0</td>
                            <td><button class="inv-remove-line" onclick="removeInvoiceLine(this)" title="הסר שורה">✕</button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="inv-add-line-btn" onclick="addInvoiceLine()">+ הוסף שורה</button>

                <div class="inv-totals">
                    <div class="inv-totals-row">
                        <span>סה"כ לפני מע"מ</span>
                        <span id="invSubtotal">₪0</span>
                    </div>
                    <div class="inv-totals-row">
                        <span>מע"מ 18%</span>
                        <span id="invVatAmount">₪0</span>
                    </div>
                    <div class="inv-totals-row grand">
                        <span>סה"כ לתשלום</span>
                        <span id="invGrandTotal">₪0</span>
                    </div>
                </div>
            </div>
            <div class="inv-modal-footer" id="invModalFooter">
                <button class="inv-back-btn" onclick="closeInvoiceModal()">ביטול</button>
                <button class="inv-new-btn" id="invSubmitBtn" onclick="submitInvoice()">
                    <span id="invSubmitText">שמור ויצור PDF</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Invoice PDF Preview (hidden, for html2canvas) -->
    <div id="invPdfPreview" class="inv-pdf-preview"></div>

    <!-- Billing Modal -->
    <div id="billingModalOverlay" class="billing-modal-overlay" onclick="if(event.target===this) closeBillingModal()">
        <div class="billing-modal">
            <div class="billing-modal-header">
                <h3>הוספת לקוח לגבייה חודשית</h3>
                <button class="billing-modal-close" onclick="closeBillingModal()">&times;</button>
            </div>
            <div class="billing-modal-body" id="billingModalBody">
                <div class="billing-section-title">פרטי לקוח</div>

                <div class="form-group billing-search-container">
                    <label>חיפוש לקוח קיים</label>
                    <input type="text" id="billingClientSearch" placeholder="הקלד שם לקוח לחיפוש..." autocomplete="off">
                    <div id="billingAutocomplete" class="billing-autocomplete"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם הלקוח <span class="required">*</span></label>
                        <input type="text" id="billingClientName" placeholder="שם מלא / שם חברה" required>
                    </div>
                    <div class="form-group">
                        <label>טלפון</label>
                        <input type="tel" id="billingPhone" placeholder="050-0000000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>מייל</label>
                        <input type="email" id="billingEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>ח.פ / ת.ז</label>
                        <input type="text" id="billingIdNumber" placeholder="מספר זיהוי">
                    </div>
                </div>

                <div class="form-group">
                    <label>כתובת</label>
                    <input type="text" id="billingAddress" placeholder="כתובת הלקוח">
                </div>

                <div class="billing-section-title">פרטי גבייה חודשית</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>סה"כ סכום לגבייה (כולל מע"מ) <span class="required">*</span></label>
                        <input type="number" id="billingTotalDeal" placeholder="סך כולל" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>מספר תשלומים <span class="required">*</span></label>
                        <input type="number" id="billingMonths" placeholder="כמה תשלומים?" min="1" max="60" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>סכום לכל תשלום (מחושב אוטומטית)</label>
                    <input type="number" id="billingAmount" placeholder="יחושב אוטומטית" min="0" step="0.01" readonly
                        style="background:#f8fafc;color:#64748b;">
                    <div style="font-size:11px;color:var(--gray-400);margin-top:3px;">ניתן לערוך כל תשלום בנפרד בטבלה למטה</div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>תאריך חיוב ראשון <span class="required">*</span></label>
                        <input type="date" id="billingStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>יום בחודש לחיוב</label>
                        <input type="number" id="billingDayOfMonth" placeholder="1" min="1" max="28" value="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>חודשים ששולמו כבר</label>
                    <input type="number" id="billingPaidMonths" placeholder="0 (אם הלקוח חדש)" min="0" max="60" value="0">
                    <div style="font-size: 11px; color: var(--gray-400); margin-top: 4px;">למקרה שהלקוח כבר שילם חלק מהתשלומים לפני ההכנסה למערכת</div>
                </div>

                <!-- טבלת סכומים לכל חודש -->
                <div id="billingAmountsPreview" style="display:none;margin-top:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <label style="font-weight:600;font-size:13px;color:var(--gray-700);">פירוט סכומים לכל חודש</label>
                        <button type="button" onclick="toggleAmountsTable()" id="billingAmountsToggle" style="background:none;border:1px solid var(--primary-blue);color:var(--primary-blue);border-radius:6px;padding:4px 12px;font-size:11px;font-family:Heebo,sans-serif;cursor:pointer;">ערוך סכומים</button>
                    </div>
                    <div id="billingAmountsTable" style="display:none;max-height:250px;overflow-y:auto;border:1px solid var(--gray-200);border-radius:8px;padding:8px;background:var(--gray-50);"></div>
                    <div id="billingAmountsSummary" style="font-size:12px;color:var(--gray-500);margin-top:4px;"></div>
                </div>

                <div class="billing-section-title">פרטי כרטיס אשראי</div>
                <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    המידע מוצפן ונשמר בצורה מאובטחת. לצפייה במספר המלא נדרשת סיסמת המשרד.
                </div>

                <div class="form-group">
                    <label>מספר כרטיס אשראי</label>
                    <input type="text" id="billingCardNumber" placeholder="0000 0000 0000 0000" maxlength="19" dir="ltr" style="text-align: left; letter-spacing: 2px; font-variant-numeric: tabular-nums;" autocomplete="off">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>תוקף</label>
                        <input type="text" id="billingCardExpiry" placeholder="MM/YY" maxlength="5" dir="ltr" style="text-align: left;" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>CVV (3 ספרות)</label>
                        <input type="password" id="billingCardCvv" placeholder="•••" maxlength="4" dir="ltr" style="text-align: center; letter-spacing: 4px;" autocomplete="off">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם בעל הכרטיס</label>
                        <input type="text" id="billingCardHolder" placeholder="שם כפי שמופיע על הכרטיס">
                    </div>
                    <div class="form-group">
                        <label>סוג כרטיס</label>
                        <select id="billingCardType">
                        <option value="">בחר סוג</option>
                        <option value="ויזה">ויזה (Visa)</option>
                        <option value="מאסטרקארד">מאסטרקארד (Mastercard)</option>
                        <option value="אמריקן אקספרס">אמריקן אקספרס (Amex)</option>
                        <option value="ישראכרט">ישראכרט</option>
                        <option value="דיינרס">דיינרס</option>
                        <option value="אחר">אחר</option>
                    </select>
                    </div>
                </div>

                <div class="billing-section-title">פרטים נוספים</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>עו"ד מטפל <span class="required">*</span></label>
                        <select id="billingAttorney" required>
                            <option value="">בחר עו"ד</option>
                            <option value="גיא הרשקוביץ">גיא הרשקוביץ</option>
                            <option value="מירי טל">מירי טל</option>
                            <option value="רועי הרשקוביץ">רועי הרשקוביץ</option>
                            <option value="אורי שטיינברג">אורי שטיינברג</option>
                            <option value="חיים">חיים</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>מספר תיק</label>
                        <input type="text" id="billingCaseNumber" placeholder="מספר תיק בעודכנית">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>סניף</label>
                        <select id="billingBranch">
                            <option value="תל אביב">תל אביב</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>סוג העסקה</label>
                        <select id="billingTransactionType">
                            <option value="ריטיינר">ריטיינר</option>
                            <option value="תוכנית שעות">תוכנית שעות</option>
                            <option value="הליך משפטי - פיקס">הליך משפטי - פיקס</option>
                            <option value="אחר">אחר</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>הערות</label>
                    <textarea id="billingNotes" placeholder="הערות נוספות..." rows="2"></textarea>
                </div>
            </div>

            <div class="billing-modal-footer" id="billingModalFooter">
                <button class="billing-btn-cancel" onclick="closeBillingModal()">ביטול</button>
                <button class="billing-btn-submit" id="billingSubmitBtn" onclick="submitBillingForm()">
                    <span id="billingSubmitText">שמור וצור תזכורות</span>
                    <div class="spinner hidden" id="billingSpinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Billing Client Modal -->
    <div id="editModalOverlay" class="edit-modal-overlay" onclick="if(event.target===this) closeEditModal()">
        <div class="edit-modal">
            <div class="edit-modal-header">
                <h3>עריכת לקוח גבייה</h3>
                <button class="edit-modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <input type="hidden" id="editDocId">

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטי לקוח</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>שם הלקוח <span class="required">*</span></label>
                        <input type="text" id="editClientName" required>
                    </div>
                    <div class="form-group">
                        <label>טלפון</label>
                        <input type="tel" id="editPhone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>מייל</label>
                        <input type="email" id="editEmail">
                    </div>
                    <div class="form-group">
                        <label>ח.פ / ת.ז</label>
                        <input type="text" id="editIdNumber">
                    </div>
                </div>
                <div class="form-group">
                    <label>כתובת</label>
                    <input type="text" id="editAddress">
                </div>

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטי גבייה</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>סה"כ סכום לגבייה (כולל מע"מ) <span class="required">*</span></label>
                        <input type="number" id="editTotalDeal" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>מספר תשלומים <span class="required">*</span></label>
                        <input type="number" id="editMonths" min="1" max="60" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>סכום לכל תשלום (מחושב אוטומטית)</label>
                    <input type="number" id="editAmount" readonly style="background:#f8fafc;color:#64748b;">
                </div>
                <div id="editAmountsPreview" style="display:none;margin:8px 0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                        <span style="font-size:12px;font-weight:600;color:#0f172a;">פירוט תשלומים</span>
                        <button type="button" id="editAmountsToggle" onclick="toggleEditAmountsTable()" style="font-size:11px;padding:3px 10px;border:1px solid #e2e8f0;border-radius:4px;cursor:pointer;background:none;color:var(--primary-blue);font-family:Heebo,sans-serif;">ערוך סכומים</button>
                    </div>
                    <div id="editAmountsTable" style="display:none;max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;"></div>
                    <div id="editAmountsSummary" style="font-size:12px;color:#64748b;margin-top:4px;text-align:center;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>תאריך חיוב ראשון</label>
                        <input type="date" id="editStartDate">
                    </div>
                    <div class="form-group">
                        <label>יום בחודש לחיוב</label>
                        <input type="number" id="editDayOfMonth" min="1" max="28">
                    </div>
                </div>
                <div class="form-group">
                    <label>חודשים ששולמו כבר</label>
                    <input type="number" id="editPaidMonths" min="0" max="60">
                </div>
                <div class="form-group">
                    <label>סטטוס</label>
                    <select id="editStatus">
                        <option value="פעיל">פעיל</option>
                        <option value="מושהה">מושהה</option>
                        <option value="בוטל">בוטל</option>
                    </select>
                </div>

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטי כרטיס אשראי</div>
                <div style="font-size: 11px; color: var(--gray-400); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <span id="editCardStatus">לא הוזן כרטיס</span>
                </div>
                <div class="form-group">
                    <label>מספר כרטיס חדש (השאר ריק לשמור הקיים)</label>
                    <input type="text" id="editCardNumber" placeholder="0000 0000 0000 0000" maxlength="19" dir="ltr" style="text-align:left;letter-spacing:2px;font-variant-numeric:tabular-nums;" autocomplete="off">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>תוקף</label>
                        <input type="text" id="editCardExpiry" placeholder="MM/YY" maxlength="5" dir="ltr" style="text-align:left;" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>CVV (3 ספרות)</label>
                        <input type="password" id="editCardCvv" placeholder="•••" maxlength="4" dir="ltr" style="text-align:center;letter-spacing:4px;" autocomplete="off">
                    </div>
                </div>
                <div class="form-group">
                    <label>שם בעל הכרטיס</label>
                    <input type="text" id="editCardHolder">
                </div>
                <div class="form-group">
                    <label>סוג כרטיס</label>
                    <select id="editCardType">
                        <option value="">בחר סוג</option>
                        <option value="ויזה">ויזה (Visa)</option>
                        <option value="מאסטרקארד">מאסטרקארד (Mastercard)</option>
                        <option value="אמריקן אקספרס">אמריקן אקספרס (Amex)</option>
                        <option value="ישראכרט">ישראכרט</option>
                        <option value="דיינרס">דיינרס</option>
                        <option value="אחר">אחר</option>
                    </select>
                </div>

                <div class="billing-section-title" style="background:#dbeafe;color:#1d4ed8;">פרטים נוספים</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>עו"ד מטפל</label>
                        <select id="editAttorney">
                            <option value="">בחר עו"ד</option>
                            <option value="גיא הרשקוביץ">גיא הרשקוביץ</option>
                            <option value="מירי טל">מירי טל</option>
                            <option value="רועי הרשקוביץ">רועי הרשקוביץ</option>
                            <option value="אורי שטיינברג">אורי שטיינברג</option>
                            <option value="חיים">חיים</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>מספר תיק</label>
                        <input type="text" id="editCaseNumber">
                    </div>
                </div>
                <div class="form-group">
                    <label>הערות</label>
                    <textarea id="editNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-btn-cancel" onclick="closeEditModal()">ביטול</button>
                <button class="edit-btn-save" id="editSaveBtn" onclick="saveEditBilling()">שמור שינויים</button>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="pmOverlay" class="pm-overlay" onclick="if(event.target===this) closePaymentModal()">
        <div class="pm-modal">
            <div class="pm-header">
                <h3 id="pmTitle">פירוט תשלומים</h3>
                <button class="pm-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="pm-body" id="pmBody">
                <div class="pm-client-summary" id="pmClientSummary"></div>
                <div class="pm-list-header">
                    <div>#</div>
                    <div>תאריך חיוב</div>
                    <div style="text-align:center;">סכום מתוכנן</div>
                    <div style="text-align:center;">שולם בפועל</div>
                    <div></div>
                </div>
                <div id="pmPaymentsList"></div>
                <div class="pm-accounting" id="pmAccounting"></div>
            </div>
            <div class="pm-footer">
                <div style="display:flex;gap:8px;">
                    <button class="pm-footer-btn" onclick="closePaymentModal()">סגור</button>
                    <button class="pm-footer-btn danger" onclick="cancelBillingSeriesUI()">ביטול סדרה</button>
                    <button class="pm-footer-btn" onclick="extendBillingSeriesUI()">הוסף חודשים</button>
                </div>
                <button class="pm-footer-btn primary" id="pmMarkAllBtn" onclick="markNextPayment()">
                    סמן תשלום הבא כבוצע
                </button>
            </div>
        </div>
    </div>

    <!-- Password Popup -->
    <div id="pwPopupOverlay" class="pw-popup-overlay">
        <div class="pw-popup">
            <div class="pw-popup-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
            </div>
            <h3 id="pwPopupTitle">סיסמת הצפנה</h3>
            <div class="pw-desc" id="pwPopupDesc">
                סיסמה זו משמשת להצפנת פרטי כרטיס האשראי של הלקוח.<br>
                רק מי שיודע את הסיסמה יוכל לצפות במספר הכרטיס המלא.
            </div>
            <div class="pw-warning">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;margin-top:1px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <span>שמור את הסיסמה במקום בטוח. <strong>אם הסיסמה תישכח - לא ניתן לשחזר את פרטי הכרטיסים.</strong> אל תשתף אותה בהודעות או במייל.</span>
            </div>
            <input type="password" id="pwPopupInput" placeholder="הזן סיסמה">
            <div class="pw-popup-buttons">
                <button class="pw-popup-cancel" id="pwPopupCancel">ביטול</button>
                <button class="pw-popup-confirm" id="pwPopupConfirm">אישור</button>
            </div>
            <div class="pw-popup-error" id="pwPopupError"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Using environment variables
        const firebaseConfig = {
            apiKey: window.ENV_CONFIG.FIREBASE_API_KEY,
            authDomain: window.ENV_CONFIG.FIREBASE_AUTH_DOMAIN,
            databaseURL: window.ENV_CONFIG.FIREBASE_DATABASE_URL,
            projectId: window.ENV_CONFIG.FIREBASE_PROJECT_ID,
            storageBucket: window.ENV_CONFIG.FIREBASE_STORAGE_BUCKET,
            messagingSenderId: window.ENV_CONFIG.FIREBASE_MESSAGING_SENDER_ID,
            appId: window.ENV_CONFIG.FIREBASE_APP_ID,
            measurementId: window.ENV_CONFIG.FIREBASE_MEASUREMENT_ID
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ========== Firebase Authentication ==========

        let authUser = null;

        auth.onAuthStateChanged(function(user) {
            if (user) {
                authUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = '';
            } else {
                authUser = null;
                document.getElementById('loginScreen').style.display = '';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('billingManagement').classList.remove('active');
            }
        });

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');

            errorEl.textContent = '';
            if (!email || !password) {
                errorEl.textContent = 'נא למלא מייל וסיסמה';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'מתחבר...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                const messages = {
                    'auth/user-not-found': 'המייל לא נמצא במערכת',
                    'auth/wrong-password': 'סיסמה שגויה',
                    'auth/invalid-email': 'כתובת מייל לא תקינה',
                    'auth/too-many-requests': 'יותר מדי ניסיונות, נסה שוב מאוחר יותר',
                    'auth/invalid-credential': 'מייל או סיסמה שגויים'
                };
                errorEl.textContent = messages[error.code] || 'שגיאת התחברות: ' + error.message;
            }

            btn.disabled = false;
            btn.textContent = 'כניסה';
        }

        // Enter key on login
        document.getElementById('loginPassword').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('loginEmail').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') document.getElementById('loginPassword').focus();
        });

        function handleLogout() {
            auth.signOut();
        }

        // ========== Audit Log ==========

        function logCardView(docId, clientName) {
            try {
                db.collection('audit_log').add({
                    action: 'card_view',
                    billingDocId: docId,
                    clientName: clientName || '',
                    viewedBy: authUser ? authUser.email : (currentUser || 'unknown'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error('Audit log error:', e);
            }
        }

        // Global Variables
        let currentStep = 1;
        let currentUser = '';
        const totalSteps = 4;
        let searchTimeout = null;

        // Client Autocomplete Functionality
        async function searchClients(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) {
                return [];
            }

            try {
                // Search by client name - case insensitive
                const searchLower = searchTerm.toLowerCase();

                const clientsMap = new Map();

                // Query both collections in parallel
                const [salesSnapshot, billingSnapshot] = await Promise.all([
                    db.collection('sales_records')
                        .orderBy('timestamp', 'desc')
                        .limit(100)
                        .get(),
                    db.collection('recurring_billing')
                        .orderBy('createdAt', 'desc')
                        .limit(100)
                        .get()
                ]);

                // Process sales_records
                salesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const clientName = data.clientName || '';
                    const clientNameLower = clientName.toLowerCase();

                    if (clientNameLower.includes(searchLower)) {
                        if (!clientsMap.has(clientName)) {
                            clientsMap.set(clientName, {
                                clientName: data.clientName,
                                phone: data.phone,
                                email: data.email,
                                idNumber: data.idNumber,
                                address: data.address || ''
                            });
                        }
                    }
                });

                // Process recurring_billing
                billingSnapshot.forEach(doc => {
                    const data = doc.data();
                    const clientName = data.clientName || '';
                    const clientNameLower = clientName.toLowerCase();

                    if (clientNameLower.includes(searchLower)) {
                        if (!clientsMap.has(clientName)) {
                            clientsMap.set(clientName, {
                                clientName: data.clientName,
                                phone: data.phone || '',
                                email: data.email || '',
                                idNumber: data.idNumber || '',
                                address: data.address || ''
                            });
                        }
                    }
                });

                return Array.from(clientsMap.values());
            } catch (error) {
                console.error('Error searching clients:', error);
                return [];
            }
        }

        window.fillClientData = function(client) {
            document.getElementById('clientName').value = client.clientName;
            document.getElementById('phone').value = client.phone;
            document.getElementById('email').value = client.email;
            document.getElementById('idNumber').value = client.idNumber;
            document.getElementById('address').value = client.address;

            // Hide dropdown
            document.getElementById('clientAutocomplete').classList.remove('show');
        };

        function displayAutocompleteResults(clients) {
            const dropdown = document.getElementById('clientAutocomplete');

            if (clients.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">לא נמצאו לקוחות</div>';
                dropdown.classList.add('show');
                return;
            }

            dropdown.innerHTML = clients.map(client => `
                <div class="autocomplete-item" onclick="fillClientData(${JSON.stringify(client).replace(/"/g, '&quot;')})">
                    <div class="autocomplete-item-name">${client.clientName}</div>
                    <div class="autocomplete-item-details">
                        ${client.phone} • ${client.email}
                    </div>
                </div>
            `).join('');

            dropdown.classList.add('show');
        }

        // Initialize autocomplete on client name input
        document.addEventListener('DOMContentLoaded', function() {
            const clientNameInput = document.getElementById('clientName');
            const dropdown = document.getElementById('clientAutocomplete');

            clientNameInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value;

                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                // Hide dropdown if input is too short
                if (searchTerm.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }

                // Show loading state
                dropdown.innerHTML = '<div class="autocomplete-loading">מחפש...</div>';
                dropdown.classList.add('show');

                // Debounce search - wait 300ms after user stops typing
                searchTimeout = setTimeout(async () => {
                    const results = await searchClients(searchTerm);
                    displayAutocompleteResults(results);
                }, 300);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!clientNameInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Prevent form submission when selecting from dropdown
            clientNameInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && dropdown.classList.contains('show')) {
                    e.preventDefault();
                }
            });
        });

        // User Selection
        function selectUser(userName) {
            currentUser = userName;
            document.getElementById('userSelection').classList.add('hidden');
            document.getElementById('mainForm').classList.remove('hidden');
        }

        // Step Navigation
        function updateProgress() {
            const progressLine = document.getElementById('progressLine');
            const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressLine.style.width = `${100 - percentage}%`;

            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    indicator.classList.add('completed');
                    indicator.innerHTML = '✓';
                } else if (index + 1 === currentStep) {
                    indicator.classList.add('active');
                    indicator.innerHTML = index + 1;
                } else {
                    indicator.innerHTML = index + 1;
                }
            });

            document.querySelectorAll('.step-label').forEach((label, index) => {
                label.classList.toggle('active', index + 1 === currentStep);
            });
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
            currentStep = step;
            updateProgress();
        }

        function validateStep(step) {
            const stepElement = document.querySelector(`.form-step[data-step="${step}"]`);
            const requiredFields = stepElement.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            // Special validation for radio buttons in step 3
            if (step === 3) {
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!paymentMethod) {
                    isValid = false;
                }
            }

            // Special validation for amount field in step 2
            if (step === 2) {
                const amountField = document.getElementById('amount');
                const amountValue = parseAmount(amountField.value);
                if (amountValue <= 0) {
                    amountField.classList.add('error');
                    isValid = false;
                } else {
                    amountField.classList.remove('error');
                }
            }

            return isValid;
        }

        function nextStep() {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    showStep(currentStep + 1);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        // Transaction Type Change Handler
        document.getElementById('transactionType').addEventListener('change', function() {
            const hoursPackageFields = document.getElementById('hoursPackageFields');
            const descriptionGroup = document.getElementById('transactionDescriptionGroup');
            const hoursQuantity = document.getElementById('hoursQuantity');
            const hourlyRate = document.getElementById('hourlyRate');

            if (this.value === 'תוכנית שעות') {
                hoursPackageFields.classList.add('show');
                descriptionGroup.style.display = 'none';
                document.getElementById('transactionDescription').removeAttribute('required');
                hoursQuantity.setAttribute('required', 'required');
                hourlyRate.setAttribute('required', 'required');
            } else {
                hoursPackageFields.classList.remove('show');
                descriptionGroup.style.display = 'block';
                document.getElementById('transactionDescription').setAttribute('required', 'required');
                hoursQuantity.removeAttribute('required');
                hourlyRate.removeAttribute('required');
                hoursQuantity.value = '';
                hourlyRate.value = '';
            }
        });

        // Hours Package Calculation
        function updateAmountFromHours() {
            const hours = parseFloat(document.getElementById('hoursQuantity').value) || 0;
            const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const totalAmount = hours * rate;

            if (totalAmount > 0) {
                document.getElementById('amount').value = totalAmount.toFixed(2);
                updateVatDisplay();
            }
        }

        document.getElementById('hoursQuantity').addEventListener('input', updateAmountFromHours);
        document.getElementById('hourlyRate').addEventListener('input', updateAmountFromHours);

        // Collect checks details
        function collectChecksDetails() {
            const count = parseInt(document.getElementById('checksCount').value) || 0;
            const checks = [];

            for (let i = 1; i <= count; i++) {
                const dateInput = document.getElementById(`check_date_${i}`);
                const amountInput = document.getElementById(`check_amount_${i}`);

                if (dateInput && amountInput) {
                    checks.push({
                        checkNumber: i,
                        date: dateInput.value,
                        amount: parseAmount(amountInput.value)
                    });
                }
            }

            return JSON.stringify(checks);
        }

        // Checks Details - Dynamic Fields
        document.getElementById('checksCount').addEventListener('input', function() {
            const count = parseInt(this.value) || 0;
            const container = document.getElementById('checksDetailsContainer');
            container.innerHTML = '';

            if (count > 0) {
                for (let i = 1; i <= count; i++) {
                    const checkRow = document.createElement('div');
                    checkRow.className = 'form-row';
                    checkRow.style.marginBottom = '12px';
                    checkRow.innerHTML = `
                        <div class="form-group" style="flex: 1;">
                            <label>שיק ${i} - תאריך <span class="required">*</span></label>
                            <input type="date" id="check_date_${i}" class="check-date" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>שיק ${i} - סכום <span class="required">*</span></label>
                            <input type="number" id="check_amount_${i}" class="check-amount" placeholder="0" min="0" step="any" required>
                        </div>
                    `;
                    container.appendChild(checkRow);
                }

                // Add event listeners for auto-calculation
                setTimeout(() => {
                    for (let i = 1; i <= count; i++) {
                        const amountInput = document.getElementById(`check_amount_${i}`);
                        if (amountInput) {
                            amountInput.addEventListener('input', autoCalculateLastCheck);
                        }
                    }
                }, 100);
            }
        });

        // Auto-calculate last check amount
        function autoCalculateLastCheck() {
            const checksCount = parseInt(document.getElementById('checksCount').value) || 0;
            if (checksCount <= 1) return;

            const totalAmount = parseAmount(document.getElementById('checksTotalAmount').value);
            if (totalAmount <= 0) return;

            let sum = 0;
            for (let i = 1; i < checksCount; i++) {
                const amountInput = document.getElementById(`check_amount_${i}`);
                if (amountInput) {
                    sum += parseAmount(amountInput.value);
                }
            }

            const lastCheckAmount = totalAmount - sum;
            const lastCheckInput = document.getElementById(`check_amount_${checksCount}`);

            if (lastCheckInput && lastCheckAmount >= 0) {
                lastCheckInput.value = lastCheckAmount.toFixed(2);
            }
        }

        // Helper function to parse amount - handles commas and multiple decimal places
        function parseAmount(value) {
            if (!value) return 0;
            // Remove commas and extra spaces
            const cleaned = value.toString().replace(/,/g, '').trim();
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        // VAT Calculation Display
        function updateVatDisplay() {
            const amountBeforeVat = parseAmount(document.getElementById('amount').value);

            if (amountBeforeVat > 0) {
                const vatAmount = amountBeforeVat * 0.18;
                const amountWithVat = amountBeforeVat + vatAmount;

                document.getElementById('amountBeforeVat').textContent = '₪' + amountBeforeVat.toFixed(2);
                document.getElementById('vatAmount').textContent = '₪' + vatAmount.toFixed(2);
                document.getElementById('amountWithVat').textContent = '₪' + amountWithVat.toFixed(2);
                document.getElementById('vatDisplay').classList.add('show');
            } else {
                document.getElementById('vatDisplay').classList.remove('show');
            }
        }

        document.getElementById('amount').addEventListener('input', updateVatDisplay);

        // Global variable for split payment rows
        let splitPaymentRowCounter = 0;

        // Payment Method Change Handler
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const ccConfirm = document.getElementById('creditCardConfirmation');
                const checksDetail = document.getElementById('checksDetails');
                const splitPaymentDetail = document.getElementById('splitPaymentDetails');
                const checksPhoto = document.getElementById('checksPhoto');
                const checksCount = document.getElementById('checksCount');
                const checksTotalAmount = document.getElementById('checksTotalAmount');

                ccConfirm.classList.remove('show');
                checksDetail.classList.remove('show');
                splitPaymentDetail.classList.remove('show');

                // Show encouragement message based on payment method
                showEncouragementMessage(this.value);

                if (this.value === 'כרטיס אשראי') {
                    ccConfirm.classList.add('show');
                    updateAmountReminder('cc');
                    checksPhoto.removeAttribute('required');
                    checksCount.removeAttribute('required');
                    checksTotalAmount.removeAttribute('required');
                } else if (this.value === 'שיקים דחויים') {
                    checksDetail.classList.add('show');
                    updateAmountReminder('checks');
                    checksPhoto.setAttribute('required', 'required');
                    checksCount.setAttribute('required', 'required');
                    checksTotalAmount.setAttribute('required', 'required');
                } else if (this.value === 'פיצול תשלום') {
                    splitPaymentDetail.classList.add('show');
                    updateAmountReminder('split');
                    checksPhoto.removeAttribute('required');
                    checksCount.removeAttribute('required');
                    checksTotalAmount.removeAttribute('required');

                    // Initialize with one row if empty
                    if (document.getElementById('splitPaymentRows').children.length === 0) {
                        addSplitPaymentRow();
                    }
                } else {
                    checksPhoto.removeAttribute('required');
                    checksCount.removeAttribute('required');
                    checksTotalAmount.removeAttribute('required');
                }
            });
        });

        // Show Encouragement Message Function
        function showEncouragementMessage(paymentMethod) {
            const messageElement = document.getElementById('encouragementMessage');
            let icon = '';
            let text = '';

            switch(paymentMethod) {
                case 'מזומן':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                    text = 'אללק! קאש זה קינג! בואו נמשיך...';
                    break;
                case 'כרטיס אשראי':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>';
                    text = 'יפה! חכם ומודרני. בואו נמשיך...';
                    break;
                case 'שיקים דחויים':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';
                    text = 'קלאסי ואמין! בואו למלא את הפרטים...';
                    break;
                case 'העברה בנקאית':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                    text = 'מקצוען! ישר וברור. בואו נמשיך...';
                    break;
                case 'ביט':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>';
                    text = 'דיגיטלי עד הסוף! יאללה להמשיך...';
                    break;
                case 'פיצול תשלום':
                    icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>';
                    text = 'גמישות מקסימלית! בואו נפרט את התשלומים...';
                    break;
                default:
                    icon = '';
                    text = '';
            }

            if (text) {
                messageElement.innerHTML = icon + '<span>' + text + '</span>';
                messageElement.classList.remove('hide');

                // Hide after 4 seconds with fade out
                setTimeout(() => {
                    messageElement.classList.add('hide');
                }, 4000);
            }
        }

        // Update Amount Reminder Function
        function updateAmountReminder(type) {
            const amountBeforeVat = parseFloat(document.getElementById('amount').value) || 0;
            if (amountBeforeVat > 0) {
                const amountWithVat = amountBeforeVat * 1.18;
                const formattedAmount = '₪' + amountWithVat.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                if (type === 'cc') {
                    document.getElementById('ccAmountReminder').textContent = formattedAmount;
                } else if (type === 'checks') {
                    document.getElementById('checksAmountReminder').textContent = formattedAmount;
                } else if (type === 'split') {
                    document.getElementById('splitAmountReminder').textContent = formattedAmount;
                }
            }
        }

        // Add Split Payment Row
        function addSplitPaymentRow() {
            splitPaymentRowCounter++;
            const rowId = 'splitRow_' + splitPaymentRowCounter;
            const container = document.getElementById('splitPaymentRows');

            const rowHTML = `
                <div class="split-payment-row" id="${rowId}" data-row-id="${rowId}">
                    <div class="split-row-header">
                        <div class="form-group">
                            <label>אמצעי תשלום</label>
                            <select class="split-payment-method" onchange="handleSplitMethodChange('${rowId}')">
                                <option value="">בחר אמצעי תשלום</option>
                                <option value="מזומן">מזומן</option>
                                <option value="כרטיס אשראי">כרטיס אשראי</option>
                                <option value="העברה בנקאית">העברה בנקאית</option>
                                <option value="ביט">ביט</option>
                                <option value="שיקים דחויים">שיקים דחויים</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>סכום (כולל מע"מ)</label>
                            <input type="number" class="split-payment-amount" placeholder="0" min="0" step="0.01" oninput="updateSplitPaymentSummary()">
                        </div>
                        <button type="button" class="split-payment-remove" onclick="removeSplitPaymentRow('${rowId}')" title="הסר">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <!-- אזור לשדות מפורטים - יוכנס דינמית -->
                    <div class="split-method-details" id="details_${rowId}"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', rowHTML);
            updateSplitPaymentSummary();
        }

        // Remove Split Payment Row
        function removeSplitPaymentRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateSplitPaymentSummary();
            }
        }

        // Handle Split Method Change - Show method-specific fields
        function handleSplitMethodChange(rowId) {
            const row = document.getElementById(rowId);
            const method = row.querySelector('.split-payment-method').value;
            const detailsContainer = document.getElementById('details_' + rowId);

            // Clear previous details
            detailsContainer.innerHTML = '';

            // Add method-specific fields
            if (method === 'כרטיס אשראי') {
                detailsContainer.innerHTML = getCreditCardDetailsHTML(rowId);
            } else if (method === 'שיקים דחויים') {
                detailsContainer.innerHTML = getChecksDetailsHTML(rowId);
            }

            updateSplitPaymentSummary();
        }

        // Get Credit Card Details HTML
        function getCreditCardDetailsHTML(rowId) {
            return `
                <div class="split-cc-details">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">פרטי כרטיס אשראי:</div>

                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="cc_full_${rowId}" name="cc_status_${rowId}" value="חיוב מלא" onchange="handleCreditCardStatusChange('${rowId}')">
                            <label for="cc_full_${rowId}">בוצע חיוב מלא</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="cc_deposit_${rowId}" name="cc_status_${rowId}" value="פיקדון" onchange="handleCreditCardStatusChange('${rowId}')">
                            <label for="cc_deposit_${rowId}">פיקדון</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="cc_temp_${rowId}" name="cc_status_${rowId}" value="אשראי זמני" onchange="handleCreditCardStatusChange('${rowId}')">
                            <label for="cc_temp_${rowId}">אשראי זמני - יוחלף</label>
                        </div>
                    </div>

                    <!-- חיוב מלא -->
                    <div id="cc_full_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>מספר תשלומים</label>
                            <input type="number" id="cc_payments_${rowId}" min="1" max="36" placeholder="1">
                        </div>
                    </div>

                    <!-- פיקדון -->
                    <div id="cc_deposit_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>חיוב חודשי</label>
                            <input type="number" id="cc_monthly_${rowId}" step="0.01" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>למשך כמה חודשים</label>
                            <input type="number" id="cc_months_${rowId}" min="1" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>פרטי פיקדון</label>
                            <textarea id="cc_deposit_text_${rowId}" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- אשראי זמני -->
                    <div id="cc_temp_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>פרטי החלפה</label>
                            <textarea id="cc_temp_text_${rowId}" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get Checks Details HTML
        function getChecksDetailsHTML(rowId) {
            return `
                <div class="split-checks-details">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">פרטי שיקים:</div>

                    <div class="form-group">
                        <label>כמה צ'קים?</label>
                        <input type="number" id="checks_count_${rowId}" min="1" placeholder="1">
                    </div>

                    <div class="form-group">
                        <label>סכום כל צ'ק</label>
                        <input type="number" id="checks_amount_${rowId}" step="0.01" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>צילום צ'ק</label>
                        <input type="file" id="checks_photo_${rowId}" accept="image/*,application/pdf">
                    </div>

                    <div class="form-group">
                        <label>פרטי צ'קים נוספים (אופציונלי)</label>
                        <textarea id="checks_details_${rowId}" rows="2" placeholder="תאריכים, מספרי צ'קים וכו'"></textarea>
                    </div>

                    <div style="margin-top: 12px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 8px;">האם הצ'ק יוחלף?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="check_replace_no_${rowId}" name="check_replace_${rowId}" value="לא" checked onchange="handleCheckReplaceChange('${rowId}')">
                                <label for="check_replace_no_${rowId}">לא</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="check_replace_yes_${rowId}" name="check_replace_${rowId}" value="כן" onchange="handleCheckReplaceChange('${rowId}')">
                                <label for="check_replace_yes_${rowId}">כן</label>
                            </div>
                        </div>
                    </div>

                    <div id="check_replace_details_${rowId}" class="conditional-subfield">
                        <div class="form-group">
                            <label>באיזה אופן יוחלף?</label>
                            <textarea id="check_replace_text_${rowId}" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        // Handle Credit Card Status Change
        function handleCreditCardStatusChange(rowId) {
            const fullDetails = document.getElementById('cc_full_details_' + rowId);
            const depositDetails = document.getElementById('cc_deposit_details_' + rowId);
            const tempDetails = document.getElementById('cc_temp_details_' + rowId);

            fullDetails.style.display = 'none';
            depositDetails.style.display = 'none';
            tempDetails.style.display = 'none';

            const selectedStatus = document.querySelector(`input[name="cc_status_${rowId}"]:checked`)?.value;

            if (selectedStatus === 'חיוב מלא') {
                fullDetails.style.display = 'block';
            } else if (selectedStatus === 'פיקדון') {
                depositDetails.style.display = 'block';
            } else if (selectedStatus === 'אשראי זמני') {
                tempDetails.style.display = 'block';
            }
        }

        // Handle Check Replace Change
        function handleCheckReplaceChange(rowId) {
            const replaceDetails = document.getElementById('check_replace_details_' + rowId);
            const willReplace = document.querySelector(`input[name="check_replace_${rowId}"]:checked`)?.value;

            replaceDetails.style.display = (willReplace === 'כן') ? 'block' : 'none';
        }

        // Update Split Payment Summary
        function updateSplitPaymentSummary() {
            const rows = document.querySelectorAll('.split-payment-row');
            let totalEntered = 0;

            rows.forEach(row => {
                const amount = parseFloat(row.querySelector('.split-payment-amount').value) || 0;
                totalEntered += amount;
            });

            const amountBeforeVat = parseFloat(document.getElementById('amount').value) || 0;
            const totalRequired = amountBeforeVat * 1.18;
            const remaining = totalRequired - totalEntered;

            document.getElementById('splitTotalEntered').textContent = '₪' + totalEntered.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('splitRemaining').textContent = '₪' + remaining.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Change color based on remaining amount
            const remainingElement = document.getElementById('splitRemaining');
            if (remaining === 0) {
                remainingElement.style.color = 'var(--success)';
            } else if (remaining < 0) {
                remainingElement.style.color = 'var(--error)';
            } else {
                remainingElement.style.color = 'var(--error)';
            }

            // Show/hide summary
            if (rows.length > 0 && totalEntered > 0) {
                document.getElementById('splitPaymentSummary').style.display = 'block';
            } else {
                document.getElementById('splitPaymentSummary').style.display = 'none';
            }
        }

        // Get Split Payment Data
        async function getSplitPaymentData() {
            const rows = document.querySelectorAll('.split-payment-row');
            const splitPayments = [];

            for (const row of rows) {
                const rowId = row.getAttribute('data-row-id');
                const method = row.querySelector('.split-payment-method').value;
                const amount = parseFloat(row.querySelector('.split-payment-amount').value) || 0;

                if (!method || amount <= 0) continue;

                const paymentData = {
                    method: method,
                    amount: amount
                };

                // Collect method-specific details
                if (method === 'כרטיס אשראי') {
                    const ccStatus = document.querySelector(`input[name="cc_status_${rowId}"]:checked`)?.value || '';
                    paymentData.creditCardStatus = ccStatus;

                    if (ccStatus === 'חיוב מלא') {
                        paymentData.paymentsCount = document.getElementById('cc_payments_' + rowId)?.value || '';
                    } else if (ccStatus === 'פיקדון') {
                        paymentData.monthlyCharge = document.getElementById('cc_monthly_' + rowId)?.value || '';
                        paymentData.monthsCount = document.getElementById('cc_months_' + rowId)?.value || '';
                        paymentData.depositDetails = document.getElementById('cc_deposit_text_' + rowId)?.value || '';
                    } else if (ccStatus === 'אשראי זמני') {
                        paymentData.temporaryCreditDetails = document.getElementById('cc_temp_text_' + rowId)?.value || '';
                    }
                } else if (method === 'שיקים דחויים') {
                    paymentData.checksCount = document.getElementById('checks_count_' + rowId)?.value || '';
                    paymentData.checksAmount = document.getElementById('checks_amount_' + rowId)?.value || '';
                    paymentData.checksDetails = document.getElementById('checks_details_' + rowId)?.value || '';

                    const checkReplace = document.querySelector(`input[name="check_replace_${rowId}"]:checked`)?.value || 'לא';
                    paymentData.checkWillChange = checkReplace;

                    if (checkReplace === 'כן') {
                        paymentData.checkReplacementDetails = document.getElementById('check_replace_text_' + rowId)?.value || '';
                    }

                    // Upload check photo
                    const checksPhotoFile = document.getElementById('checks_photo_' + rowId)?.files[0];
                    if (checksPhotoFile) {
                        const timestamp = Date.now();
                        const fileName = `checks/${timestamp}_${rowId}_${checksPhotoFile.name}`;
                        paymentData.checksPhotoURL = await uploadFile(checksPhotoFile, fileName);
                    }
                }

                splitPayments.push(paymentData);
            }

            return splitPayments;
        }

        // Credit Card Status Change Handler
        document.querySelectorAll('input[name="creditCardStatus"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const fullChargeDetails = document.getElementById('fullChargeDetails');
                const monthlyChargeDetails = document.getElementById('monthlyChargeDetails');
                const depositDetails = document.getElementById('depositDetails');
                const temporaryCreditDetails = document.getElementById('temporaryCreditDetails');
                const paymentsCount = document.getElementById('paymentsCount');
                const monthlyCharge = document.getElementById('monthlyCharge');
                const temporaryCreditText = document.getElementById('temporaryCreditText');
                const recurringMonthlyAmount = document.getElementById('recurringMonthlyAmount');
                const recurringMonthsCount = document.getElementById('recurringMonthsCount');
                const recurringStartDate = document.getElementById('recurringStartDate');

                // Reset all sections
                fullChargeDetails.classList.remove('show');
                monthlyChargeDetails.classList.remove('show');
                depositDetails.classList.remove('show');
                temporaryCreditDetails.classList.remove('show');
                paymentsCount.removeAttribute('required');
                monthlyCharge.removeAttribute('required');
                temporaryCreditText.removeAttribute('required');
                recurringMonthlyAmount.removeAttribute('required');
                recurringMonthsCount.removeAttribute('required');
                recurringStartDate.removeAttribute('required');

                if (this.value === 'בוצע חיוב מלא') {
                    fullChargeDetails.classList.add('show');
                    paymentsCount.setAttribute('required', 'required');
                } else if (this.value === 'חיוב חודשי') {
                    monthlyChargeDetails.classList.add('show');
                    recurringMonthlyAmount.setAttribute('required', 'required');
                    recurringMonthsCount.setAttribute('required', 'required');
                    recurringStartDate.setAttribute('required', 'required');
                } else if (this.value === 'פיקדון') {
                    depositDetails.classList.add('show');
                    monthlyCharge.setAttribute('required', 'required');
                } else if (this.value === 'אשראי זמני - יוחלף') {
                    temporaryCreditDetails.classList.add('show');
                    temporaryCreditText.setAttribute('required', 'required');
                } else {
                    // Reset all fields
                    paymentsCount.value = '';
                    monthlyCharge.value = '';
                    temporaryCreditText.value = '';
                    document.getElementById('monthsCount').value = '';
                    document.getElementById('depositDetailsText').value = '';
                    recurringMonthlyAmount.value = '';
                    recurringMonthsCount.value = '';
                    recurringStartDate.value = '';
                }
            });
        });

        // Check Will Change Handler
        document.querySelectorAll('input[name="checkWillChange"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const checkReplacementDetails = document.getElementById('checkReplacementDetails');
                const checkReplacementText = document.getElementById('checkReplacementText');

                if (this.value === 'כן') {
                    checkReplacementDetails.classList.add('show');
                    checkReplacementText.setAttribute('required', 'required');
                } else {
                    checkReplacementDetails.classList.remove('show');
                    checkReplacementText.removeAttribute('required');
                    checkReplacementText.value = '';
                }
            });
        });

        // File Upload Handler
        document.getElementById('checksPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const container = document.getElementById('checksUploadContainer');
                const preview = document.getElementById('checksPreview');
                const fileName = document.getElementById('checksFileName');
                const image = document.getElementById('checksImage');

                container.classList.add('has-file');
                fileName.textContent = '✓ ' + file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    image.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Upload File to Firebase Storage
        async function uploadFile(file, path) {
            if (!file) return null;

            try {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(path);

                // Upload file
                const uploadTask = await fileRef.put(file, {
                    contentType: file.type,
                    customMetadata: {
                        'uploadedBy': currentUser,
                        'uploadDate': new Date().toISOString()
                    }
                });

                // Get download URL
                const downloadURL = await uploadTask.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('שגיאה בהעלאת התמונה: ' + error.message);
                throw error;
            }
        }

        // Form Submission
        document.getElementById('salesForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validateStep(4)) return;

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');

            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            try {
                const transactionType = document.getElementById('transactionType').value;
                const amountBeforeVat = parseFloat(document.getElementById('amount').value);
                const vatAmount = amountBeforeVat * 0.18;
                const amountWithVat = amountBeforeVat + vatAmount;

                let transactionDescription = document.getElementById('transactionDescription').value;

                // If hours package, build description from hours and rate
                if (transactionType === 'תוכנית שעות') {
                    const hours = document.getElementById('hoursQuantity').value;
                    const rate = document.getElementById('hourlyRate').value;
                    transactionDescription = `תוכנית ${hours} שעות במחיר ₪${rate} לשעה`;
                }

                // Upload checks photo if exists
                let checksPhotoURL = '';
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || '';

                if (paymentMethod === 'שיקים דחויים') {
                    const checksPhotoFile = document.getElementById('checksPhoto').files[0];
                    if (checksPhotoFile) {
                        const timestamp = Date.now();
                        const fileName = `checks/${timestamp}_${checksPhotoFile.name}`;
                        checksPhotoURL = await uploadFile(checksPhotoFile, fileName);
                    }
                }

                // Handle split payment data
                let paymentBreakdown = '';
                let paymentBreakdownText = '';
                let isSplitPayment = false;

                if (paymentMethod === 'פיצול תשלום') {
                    isSplitPayment = true;
                    const splitPayments = await getSplitPaymentData();
                    paymentBreakdown = JSON.stringify(splitPayments);

                    // Create detailed readable text for Google Sheets
                    paymentBreakdownText = splitPayments.map(p => {
                        let text = `${p.method}: ₪${p.amount.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                        // Add additional details
                        if (p.method === 'כרטיס אשראי' && p.creditCardStatus) {
                            if (p.creditCardStatus === 'חיוב מלא' && p.paymentsCount) {
                                text += ` (${p.paymentsCount} תשלומים)`;
                            } else if (p.creditCardStatus === 'פיקדון' && p.monthlyCharge) {
                                text += ` (₪${p.monthlyCharge} × ${p.monthsCount} חודשים)`;
                            }
                        } else if (p.method === 'שיקים דחויים' && p.checksCount) {
                            text += ` (${p.checksCount} צ'קים)`;
                        }

                        return text;
                    }).join(' + ');
                }

                const formData = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString().split('T')[0],
                    formFillerName: currentUser,
                    clientName: document.getElementById('clientName').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    idNumber: document.getElementById('idNumber').value,
                    address: document.getElementById('address').value || '',
                    clientStatus: document.querySelector('input[name="clientStatus"]:checked')?.value || 'חדש',
                    transactionType: transactionType,
                    transactionDescription: transactionDescription,
                    hoursQuantity: document.getElementById('hoursQuantity').value || '',
                    hourlyRate: document.getElementById('hourlyRate').value || '',
                    amountBeforeVat: amountBeforeVat,
                    vatAmount: vatAmount,
                    amountWithVat: amountWithVat,
                    amount: amountBeforeVat, // Keep for backwards compatibility
                    paymentMethod: paymentMethod,
                    isSplitPayment: isSplitPayment,
                    paymentBreakdown: paymentBreakdown,
                    paymentBreakdownText: paymentBreakdownText,
                    // Credit Card fields
                    creditCardStatus: document.querySelector('input[name="creditCardStatus"]:checked')?.value || '',
                    paymentsCount: document.getElementById('paymentsCount').value || '',
                    monthlyCharge: document.getElementById('monthlyCharge').value || '',
                    monthsCount: document.getElementById('monthsCount').value || '',
                    depositDetails: document.getElementById('depositDetailsText').value || '',
                    temporaryCreditDetails: document.getElementById('temporaryCreditText').value || '',
                    // Recurring billing fields
                    recurringBilling: document.querySelector('input[name="creditCardStatus"]:checked')?.value === 'חיוב חודשי',
                    recurringMonthlyAmount: document.getElementById('recurringMonthlyAmount').value || '',
                    recurringMonthsCount: document.getElementById('recurringMonthsCount').value || '',
                    recurringStartDate: document.getElementById('recurringStartDate').value || '',
                    recurringDayOfMonth: document.getElementById('recurringDayOfMonth').value || '1',
                    recurringNotes: document.getElementById('recurringNotes').value || '',
                    // Checks fields
                    checksCount: document.getElementById('checksCount').value || '',
                    checksTotalAmount: document.getElementById('checksTotalAmount').value || '',
                    checksPhotoURL: checksPhotoURL,
                    checksDetailedList: collectChecksDetails(),
                    checksDetails: document.getElementById('checksDetailsText').value || '',
                    checkWillChange: document.querySelector('input[name="checkWillChange"]:checked')?.value || '',
                    checkReplacementDetails: document.getElementById('checkReplacementText').value || '',
                    attorney: document.getElementById('attorney').value,
                    caseNumber: document.getElementById('caseNumber').value || '',
                    branch: document.getElementById('branch').value,
                    notes: document.getElementById('notes').value || '',
                    invoiceNumber: '',
                    receiptNumber: ''
                };

                // Save to Firestore
                await db.collection('sales_records').add(formData);

                // Sync to Google Sheets
                await syncToSheets(formData);

                // Update success screen with sale details
                document.getElementById('summaryClientName').textContent = formData.clientName;
                document.getElementById('summaryTransactionType').textContent = formData.transactionType;

                // Handle payment method display for split payment
                if (formData.isSplitPayment) {
                    const splitPayments = JSON.parse(formData.paymentBreakdown);
                    const paymentSummary = splitPayments.map(p => `${p.method}: ₪${p.amount.toLocaleString('he-IL')}`).join(', ');
                    document.getElementById('summaryPaymentMethod').textContent = `פיצול תשלום (${paymentSummary})`;
                } else {
                    document.getElementById('summaryPaymentMethod').textContent = formData.paymentMethod;
                }

                document.getElementById('summaryAmount').textContent = formData.amountWithVat.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                // Show success
                document.getElementById('mainForm').classList.add('hidden');
                document.getElementById('successScreen').classList.add('show');

            } catch (error) {
                console.error('Error submitting form:', error);
                alert('אירעה שגיאה בשליחת הטופס. נסה שנית.');
            } finally {
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        // Sync to Google Sheets
        async function syncToSheets(data) {
            const WEBHOOK_URL = window.ENV_CONFIG.GOOGLE_SHEETS_WEBHOOK;

            console.log('🔵 ========== DEBUG: syncToSheets START ==========');
            console.log('🔵 Original data received:', data);
            console.log('🔵 Webhook URL:', WEBHOOK_URL);

            try {
                // Create a clean copy of the data for Google Sheets
                const sheetsData = {
                    ...data,
                    // Convert Firebase timestamp to ISO string
                    timestamp: new Date().toISOString(),
                    // Ensure date is in the correct format (YYYY-MM-DD)
                    date: data.date || new Date().toISOString().split('T')[0]
                };

                console.log('🟢 Cleaned data for sheets:', sheetsData);
                console.log('🟢 JSON string being sent:', JSON.stringify(sheetsData));
                console.log('🟢 JSON string length:', JSON.stringify(sheetsData).length);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetsData)
                });

                console.log('🟡 Fetch completed with no-cors mode');
                console.log('🟡 Response type:', response.type);
                console.log('✅ Data sent to Google Sheets (cannot read response in no-cors mode)');

            } catch (error) {
                console.error('🔴 Error syncing to sheets:', error);
                console.error('🔴 Error details:', error.message, error.stack);
                // Continue even if sync fails - data is safe in Firestore
            }

            console.log('🔵 ========== DEBUG: syncToSheets END ==========');
        }

        // Reset Form
        function resetForm() {
            document.getElementById('salesForm').reset();
            document.getElementById('successScreen').classList.remove('show');
            document.getElementById('mainForm').classList.remove('hidden');

            // Reset conditional fields
            document.getElementById('hoursPackageFields').classList.remove('show');
            document.getElementById('transactionDescriptionGroup').style.display = 'block';
            document.getElementById('vatDisplay').classList.remove('show');
            document.getElementById('creditCardConfirmation').classList.remove('show');
            document.getElementById('fullChargeDetails').classList.remove('show');
            document.getElementById('monthlyChargeDetails').classList.remove('show');
            document.getElementById('depositDetails').classList.remove('show');
            document.getElementById('temporaryCreditDetails').classList.remove('show');

            // Reset recurring billing fields
            document.getElementById('recurringMonthlyAmount').value = '';
            document.getElementById('recurringMonthsCount').value = '';
            document.getElementById('recurringStartDate').value = '';
            document.getElementById('recurringDayOfMonth').value = '1';
            document.getElementById('recurringNotes').value = '';
            document.getElementById('checksDetails').classList.remove('show');
            document.getElementById('checkReplacementDetails').classList.remove('show');
            document.getElementById('splitPaymentDetails').classList.remove('show');
            document.getElementById('encouragementMessage').classList.add('hide');

            // Reset split payment rows
            document.getElementById('splitPaymentRows').innerHTML = '';
            splitPaymentRowCounter = 0;
            document.getElementById('splitPaymentSummary').style.display = 'none';

            // Reset file upload
            document.getElementById('checksUploadContainer').classList.remove('has-file');
            document.getElementById('checksPreview').classList.remove('show');
            document.getElementById('checksImage').src = '';

            // Reset to step 1
            showStep(1);
        }

        // ========== הצפנת כרטיס אשראי ==========

        function encryptCardData(cardNumber, passphrase) {
            return CryptoJS.AES.encrypt(cardNumber, passphrase).toString();
        }

        function decryptCardData(encryptedData, passphrase) {
            try {
                var bytes = CryptoJS.AES.decrypt(encryptedData, passphrase);
                var decrypted = bytes.toString(CryptoJS.enc.Utf8);
                if (!decrypted) return null;
                return decrypted;
            } catch (e) {
                return null;
            }
        }

        // פופאפ סיסמת הצפנה מעוצב
        function requestPassword(mode) {
            return new Promise(function(resolve) {
                var overlay = document.getElementById('pwPopupOverlay');
                var input = document.getElementById('pwPopupInput');
                var errorEl = document.getElementById('pwPopupError');
                var title = document.getElementById('pwPopupTitle');
                var desc = document.getElementById('pwPopupDesc');

                if (mode === 'decrypt') {
                    title.textContent = 'צפייה בפרטי כרטיס';
                    desc.innerHTML = 'הזן את סיסמת המשרד כדי לצפות במספר הכרטיס המלא.<br>פעולה זו נרשמת ביומן הביקורת.';
                } else {
                    title.textContent = 'הצפנת פרטי כרטיס';
                    desc.innerHTML = 'סיסמה זו משמשת להצפנת פרטי כרטיס האשראי של הלקוח.<br>רק מי שיודע את הסיסמה יוכל לצפות במספר הכרטיס המלא.';
                }

                input.value = '';
                errorEl.textContent = '';
                overlay.classList.add('show');
                setTimeout(function() { input.focus(); }, 100);

                function cleanup() {
                    overlay.classList.remove('show');
                    document.getElementById('pwPopupConfirm').removeEventListener('click', onConfirm);
                    document.getElementById('pwPopupCancel').removeEventListener('click', onCancel);
                    input.removeEventListener('keydown', onKeydown);
                }

                function onConfirm() {
                    var val = input.value;
                    if (!val) {
                        errorEl.textContent = 'נא להזין סיסמה';
                        return;
                    }
                    cleanup();
                    resolve(val);
                }

                function onCancel() {
                    cleanup();
                    resolve(null);
                }

                function onKeydown(e) {
                    if (e.key === 'Enter') onConfirm();
                    if (e.key === 'Escape') onCancel();
                }

                document.getElementById('pwPopupConfirm').addEventListener('click', onConfirm);
                document.getElementById('pwPopupCancel').addEventListener('click', onCancel);
                input.addEventListener('keydown', onKeydown);
            });
        }

        // פורמט מספר כרטיס - רווח כל 4 ספרות
        document.addEventListener('DOMContentLoaded', function() {
            var cardInput = document.getElementById('billingCardNumber');
            if (cardInput) {
                cardInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 16);
                    var formatted = val.replace(/(\d{4})(?=\d)/g, '$1 ');
                    e.target.value = formatted;
                });
            }

            var expiryInput = document.getElementById('billingCardExpiry');
            if (expiryInput) {
                expiryInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 4);
                    if (val.length >= 3) {
                        val = val.substring(0, 2) + '/' + val.substring(2);
                    }
                    e.target.value = val;
                });
            }
        });

        // ========== מודאל גבייה חודשית ==========

        let billingSearchTimeout = null;

        function openBillingModal() {
            document.getElementById('billingModalOverlay').classList.add('show');
            // Reset form
            document.getElementById('billingClientSearch').value = '';
            document.getElementById('billingClientName').value = '';
            document.getElementById('billingPhone').value = '';
            document.getElementById('billingEmail').value = '';
            document.getElementById('billingIdNumber').value = '';
            document.getElementById('billingAddress').value = '';
            document.getElementById('billingTotalDeal').value = '';
            document.getElementById('billingAmount').value = '';
            document.getElementById('billingMonths').value = '';
            document.getElementById('billingStartDate').value = '';
            document.getElementById('billingDayOfMonth').value = '1';
            document.getElementById('billingPaidMonths').value = '0';
            document.getElementById('billingAttorney').value = '';
            document.getElementById('billingCaseNumber').value = '';
            document.getElementById('billingTransactionType').value = 'ריטיינר';
            document.getElementById('billingNotes').value = '';
            document.getElementById('billingCardNumber').value = '';
            document.getElementById('billingCardExpiry').value = '';
            document.getElementById('billingCardCvv').value = '';
            document.getElementById('billingCardHolder').value = '';
            document.getElementById('billingCardType').value = '';
            document.getElementById('billingAutocomplete').classList.remove('show');

            // Reset amounts preview
            document.getElementById('billingAmountsPreview').style.display = 'none';
            document.getElementById('billingAmountsTable').style.display = 'none';
            document.getElementById('billingAmountsTable').innerHTML = '';
            document.getElementById('billingAmountsSummary').innerHTML = '';
            var toggleBtn = document.getElementById('billingAmountsToggle');
            if (toggleBtn) {
                toggleBtn.textContent = 'ערוך סכומים';
                toggleBtn.style.background = 'none';
                toggleBtn.style.color = 'var(--primary-blue)';
            }

            // Restore form view (in case success was shown)
            document.getElementById('billingModalBody').style.display = '';
            document.getElementById('billingModalFooter').style.display = '';
        }

        function closeBillingModal() {
            document.getElementById('billingModalOverlay').classList.remove('show');
        }

        // Autocomplete for billing modal
        document.getElementById('billingClientSearch').addEventListener('input', function(e) {
            const term = e.target.value.trim();
            clearTimeout(billingSearchTimeout);

            if (term.length < 2) {
                document.getElementById('billingAutocomplete').classList.remove('show');
                return;
            }

            billingSearchTimeout = setTimeout(async () => {
                const dropdown = document.getElementById('billingAutocomplete');
                dropdown.innerHTML = '<div class="billing-autocomplete-item" style="color:#6b7280;cursor:default;">מחפש...</div>';
                dropdown.classList.add('show');

                const clients = await searchClients(term);

                if (clients.length === 0) {
                    dropdown.innerHTML = '<div class="billing-autocomplete-item" style="color:#6b7280;cursor:default;">לא נמצאו לקוחות</div>';
                    return;
                }

                dropdown.innerHTML = clients.map(client =>
                    `<div class="billing-autocomplete-item" onclick='fillBillingClientData(${JSON.stringify(client).replace(/'/g, "&#39;")})'>
                        <div class="billing-autocomplete-name">${client.clientName}</div>
                        <div class="billing-autocomplete-details">${client.phone || ''} ${client.email ? '| ' + client.email : ''}</div>
                    </div>`
                ).join('');
            }, 300);
        });

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            const search = document.getElementById('billingClientSearch');
            const dropdown = document.getElementById('billingAutocomplete');
            if (search && dropdown && !search.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        window.fillBillingClientData = function(client) {
            document.getElementById('billingClientName').value = client.clientName || '';
            document.getElementById('billingPhone').value = client.phone || '';
            document.getElementById('billingEmail').value = client.email || '';
            document.getElementById('billingIdNumber').value = client.idNumber || '';
            document.getElementById('billingAddress').value = client.address || '';
            document.getElementById('billingClientSearch').value = client.clientName || '';
            document.getElementById('billingAutocomplete').classList.remove('show');
        };

        async function submitBillingForm() {
            // Validation
            const clientName = document.getElementById('billingClientName').value.trim();
            const totalDeal = document.getElementById('billingTotalDeal').value;
            const amount = document.getElementById('billingAmount').value;
            const months = document.getElementById('billingMonths').value;
            const startDate = document.getElementById('billingStartDate').value;
            const attorney = document.getElementById('billingAttorney').value;

            if (!clientName || !totalDeal || !months || !startDate || !attorney) {
                alert('נא למלא את כל השדות המסומנים בכוכבית');
                return;
            }

            const submitBtn = document.getElementById('billingSubmitBtn');
            submitBtn.disabled = true;
            document.getElementById('billingSubmitText').textContent = 'שומר...';

            try {
                // הצפנת פרטי כרטיס אשראי
                const cardNumber = (document.getElementById('billingCardNumber').value || '').replace(/\s/g, '');
                const cardExpiry = document.getElementById('billingCardExpiry').value || '';
                const cardCvv = document.getElementById('billingCardCvv').value || '';
                const cardHolder = document.getElementById('billingCardHolder').value || '';
                const cardType = document.getElementById('billingCardType').value || '';
                let cardEncrypted = '';
                let cvvEncrypted = '';
                let cardLast4 = '';

                if (cardNumber) {
                    const passphrase = await requestPassword('encrypt');
                    if (!passphrase) {
                        submitBtn.disabled = false;
                        document.getElementById('billingSubmitText').textContent = 'שמור וצור תזכורות';
                        return;
                    }
                    cardEncrypted = encryptCardData(cardNumber, passphrase);
                    cardLast4 = cardNumber.slice(-4);
                    if (cardCvv) {
                        cvvEncrypted = encryptCardData(cardCvv, passphrase);
                    }
                }

                const billingIdPrefix = 'BIL-' + Date.now();

                // בדיקה אם יש סכומים מותאמים לכל חודש
                const monthlyAmounts = getMonthlyAmountsFromTable();

                const totalDealNum = parseFloat(totalDeal);
                const monthsNum = parseInt(months);
                const perPayment = amount ? parseFloat(amount) : Math.round(totalDealNum / monthsNum);

                const billingData = {
                    clientName: clientName,
                    phone: document.getElementById('billingPhone').value || '',
                    email: document.getElementById('billingEmail').value || '',
                    idNumber: document.getElementById('billingIdNumber').value || '',
                    address: document.getElementById('billingAddress').value || '',
                    totalPlannedAmount: totalDealNum,
                    recurringMonthlyAmount: perPayment,
                    recurringMonthsCount: months,
                    recurringStartDate: startDate,
                    recurringDayOfMonth: document.getElementById('billingDayOfMonth').value || '1',
                    paidMonthsAlready: parseInt(document.getElementById('billingPaidMonths').value) || 0,
                    attorney: attorney,
                    caseNumber: document.getElementById('billingCaseNumber').value || '',
                    branch: document.getElementById('billingBranch').value || 'תל אביב',
                    transactionType: document.getElementById('billingTransactionType').value || 'ריטיינר',
                    transactionDescription: 'חיוב חודשי - ' + clientName,
                    recurringNotes: document.getElementById('billingNotes').value || '',
                    recurringBilling: true,
                    creditCardStatus: 'חיוב חודשי',
                    paymentMethod: 'כרטיס אשראי',
                    status: 'פעיל',
                    cardEncrypted: cardEncrypted,
                    cvvEncrypted: cvvEncrypted,
                    cardLast4: cardLast4,
                    cardExpiry: cardExpiry,
                    cardHolder: cardHolder,
                    cardType: cardType,
                    createdBy: currentUser || 'לא ידוע',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    billingIdPrefix: billingIdPrefix,
                    totalActualPaid: 0,
                    completedPaymentsCount: 0,
                    lastPaymentDate: null,
                    monthlyAmounts: monthlyAmounts || null
                };

                // שמירה ב-Firestore (מקור אמת יחיד לגבייה)
                await db.collection('recurring_billing').add(billingData);

                // הצגת הודעת הצלחה
                document.getElementById('billingModalBody').innerHTML =
                    '<div class="billing-success-msg">' +
                        '<div class="check-icon">&#10004;</div>' +
                        '<h3 style="margin:0 0 8px;color:#1f2937;">הלקוח נוסף לגבייה בהצלחה!</h3>' +
                        '<p style="color:#6b7280;margin:0 0 4px;">' + clientName + '</p>' +
                        '<p style="color:#6b7280;margin:0;">סה"כ ₪' + totalDealNum.toLocaleString('he-IL') + ' ב-' + monthsNum + ' תשלומים</p>' +
                        '<p style="color:#9ca3af;font-size:12px;margin-top:12px;">תזכורות יישלחו אוטומטית יום לפני כל חיוב</p>' +
                    '</div>';
                document.getElementById('billingModalFooter').innerHTML =
                    '<button class="billing-btn-submit" onclick="closeBillingModal()" style="width:100%;">סגור</button>';

            } catch (error) {
                console.error('Error saving billing data:', error);
                alert('שגיאה בשמירה: ' + error.message);
                submitBtn.disabled = false;
                document.getElementById('billingSubmitText').textContent = 'שמור וצור תזכורות';
            }
        }

        // ========== ניהול גבייה חודשית - Management View ==========

        let billingClients = [];
        let billingFilter = 'all';
        let billingViewMode = 'table';

        function showBillingManagement() {
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('billingManagement').classList.add('active');
            loadBillingData();
        }

        function hideBillingManagement() {
            document.getElementById('billingManagement').classList.remove('active');
            document.getElementById('mainContainer').style.display = '';
        }

        // ייצוא דוח גבייה ל-CSV
        async function exportBillingReport() {
            var btn = document.getElementById('bmExportBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> מייצא...';

            try {
                var snapshot = await db.collection('recurring_billing').get();
                var rows = [];

                for (var doc of snapshot.docs) {
                    var c = doc.data();
                    var amount = parseFloat(c.recurringMonthlyAmount) || 0;
                    var totalMonths = parseInt(c.recurringMonthsCount) || 0;
                    var paidMonths = parseInt(c.completedPaymentsCount) || parseInt(c.paidMonthsAlready) || 0;
                    var totalDeal = (c.totalPlannedAmount !== undefined && c.totalPlannedAmount !== null)
                        ? parseFloat(c.totalPlannedAmount) : amount * totalMonths;
                    var totalPaid = c.totalActualPaid !== undefined ? parseFloat(c.totalActualPaid) : amount * paidMonths;
                    var remaining = totalDeal - totalPaid;

                    // טעינת פירוט תשלומים
                    var paymentsSnap = await db.collection('recurring_billing').doc(doc.id)
                        .collection('payments').orderBy('monthNumber').get();

                    if (paymentsSnap.empty) {
                        // לקוח ללא subcollection - שורה אחת
                        rows.push({
                            clientName: c.clientName || '',
                            attorney: c.attorney || '',
                            caseNumber: c.caseNumber || '',
                            phone: c.phone || '',
                            email: c.email || '',
                            monthlyAmount: amount,
                            totalMonths: totalMonths,
                            totalDeal: totalDeal,
                            paidMonths: paidMonths,
                            totalPaid: totalPaid,
                            remaining: remaining,
                            status: c.status || 'פעיל',
                            startDate: c.recurringStartDate || '',
                            monthNumber: '',
                            plannedDate: '',
                            plannedAmount: '',
                            actualPaid: '',
                            actualDate: '',
                            paymentStatus: ''
                        });
                    } else {
                        // לקוח עם subcollection - שורה לכל תשלום
                        paymentsSnap.forEach(function(pDoc) {
                            var p = pDoc.data();
                            rows.push({
                                clientName: c.clientName || '',
                                attorney: c.attorney || '',
                                caseNumber: c.caseNumber || '',
                                phone: c.phone || '',
                                email: c.email || '',
                                monthlyAmount: amount,
                                totalMonths: totalMonths,
                                totalDeal: totalDeal,
                                paidMonths: paidMonths,
                                totalPaid: totalPaid,
                                remaining: remaining,
                                status: c.status || 'פעיל',
                                startDate: c.recurringStartDate || '',
                                monthNumber: p.monthNumber || '',
                                plannedDate: p.plannedDate || '',
                                plannedAmount: p.plannedAmount || '',
                                actualPaid: p.actualAmountPaid || '',
                                actualDate: p.actualPaymentDate || '',
                                paymentStatus: p.status || ''
                            });
                        });
                    }
                }

                // יצירת CSV עם BOM לתמיכה בעברית באקסל
                var headers = [
                    'שם לקוח', 'עו"ד מטפל', 'מספר תיק', 'טלפון', 'מייל',
                    'סכום חודשי', 'סה"כ חודשים', 'סה"כ עסקה',
                    'חודשים ששולמו', 'סה"כ שולם', 'יתרה',
                    'סטטוס לקוח', 'תאריך התחלה',
                    'מספר תשלום', 'תאריך מתוכנן', 'סכום מתוכנן',
                    'סכום ששולם', 'תאריך תשלום', 'סטטוס תשלום'
                ];

                var csvContent = '\uFEFF' + headers.join(',') + '\n';
                rows.forEach(function(r) {
                    var line = [
                        '"' + (r.clientName || '').replace(/"/g, '""') + '"',
                        '"' + (r.attorney || '').replace(/"/g, '""') + '"',
                        '"' + (r.caseNumber || '').replace(/"/g, '""') + '"',
                        '"' + (r.phone || '').replace(/"/g, '""') + '"',
                        '"' + (r.email || '').replace(/"/g, '""') + '"',
                        r.monthlyAmount,
                        r.totalMonths,
                        r.totalDeal,
                        r.paidMonths,
                        r.totalPaid,
                        r.remaining,
                        '"' + (r.status || '').replace(/"/g, '""') + '"',
                        '"' + (r.startDate || '').replace(/"/g, '""') + '"',
                        r.monthNumber,
                        '"' + (r.plannedDate || '').replace(/"/g, '""') + '"',
                        r.plannedAmount,
                        r.actualPaid,
                        '"' + (r.actualDate || '').replace(/"/g, '""') + '"',
                        '"' + (r.paymentStatus || '').replace(/"/g, '""') + '"'
                    ].join(',');
                    csvContent += line + '\n';
                });

                // הורדת הקובץ
                var today = new Date().toISOString().split('T')[0];
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'דוח_גבייה_' + today + '.csv';
                link.click();
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error('Export error:', error);
                alert('שגיאה בייצוא: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> ייצוא דוח';
            }
        }

        async function loadBillingData() {
            const loading = document.getElementById('bmLoading');
            const empty = document.getElementById('bmEmpty');
            const tableView = document.getElementById('bmTableView');
            const cardsView = document.getElementById('bmCardsView');

            loading.style.display = '';
            tableView.style.display = 'none';
            cardsView.style.display = 'none';
            empty.style.display = 'none';

            try {
                const snapshot = await db.collection('recurring_billing')
                    .orderBy('createdAt', 'desc')
                    .get();

                billingClients = [];
                snapshot.forEach(doc => {
                    billingClients.push({ id: doc.id, ...doc.data() });
                });

                // טעינת כל הנתונים מ-subcollection לכל לקוח (query אחד בלבד - ללא index מורכב)
                var subPromises = billingClients.map(function(c) {
                    return db.collection('recurring_billing').doc(c.id)
                        .collection('payments').get()
                        .then(function(snap) {
                            if (!snap.empty) {
                                var totalPlanned = 0;
                                var totalActual = 0;
                                var paidCount = 0;
                                var activeCount = 0;
                                var allPayments = [];
                                snap.forEach(function(d) {
                                    var p = d.data();
                                    allPayments.push(p);
                                    if (p.status !== 'בוטל') {
                                        totalPlanned += parseFloat(p.plannedAmount) || 0;
                                        activeCount++;
                                    }
                                    if (p.status === 'בוצע') {
                                        totalActual += parseFloat(p.actualAmountPaid) || parseFloat(p.plannedAmount) || 0;
                                        paidCount++;
                                    }
                                });

                                // מציאת התשלום הבא הממתין (מיון לפי monthNumber)
                                var pendingPayments = allPayments
                                    .filter(function(p) { return p.status === 'ממתין' || p.status === 'באיחור'; })
                                    .sort(function(a, b) { return (a.monthNumber || 0) - (b.monthNumber || 0); });

                                if (pendingPayments.length > 0) {
                                    c.nextPaymentAmount = parseFloat(pendingPayments[0].plannedAmount) || 0;
                                    c.nextPaymentDate = pendingPayments[0].plannedDate || '';
                                }

                                c._realTotalPlanned = totalPlanned;
                                c._realTotalActual = totalActual;
                                c._realPaidCount = paidCount;
                                c._realActiveCount = activeCount;
                                c._hasSubcollection = true;
                            }
                        })
                        .catch(function(err) { console.error('Error loading payments for', c.id, err); });
                });
                await Promise.all(subPromises);

                loading.style.display = 'none';

                if (billingClients.length === 0) {
                    empty.style.display = '';
                    return;
                }

                updateBillingSummary();
                renderBillingView();
            } catch (error) {
                console.error('Error loading billing data:', error);
                loading.innerHTML = '<p style="color:var(--error);">שגיאה בטעינת הנתונים</p>';
            }
        }

        function updateBillingSummary() {
            const active = billingClients.filter(c => c.status === 'פעיל' || !c.status);
            const totalMonthly = active.reduce((sum, c) => sum + (parseFloat(c.recurringMonthlyAmount) || 0), 0);

            let totalPaid = 0;
            let totalRemaining = 0;

            billingClients.forEach(c => {
                const amount = parseFloat(c.recurringMonthlyAmount) || 0;
                const totalMonths = parseInt(c.recurringMonthsCount) || 0;
                const totalDeal = c._hasSubcollection ? c._realTotalPlanned
                    : ((c.totalPlannedAmount !== undefined && c.totalPlannedAmount !== null)
                        ? parseFloat(c.totalPlannedAmount) : amount * totalMonths);
                const paid = c._hasSubcollection ? c._realTotalActual
                    : ((c.totalActualPaid !== undefined && c.totalActualPaid !== null)
                        ? parseFloat(c.totalActualPaid) || 0 : amount * calculatePaidMonths(c));

                totalPaid += paid;
                totalRemaining += totalDeal - paid;
            });

            document.getElementById('bmStatTotal').textContent = active.length;
            document.getElementById('bmStatMonthly').textContent = '₪' + totalMonthly.toLocaleString('he-IL');
            document.getElementById('bmStatPaid').textContent = '₪' + totalPaid.toLocaleString('he-IL');
            document.getElementById('bmStatRemaining').textContent = '₪' + Math.max(0, totalRemaining).toLocaleString('he-IL');
        }

        function calculatePaidMonths(client) {
            const alreadyPaid = parseInt(client.paidMonthsAlready) || 0;
            if (!client.recurringStartDate) return alreadyPaid;
            const start = new Date(client.recurringStartDate);
            const now = new Date();
            const totalMonths = parseInt(client.recurringMonthsCount) || 0;

            if (client.status === 'בוטל') return alreadyPaid;

            // diffMonths = כמה חודשים עברו מתאריך ההתחלה המקורי
            let diffMonths = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
            if (now.getDate() >= (parseInt(client.recurringDayOfMonth) || 1)) {
                diffMonths += 1;
            }
            diffMonths = Math.max(0, diffMonths);

            // alreadyPaid משמש כרצפה - למקרה שתאריך ההתחלה עתידי
            // אבל לא מצטבר מעל diffMonths כי הוא כבר נכלל בספירת החודשים
            return Math.min(Math.max(diffMonths, alreadyPaid), totalMonths);
        }

        function getNextReminderDate(client) {
            if (client.status === 'בוטל' || client.status === 'מושהה') return null;
            const start = new Date(client.recurringStartDate);
            const totalMonths = parseInt(client.recurringMonthsCount) || 0;
            const dayOfMonth = parseInt(client.recurringDayOfMonth) || 1;
            const now = new Date();

            for (let i = 0; i < totalMonths; i++) {
                const chargeDate = new Date(start.getFullYear(), start.getMonth() + i, dayOfMonth);
                if (chargeDate > now) {
                    return chargeDate;
                }
            }
            return null;
        }

        function formatDate(date) {
            if (!date) return '—';
            const d = date instanceof Date ? date : new Date(date);
            if (isNaN(d.getTime())) return '—';
            return d.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function getStatusBadge(status) {
            const s = status || 'פעיל';
            const map = { 'פעיל': 'active', 'מושהה': 'paused', 'בוטל': 'cancelled' };
            const cls = map[s] || 'active';
            return '<span class="bm-badge ' + cls + '">' + s + '</span>';
        }

        function setBillingFilter(filter, btn) {
            billingFilter = filter;
            document.querySelectorAll('.bm-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBillingView();
        }

        function setBillingViewMode(mode) {
            billingViewMode = mode;
            document.getElementById('bmViewTable').classList.toggle('active', mode === 'table');
            document.getElementById('bmViewCards').classList.toggle('active', mode === 'cards');
            document.getElementById('bmTableView').style.display = mode === 'table' ? '' : 'none';
            document.getElementById('bmCardsView').style.display = mode === 'cards' ? '' : 'none';
        }

        function filterBillingView() {
            renderBillingView();
        }

        function getFilteredClients() {
            let filtered = billingClients;

            if (billingFilter !== 'all') {
                filtered = filtered.filter(c => (c.status || 'פעיל') === billingFilter);
            }

            const search = (document.getElementById('bmSearch').value || '').trim().toLowerCase();
            if (search) {
                filtered = filtered.filter(c =>
                    (c.clientName || '').toLowerCase().includes(search) ||
                    (c.attorney || '').toLowerCase().includes(search) ||
                    (c.caseNumber || '').toLowerCase().includes(search) ||
                    (c.phone || '').includes(search)
                );
            }

            return filtered;
        }

        function renderBillingView() {
            const filtered = getFilteredClients();
            const tableView = document.getElementById('bmTableView');
            const cardsView = document.getElementById('bmCardsView');
            const empty = document.getElementById('bmEmpty');

            if (filtered.length === 0) {
                tableView.style.display = 'none';
                cardsView.style.display = 'none';
                empty.style.display = '';
                return;
            }

            empty.style.display = 'none';
            tableView.style.display = billingViewMode === 'table' ? '' : 'none';
            cardsView.style.display = billingViewMode === 'cards' ? '' : 'none';

            renderTableView(filtered);
            renderCardsView(filtered);
        }

        function renderTableView(clients) {
            const tbody = document.getElementById('bmTableBody');
            tbody.innerHTML = clients.map(c => {
                const amount = parseFloat(c.recurringMonthlyAmount) || 0;
                const totalMonths = c._hasSubcollection ? c._realActiveCount : (parseInt(c.recurringMonthsCount) || 0);
                const totalDeal = c._hasSubcollection ? c._realTotalPlanned
                    : ((c.totalPlannedAmount !== undefined && c.totalPlannedAmount !== null)
                        ? parseFloat(c.totalPlannedAmount) : amount * totalMonths);
                const paidMonths = c._hasSubcollection ? c._realPaidCount
                    : ((c.completedPaymentsCount !== undefined && c.completedPaymentsCount !== null)
                        ? parseInt(c.completedPaymentsCount) : calculatePaidMonths(c));
                const paidAmount = c._hasSubcollection ? c._realTotalActual
                    : ((c.totalActualPaid !== undefined && c.totalActualPaid !== null)
                        ? parseFloat(c.totalActualPaid) : amount * paidMonths);
                const progressPct = totalMonths > 0 ? Math.round((paidMonths / totalMonths) * 100) : 0;
                const progressClass = progressPct >= 80 ? ' high' : '';
                const nextDate = getNextReminderDate(c);
                const paidColor = paidAmount > 0 ? '#16a34a' : '#94a3b8';
                const uid = 'menu-' + c.id.replace(/[^a-zA-Z0-9]/g, '');

                // חיוב הבא: מ-subcollection, אם הכל בוצע - "הושלם", אם אין subcollection - חישוב מ-parent
                var nextPayDisplay;
                if (c.nextPaymentAmount !== undefined && c.nextPaymentAmount !== null) {
                    nextPayDisplay = '₪' + c.nextPaymentAmount.toLocaleString('he-IL');
                } else if (c._hasSubcollection) {
                    nextPayDisplay = '<span style="color:#16a34a;font-size:11px;">✓ הושלם</span>';
                } else {
                    nextPayDisplay = '₪' + amount.toLocaleString('he-IL');
                }

                return '<tr>' +
                    '<td><strong style="color:#0f172a;">' + (c.clientName || '') + '</strong>' +
                        (c.caseNumber ? '<br><span style="font-size:11px;color:#94a3b8;">תיק ' + c.caseNumber + '</span>' : '') +
                    '</td>' +
                    '<td style="color:#64748b;">' + (c.attorney || '—') + '</td>' +
                    '<td class="bm-amount">' + nextPayDisplay + '</td>' +
                    '<td class="bm-amount" style="color:#0f172a;">₪' + totalDeal.toLocaleString('he-IL') + '</td>' +
                    '<td class="bm-amount" style="color:' + paidColor + ';">₪' + paidAmount.toLocaleString('he-IL') + '</td>' +
                    '<td style="min-width:100px;">' +
                        '<span class="bm-progress-text">' + paidMonths + '/' + totalMonths + '</span>' +
                        '<div class="bm-progress-bar"><div class="bm-progress-fill' + progressClass + '" style="width:' + progressPct + '%"></div></div>' +
                    '</td>' +
                    '<td>' + getStatusBadge(c.status) + '</td>' +
                    '<td style="font-size:12px;">' + formatDate(nextDate) + '</td>' +
                    '<td style="white-space:nowrap;">' +
                        '<div style="display:flex;gap:6px;align-items:center;">' +
                            '<button class="bm-action-primary" onclick="openPaymentModal(\'' + c.id + '\')">תשלומים</button>' +
                            ((c.status || 'פעיל') === 'פעיל'
                                ? '<button class="bm-action-primary" onclick="quickMarkPayment(\'' + c.id + '\')" style="background:#16a34a;">סמן תשלום</button>'
                                : '') +
                            '<div class="bm-actions-dropdown">' +
                                '<button class="bm-actions-toggle" onclick="toggleActionsMenu(\'' + uid + '\', event)">⋮</button>' +
                                '<div class="bm-actions-menu" id="' + uid + '">' +
                                    '<button onclick="openEditModal(\'' + c.id + '\');closeAllMenus()">עריכה</button>' +
                                    '<a href="https://merchant.sensepass.com/apps/transactions/list" target="_blank" onclick="closeAllMenus()">סליקת אשראי</a>' +
                                    (c.cardLast4 ? '<button onclick="revealCard(\'' + c.id + '\');closeAllMenus()">הצג כרטיס</button>' : '') +
                                    (c.cardEncrypted ? '<button onclick="revealAndCopy(\'' + c.id + '\');closeAllMenus()">העתק כרטיס</button>' : '') +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function toggleActionsMenu(menuId, event) {
            event.stopPropagation();
            var menu = document.getElementById(menuId);
            var isOpen = menu.classList.contains('show');
            closeAllMenus();
            if (!isOpen) menu.classList.add('show');
        }
        function closeAllMenus() {
            document.querySelectorAll('.bm-actions-menu.show').forEach(function(m) {
                m.classList.remove('show');
            });
        }
        document.addEventListener('click', function() { closeAllMenus(); });

        function renderCardsView(clients) {
            const container = document.getElementById('bmCardsContainer');
            container.innerHTML = clients.map(c => {
                const amount = parseFloat(c.recurringMonthlyAmount) || 0;
                const totalMonths = c._hasSubcollection ? c._realActiveCount : (parseInt(c.recurringMonthsCount) || 0);
                const totalDeal = c._hasSubcollection ? c._realTotalPlanned
                    : ((c.totalPlannedAmount !== undefined && c.totalPlannedAmount !== null)
                        ? parseFloat(c.totalPlannedAmount) : amount * totalMonths);
                const paidMonths = c._hasSubcollection ? c._realPaidCount
                    : ((c.completedPaymentsCount !== undefined && c.completedPaymentsCount !== null)
                        ? parseInt(c.completedPaymentsCount) : calculatePaidMonths(c));
                const paidAmount = c._hasSubcollection ? c._realTotalActual
                    : ((c.totalActualPaid !== undefined && c.totalActualPaid !== null)
                        ? parseFloat(c.totalActualPaid) : amount * paidMonths);
                const remainingAmount = Math.max(0, totalDeal - paidAmount);
                const progressPct = totalMonths > 0 ? Math.round((paidMonths / totalMonths) * 100) : 0;
                const nextDate = getNextReminderDate(c);
                const progressClass = progressPct >= 80 ? ' high' : '';
                const paidColor = paidAmount > 0 ? '#16a34a' : '#94a3b8';
                const remainColor = remainingAmount > 0 ? '#dc2626' : '#16a34a';

                // חיוב הבא: מ-subcollection, אם הכל בוצע - "הושלם"
                var nextPayDisplay;
                if (c.nextPaymentAmount !== undefined && c.nextPaymentAmount !== null) {
                    nextPayDisplay = '₪' + c.nextPaymentAmount.toLocaleString('he-IL');
                } else if (c._hasSubcollection) {
                    nextPayDisplay = '<span style="color:#16a34a;font-size:11px;">✓ הושלם</span>';
                } else {
                    nextPayDisplay = '₪' + amount.toLocaleString('he-IL');
                }

                return '<div class="bm-card">' +
                    '<div class="bm-card-top">' +
                        '<div>' +
                            '<div class="bm-card-name">' + (c.clientName || '') + '</div>' +
                            '<div class="bm-card-case">' + (c.caseNumber ? 'תיק ' + c.caseNumber : '') + (c.attorney ? ' | ' + c.attorney : '') + '</div>' +
                        '</div>' +
                        '<div style="display:flex;align-items:center;gap:6px;">' +
                            getStatusBadge(c.status) +
                            '<button class="bm-action-secondary" onclick="openEditModal(\'' + c.id + '\')" style="padding:3px 8px;">עריכה</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="bm-card-body">' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">חיוב הבא <span style="font-size:9px;color:#94a3b8;">(כולל מע"מ)</span></div>' +
                            '<div class="bm-card-field-value">' + nextPayDisplay + '</div>' +
                        '</div>' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">סה"כ עסקה</div>' +
                            '<div class="bm-card-field-value">₪' + totalDeal.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">שולם</div>' +
                            '<div class="bm-card-field-value" style="color:' + paidColor + ';">₪' + paidAmount.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                        '<div class="bm-card-field">' +
                            '<div class="bm-card-field-label">נותר</div>' +
                            '<div class="bm-card-field-value" style="color:' + remainColor + ';">₪' + remainingAmount.toLocaleString('he-IL') + '</div>' +
                        '</div>' +
                    '</div>' +
                    (c.cardLast4 ?
                        '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:1px solid #f1f5f9;margin-bottom:6px;">' +
                            '<span style="font-size:12px;color:#64748b;font-variant-numeric:tabular-nums;">•••• ' + c.cardLast4 +
                                (c.cardType ? ' <span style="color:#94a3b8;">(' + c.cardType + ')</span>' : '') +
                                (c.cardExpiry ? ' <span style="color:#94a3b8;">' + c.cardExpiry + '</span>' : '') +
                            '</span>' +
                            '<button class="bm-action-secondary" onclick="revealCard(\'' + c.id + '\')" style="padding:3px 10px;">הצג מספר</button>' +
                        '</div>' : '') +
                    '<div class="bm-card-progress">' +
                        '<div class="bm-card-progress-text">' +
                            '<span>' + paidMonths + ' מתוך ' + totalMonths + ' תשלומים</span>' +
                            '<span>' + progressPct + '%</span>' +
                        '</div>' +
                        '<div class="bm-card-progress-bar"><div class="bm-card-progress-fill' + progressClass + '" style="width:' + progressPct + '%"></div></div>' +
                    '</div>' +
                    (nextDate ? '<div style="margin-top:10px;font-size:11px;color:#94a3b8;">חיוב הבא: ' + formatDate(nextDate) + '</div>' : '') +
                    '<div style="display:flex;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid #f1f5f9;">' +
                        '<button class="bm-action-primary" onclick="openPaymentModal(\'' + c.id + '\')" style="flex:1;text-align:center;padding:10px;">תשלומים</button>' +
                        ((c.status || 'פעיל') === 'פעיל'
                            ? '<button class="bm-action-primary" onclick="quickMarkPayment(\'' + c.id + '\')" style="flex:1;text-align:center;padding:10px;background:#16a34a;">סמן תשלום</button>'
                            : '') +
                    '</div>' +
                    '<div style="display:flex;gap:8px;margin-top:8px;">' +
                        '<a class="bm-action-secondary" href="https://merchant.sensepass.com/apps/transactions/list" target="_blank" style="flex:1;justify-content:center;padding:7px;">סליקת אשראי</a>' +
                        (c.cardEncrypted ? '<button class="bm-action-secondary" onclick="revealAndCopy(\'' + c.id + '\')" style="flex:1;justify-content:center;padding:7px;">העתק כרטיס</button>' : '') +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // ========== חשיפת מספר כרטיס מוצפן ==========

        async function revealCard(docId) {
            const passphrase = await requestPassword('decrypt');
            if (!passphrase) return;

            try {
                const doc = await db.collection('recurring_billing').doc(docId).get();
                if (!doc.exists) {
                    alert('הרשומה לא נמצאה');
                    return;
                }

                const data = doc.data();
                if (!data.cardEncrypted) {
                    alert('אין מספר כרטיס מוצפן לרשומה זו');
                    return;
                }

                const decrypted = decryptCardData(data.cardEncrypted, passphrase);
                if (!decrypted) {
                    alert('סיסמה שגויה');
                    return;
                }

                // רישום לוג צפייה
                logCardView(docId, data.clientName);

                // פענוח CVV אם קיים
                var cvvDecrypted = '';
                if (data.cvvEncrypted) {
                    cvvDecrypted = decryptCardData(data.cvvEncrypted, passphrase) || '';
                }

                // הצגת המספר בחלון מעוצב שנסגר אוטומטית
                var formatted = decrypted.replace(/(\d{4})(?=\d)/g, '$1 ');
                var overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;';
                overlay.innerHTML =
                    '<div style="background:white;border-radius:16px;padding:28px;max-width:360px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">' +
                        '<div style="margin-bottom:16px;">' +
                            '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>' +
                        '</div>' +
                        '<div style="font-size:13px;color:#6b7280;margin-bottom:8px;">' + (data.cardHolder || data.clientName || '') + '</div>' +
                        '<div style="font-size:22px;font-weight:700;letter-spacing:3px;direction:ltr;font-variant-numeric:tabular-nums;color:#1f2937;margin-bottom:6px;">' + formatted + '</div>' +
                        '<div style="display:flex;justify-content:center;gap:20px;margin-top:10px;">' +
                            (data.cardExpiry ? '<div><div style="font-size:11px;color:#9ca3af;">תוקף</div><div style="font-size:15px;font-weight:600;color:#374151;direction:ltr;">' + data.cardExpiry + '</div></div>' : '') +
                            (cvvDecrypted ? '<div><div style="font-size:11px;color:#9ca3af;">CVV</div><div style="font-size:15px;font-weight:600;color:#374151;direction:ltr;">' + cvvDecrypted + '</div></div>' : '') +
                        '</div>' +
                        (data.cardType ? '<div style="font-size:12px;color:#9ca3af;margin-top:8px;">' + data.cardType + '</div>' : '') +
                        '<div style="font-size:11px;color:#ef4444;margin-top:14px;">החלון ייסגר אוטומטית בעוד 30 שניות</div>' +
                        '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="margin-top:14px;background:#2563eb;color:white;border:none;padding:8px 28px;border-radius:8px;font-family:Heebo,sans-serif;font-size:14px;font-weight:600;cursor:pointer;">סגור</button>' +
                    '</div>';
                document.body.appendChild(overlay);
                overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });

                // סגירה אוטומטית אחרי 30 שניות
                setTimeout(function() { if (overlay.parentNode) overlay.remove(); }, 30000);

            } catch (error) {
                console.error('Error revealing card:', error);
                alert('שגיאה בטעינת הנתונים');
            }
        }

        // ========== העתקת פרטי כרטיס ==========

        async function revealAndCopy(docId) {
            const passphrase = await requestPassword('decrypt');
            if (!passphrase) return;

            try {
                const doc = await db.collection('recurring_billing').doc(docId).get();
                if (!doc.exists) { alert('הרשומה לא נמצאה'); return; }

                const data = doc.data();
                if (!data.cardEncrypted) { alert('אין פרטי כרטיס לרשומה זו'); return; }

                const decrypted = decryptCardData(data.cardEncrypted, passphrase);
                if (!decrypted) { alert('סיסמה שגויה'); return; }

                logCardView(docId, data.clientName);

                var cvvDecrypted = data.cvvEncrypted ? (decryptCardData(data.cvvEncrypted, passphrase) || '') : '';
                var formatted = decrypted.replace(/(\d{4})(?=\d)/g, '$1 ');

                var overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.55);z-index:2000;display:flex;align-items:center;justify-content:center;';
                overlay.innerHTML =
                    '<div style="background:white;border-radius:16px;padding:28px;max-width:400px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">' +
                        '<div style="text-align:center;margin-bottom:18px;">' +
                            '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>' +
                            '<div style="font-size:15px;font-weight:700;color:#1f2937;margin-top:8px;">' + (data.clientName || '') + '</div>' +
                        '</div>' +
                        '<div style="display:flex;flex-direction:column;gap:8px;">' +
                            '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">מספר כרטיס</div><div style="font-size:16px;font-weight:600;direction:ltr;font-variant-numeric:tabular-nums;color:#1f2937;">' + formatted + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + decrypted + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;white-space:nowrap;">העתק</button>' +
                            '</div>' +
                            (data.cardExpiry ? '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">תוקף</div><div style="font-size:15px;font-weight:600;direction:ltr;color:#1f2937;">' + data.cardExpiry + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + data.cardExpiry + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק</button>' +
                            '</div>' : '') +
                            (cvvDecrypted ? '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">CVV</div><div style="font-size:15px;font-weight:600;direction:ltr;color:#1f2937;">' + cvvDecrypted + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + cvvDecrypted + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק</button>' +
                            '</div>' : '') +
                            (data.cardHolder ? '<div style="display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;">' +
                                '<div><div style="font-size:10px;color:#9ca3af;">שם בעל הכרטיס</div><div style="font-size:14px;font-weight:600;color:#1f2937;">' + data.cardHolder + '</div></div>' +
                                '<button onclick="copyToClipboard(\'' + (data.cardHolder || '').replace(/'/g, "\\'") + '\', this)" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-family:Heebo,sans-serif;font-weight:600;cursor:pointer;">העתק</button>' +
                            '</div>' : '') +
                        '</div>' +
                        '<div style="text-align:center;margin-top:16px;">' +
                            '<div style="font-size:11px;color:#ef4444;margin-bottom:10px;">החלון ייסגר אוטומטית בעוד 30 שניות</div>' +
                            '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:#2563eb;color:white;border:none;padding:8px 28px;border-radius:8px;font-family:Heebo,sans-serif;font-size:14px;font-weight:600;cursor:pointer;">סגור</button>' +
                        '</div>' +
                    '</div>';
                document.body.appendChild(overlay);
                overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
                setTimeout(function() { if (overlay.parentNode) overlay.remove(); }, 30000);

            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בטעינת הנתונים');
            }
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(function() {
                var original = btn.textContent;
                btn.textContent = 'הועתק!';
                btn.style.background = '#10b981';
                setTimeout(function() {
                    btn.textContent = original;
                    btn.style.background = '#2563eb';
                }, 1500);
            }).catch(function() {
                // fallback
                var input = document.createElement('input');
                input.value = text;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                var original = btn.textContent;
                btn.textContent = 'הועתק!';
                btn.style.background = '#10b981';
                setTimeout(function() {
                    btn.textContent = original;
                    btn.style.background = '#2563eb';
                }, 1500);
            });
        }

        // ========== עריכת לקוח גבייה ==========

        let editingDocId = null;

        async function openEditModal(docId) {
            editingDocId = docId;
            editPaymentsCache = []; // איפוס cache
            try {
                const doc = await db.collection('recurring_billing').doc(docId).get();
                if (!doc.exists) {
                    alert('הרשומה לא נמצאה');
                    return;
                }
                const d = doc.data();

                document.getElementById('editDocId').value = docId;
                document.getElementById('editClientName').value = d.clientName || '';
                document.getElementById('editPhone').value = d.phone || '';
                document.getElementById('editEmail').value = d.email || '';
                document.getElementById('editIdNumber').value = d.idNumber || '';
                document.getElementById('editAddress').value = d.address || '';
                // טעינת סכום כולל אמיתי מ-subcollection (מקור אמת יחיד)
                var realTotalPlanned = 0;
                var realActiveCount = 0;
                var subSnap = await db.collection('recurring_billing').doc(docId)
                    .collection('payments').get();
                if (!subSnap.empty) {
                    subSnap.forEach(function(sd) {
                        var sp = sd.data();
                        if (sp.status !== 'בוטל') {
                            realTotalPlanned += parseFloat(sp.plannedAmount) || 0;
                            realActiveCount++;
                        }
                    });
                }

                var editTotalDeal = realTotalPlanned > 0 ? realTotalPlanned
                    : (d.totalPlannedAmount || (parseFloat(d.recurringMonthlyAmount || 0) * parseInt(d.recurringMonthsCount || 1)));
                document.getElementById('editTotalDeal').value = editTotalDeal || '';
                var editMonthsNum = realActiveCount > 0 ? realActiveCount : (parseInt(d.recurringMonthsCount) || 1);
                document.getElementById('editMonths').value = editMonthsNum;
                document.getElementById('editAmount').value = editTotalDeal ? Math.round(editTotalDeal / editMonthsNum) : (d.recurringMonthlyAmount || '');
                document.getElementById('editStartDate').value = d.recurringStartDate || '';
                document.getElementById('editDayOfMonth').value = d.recurringDayOfMonth || '1';
                document.getElementById('editPaidMonths').value = d.paidMonthsAlready || '0';
                document.getElementById('editStatus').value = d.status || 'פעיל';
                document.getElementById('editAttorney').value = d.attorney || '';
                document.getElementById('editCaseNumber').value = d.caseNumber || '';
                document.getElementById('editNotes').value = d.recurringNotes || '';

                // Card fields
                document.getElementById('editCardNumber').value = '';
                document.getElementById('editCardCvv').value = '';
                document.getElementById('editCardExpiry').value = d.cardExpiry || '';
                document.getElementById('editCardHolder').value = d.cardHolder || '';
                document.getElementById('editCardType').value = d.cardType || '';
                document.getElementById('editCardStatus').textContent = d.cardLast4
                    ? 'כרטיס קיים: •••• ' + d.cardLast4 + (d.cardType ? ' (' + d.cardType + ')' : '')
                    : 'לא הוזן כרטיס';

                // טעינת תשלומים מ-subcollection להצגה בטבלת עריכה
                await loadEditAmountsTable(docId, d);

                document.getElementById('editModalOverlay').classList.add('show');
            } catch (error) {
                console.error('Error loading client:', error);
                alert('שגיאה בטעינת הנתונים');
            }
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').classList.remove('show');
            editingDocId = null;
        }

        async function saveEditBilling() {
            const docId = document.getElementById('editDocId').value;
            const clientName = document.getElementById('editClientName').value.trim();
            const editTotalDeal = document.getElementById('editTotalDeal').value;
            const amount = document.getElementById('editAmount').value;
            const months = document.getElementById('editMonths').value;

            if (!clientName || !editTotalDeal || !months) {
                alert('נא למלא שם לקוח, סכום כולל ומספר תשלומים');
                return;
            }

            const saveBtn = document.getElementById('editSaveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'שומר...';

            try {
                const editTotalDealNum = parseFloat(editTotalDeal);
                const editMonthsNum = parseInt(months);
                const editPerPayment = amount ? parseFloat(amount) : Math.round(editTotalDealNum / editMonthsNum);

                const updateData = {
                    clientName: clientName,
                    phone: document.getElementById('editPhone').value || '',
                    email: document.getElementById('editEmail').value || '',
                    idNumber: document.getElementById('editIdNumber').value || '',
                    address: document.getElementById('editAddress').value || '',
                    totalPlannedAmount: editTotalDealNum,
                    recurringMonthlyAmount: editPerPayment,
                    recurringMonthsCount: months,
                    recurringStartDate: document.getElementById('editStartDate').value || '',
                    recurringDayOfMonth: document.getElementById('editDayOfMonth').value || '1',
                    paidMonthsAlready: parseInt(document.getElementById('editPaidMonths').value) || 0,
                    status: document.getElementById('editStatus').value || 'פעיל',
                    attorney: document.getElementById('editAttorney').value || '',
                    caseNumber: document.getElementById('editCaseNumber').value || '',
                    recurringNotes: document.getElementById('editNotes').value || '',
                    cardExpiry: document.getElementById('editCardExpiry').value || '',
                    cardHolder: document.getElementById('editCardHolder').value || '',
                    cardType: document.getElementById('editCardType').value || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: authUser ? authUser.email : (currentUser || 'לא ידוע')
                };

                // הצפנת כרטיס חדש אם הוזן
                const newCardNumber = (document.getElementById('editCardNumber').value || '').replace(/\s/g, '');
                if (newCardNumber && newCardNumber.length >= 13) {
                    const passphrase = await requestPassword('encrypt');
                    if (!passphrase) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'שמור שינויים';
                        return;
                    }
                    updateData.cardEncrypted = encryptCardData(newCardNumber, passphrase);
                    updateData.cardLast4 = newCardNumber.slice(-4);
                    const newCvv = document.getElementById('editCardCvv').value || '';
                    if (newCvv) {
                        updateData.cvvEncrypted = encryptCardData(newCvv, passphrase);
                    }
                }

                // קריאת נתוני הלקוח הישנים לפני העדכון (לצורך השוואה בסנכרון)
                const oldClientDoc = await db.collection('recurring_billing').doc(docId).get();
                const oldClientData = oldClientDoc.data();

                await db.collection('recurring_billing').doc(docId).update(updateData);

                // עדכון סכומים ישירות ב-subcollection (מקור אמת יחיד)
                var editedAmounts = getEditMonthlyAmountsFromTable();
                if (editedAmounts) {
                    var batch = db.batch();
                    Object.keys(editedAmounts).forEach(function(payId) {
                        var ref = db.collection('recurring_billing').doc(docId)
                            .collection('payments').doc(payId);
                        batch.update(ref, { plannedAmount: editedAmounts[payId] });
                    });
                    await batch.commit();
                }

                // סנכרון שאר שינויים (תאריכים, מספר תשלומים וכו')
                await syncPaymentsAfterEdit(docId, oldClientData, updateData);

                // חישוב מחדש של כל הסיכומים מ-subcollection
                await recalcClientSummary(docId);

                closeEditModal();
                loadBillingData(); // רענון התצוגה
            } catch (error) {
                console.error('Error saving edit:', error);
                alert('שגיאה בשמירה: ' + error.message);
            }

            saveBtn.disabled = false;
            saveBtn.textContent = 'שמור שינויים';
        }

        // סנכרון subcollection payments אחרי עריכה - מטפל בכל השדות
        async function syncPaymentsAfterEdit(docId, oldData, newData) {
            try {
                var paymentsSnap = await db.collection('recurring_billing').doc(docId)
                    .collection('payments').orderBy('monthNumber').get();

                // אם אין subcollection - אין מה לסנכרן, יווצר בפתיחת מודאל
                if (paymentsSnap.empty) return;

                var oldAmount = parseFloat(oldData.recurringMonthlyAmount) || 0;
                var newAmount = parseFloat(newData.recurringMonthlyAmount) || 0;
                var oldMonths = parseInt(oldData.recurringMonthsCount) || 0;
                var newMonths = parseInt(newData.recurringMonthsCount) || 0;
                var oldStartDate = oldData.recurringStartDate || '';
                var newStartDate = newData.recurringStartDate || oldStartDate;
                var oldDayOfMonth = parseInt(oldData.recurringDayOfMonth) || 1;
                var newDayOfMonth = parseInt(newData.recurringDayOfMonth) || oldDayOfMonth;
                var newPaidAlready = parseInt(newData.paidMonthsAlready) || 0;
                var oldPaid = parseInt(oldData.paidMonthsAlready) || 0;
                var billingPrefix = oldData.billingIdPrefix || '';

                // בדיקה אם תאריכים השתנו (תאריך התחלה או יום בחודש)
                var datesChanged = (newStartDate !== oldStartDate) || (newDayOfMonth !== oldDayOfMonth);

                var existingPayments = [];
                paymentsSnap.forEach(function(doc) {
                    existingPayments.push({ id: doc.id, data: doc.data() });
                });

                var batch = db.batch();
                var hasChanges = false;
                var start = newStartDate ? new Date(newStartDate) : new Date();

                // 1. עדכון תאריכים לתשלומים שלא בוצעו (אם שונה תאריך התחלה או יום בחודש)
                if (datesChanged) {
                    existingPayments.forEach(function(p) {
                        if (p.data.status !== 'בוצע' && p.data.status !== 'בוטל') {
                            var monthIdx = p.data.monthNumber - 1;
                            var newChargeDate = new Date(start.getFullYear(), start.getMonth() + monthIdx, newDayOfMonth);
                            if (newChargeDate.getDate() !== newDayOfMonth) {
                                newChargeDate.setDate(0); // סוף חודש קודם אם היום לא קיים
                            }
                            var newDateStr = newChargeDate.toISOString().split('T')[0];
                            if (newDateStr !== p.data.plannedDate) {
                                var ref = db.collection('recurring_billing').doc(docId)
                                    .collection('payments').doc(p.id);
                                batch.update(ref, { plannedDate: newDateStr });
                                hasChanges = true;
                            }
                        }
                    });
                }

                // 2. עדכון סכום מתוכנן לתשלומים שלא בוצעו
                if (oldAmount !== newAmount) {
                    existingPayments.forEach(function(p) {
                        if (p.data.status !== 'בוצע' && p.data.status !== 'בוטל') {
                            var pAmount = parseFloat(p.data.plannedAmount) || 0;
                            if (pAmount === oldAmount) {
                                var ref = db.collection('recurring_billing').doc(docId)
                                    .collection('payments').doc(p.id);
                                batch.update(ref, { plannedAmount: newAmount });
                                hasChanges = true;
                            }
                        }
                    });
                }

                // 3. עדכון סטטוס paidMonthsAlready
                if (newPaidAlready !== oldPaid) {
                    existingPayments.forEach(function(p) {
                        var monthNum = p.data.monthNumber;
                        var ref = db.collection('recurring_billing').doc(docId)
                            .collection('payments').doc(p.id);
                        if (monthNum <= newPaidAlready && p.data.status !== 'בוצע') {
                            batch.update(ref, {
                                status: 'בוצע',
                                actualAmountPaid: parseFloat(p.data.plannedAmount) || newAmount,
                                actualPaymentDate: p.data.plannedDate,
                                completedBy: 'עריכה ידנית',
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            hasChanges = true;
                        } else if (monthNum > newPaidAlready && p.data.status === 'בוצע' && (p.data.completedBy === 'מיגרציה' || p.data.completedBy === 'עריכה ידנית')) {
                            batch.update(ref, {
                                status: 'ממתין',
                                actualAmountPaid: null,
                                actualPaymentDate: null,
                                completedBy: null,
                                completedAt: null
                            });
                            hasChanges = true;
                        }
                    });
                }

                // 4. הפחתת חודשים - ביטול תשלומים עודפים
                if (newMonths < existingPayments.length) {
                    existingPayments.forEach(function(p) {
                        if (p.data.monthNumber > newMonths && p.data.status !== 'בוצע') {
                            var ref = db.collection('recurring_billing').doc(docId)
                                .collection('payments').doc(p.id);
                            batch.update(ref, {
                                status: 'בוטל',
                                notes: 'בוטל - הופחת מספר תשלומים'
                            });
                            hasChanges = true;
                        }
                    });
                }

                // 5. הוספת חודשים חדשים אם מספר החודשים גדל
                if (newMonths > existingPayments.length) {
                    for (var i = existingPayments.length; i < newMonths; i++) {
                        var chargeDate = new Date(start.getFullYear(), start.getMonth() + i, newDayOfMonth);
                        if (chargeDate.getDate() !== newDayOfMonth) {
                            chargeDate.setDate(0);
                        }
                        var payRef = db.collection('recurring_billing').doc(docId)
                            .collection('payments').doc();
                        batch.set(payRef, {
                            monthNumber: i + 1,
                            plannedAmount: newAmount,
                            plannedDate: chargeDate.toISOString().split('T')[0],
                            billingIdSuffix: billingPrefix ? billingPrefix + '-' + (i + 1) : '',
                            status: i < newPaidAlready ? 'בוצע' : 'ממתין',
                            actualAmountPaid: i < newPaidAlready ? newAmount : null,
                            actualPaymentDate: i < newPaidAlready ? chargeDate.toISOString().split('T')[0] : null,
                            completedBy: i < newPaidAlready ? 'עריכה ידנית' : null,
                            completedAt: i < newPaidAlready ? firebase.firestore.FieldValue.serverTimestamp() : null,
                            notes: ''
                        });
                        hasChanges = true;
                    }
                }

                // 6. שחזור תשלומים שבוטלו אם מספר החודשים חזר לגדול
                if (newMonths >= existingPayments.length) {
                    existingPayments.forEach(function(p) {
                        if (p.data.status === 'בוטל' && p.data.monthNumber <= newMonths && (p.data.notes || '').indexOf('הופחת מספר תשלומים') > -1) {
                            var ref = db.collection('recurring_billing').doc(docId)
                                .collection('payments').doc(p.id);
                            batch.update(ref, {
                                status: p.data.monthNumber <= newPaidAlready ? 'בוצע' : 'ממתין',
                                notes: ''
                            });
                            hasChanges = true;
                        }
                    });
                }

                if (hasChanges) {
                    await batch.commit();

                    // עדכון שדות סיכום בלקוח
                    await recalcClientSummary(docId);
                }
            } catch (error) {
                console.error('Error syncing payments after edit:', error);
            }
        }

        // ========== מודאל פירוט תשלומים ==========

        let currentPaymentDocId = null;
        let currentPayments = [];

        async function openPaymentModal(docId) {
            currentPaymentDocId = docId;
            const overlay = document.getElementById('pmOverlay');

            try {
                const clientDoc = await db.collection('recurring_billing').doc(docId).get();
                if (!clientDoc.exists) {
                    alert('הלקוח לא נמצא');
                    return;
                }
                const client = { id: docId, ...clientDoc.data() };
                document.getElementById('pmTitle').textContent = 'תשלומים - ' + (client.clientName || '');

                // טעינת תשלומים מ-Firebase subcollection
                const paymentsSnap = await db.collection('recurring_billing').doc(docId)
                    .collection('payments').orderBy('monthNumber', 'asc').get();

                if (paymentsSnap.empty) {
                    // מיגרציה חד-פעמית: יצירת מסמכי תשלומים מנתוני הלקוח
                    await generatePaymentDocs(docId, client);
                    const snap2 = await db.collection('recurring_billing').doc(docId)
                        .collection('payments').orderBy('monthNumber', 'asc').get();
                    currentPayments = [];
                    snap2.forEach(function(d) { currentPayments.push({ id: d.id, ...d.data() }); });
                } else {
                    currentPayments = [];
                    paymentsSnap.forEach(function(d) { currentPayments.push({ id: d.id, ...d.data() }); });
                }

                renderPaymentModal(client, currentPayments);
                overlay.classList.add('show');

            } catch (error) {
                console.error('Error opening payment modal:', error);
                alert('שגיאה בטעינת תשלומים: ' + error.message);
            }
        }



        async function generatePaymentDocs(docId, client) {
            const amount = parseFloat(client.recurringMonthlyAmount) || 0;
            const totalMonths = parseInt(client.recurringMonthsCount) || 0;
            const startStr = client.recurringStartDate;
            if (!startStr || !totalMonths) return;

            const start = new Date(startStr);
            const dayOfMonth = parseInt(client.recurringDayOfMonth) || 1;
            const paidAlready = parseInt(client.paidMonthsAlready) || 0;
            const billingPrefix = client.billingIdPrefix || '';

            // בדיקה אם יש סכומים מותאמים לכל חודש
            let monthlyAmounts = null;
            if (client.monthlyAmounts && Array.isArray(client.monthlyAmounts)) {
                monthlyAmounts = client.monthlyAmounts;
            }

            const batch = db.batch();

            for (let i = 0; i < totalMonths; i++) {
                const chargeDate = new Date(start.getFullYear(), start.getMonth() + i, dayOfMonth);
                if (chargeDate.getDate() !== dayOfMonth) {
                    chargeDate.setDate(0);
                }

                const thisMonthAmount = (monthlyAmounts && monthlyAmounts[i] !== undefined)
                    ? parseFloat(monthlyAmounts[i]) : amount;
                const isAlreadyPaid = i < paidAlready;
                const payRef = db.collection('recurring_billing').doc(docId)
                    .collection('payments').doc();

                batch.set(payRef, {
                    monthNumber: i + 1,
                    plannedAmount: thisMonthAmount,
                    plannedDate: chargeDate.toISOString().split('T')[0],
                    billingIdSuffix: billingPrefix ? billingPrefix + '-' + (i + 1) : '',
                    status: isAlreadyPaid ? 'בוצע' : 'ממתין',
                    actualAmountPaid: isAlreadyPaid ? thisMonthAmount : null,
                    actualPaymentDate: isAlreadyPaid ? chargeDate.toISOString().split('T')[0] : null,
                    completedBy: isAlreadyPaid ? 'מיגרציה' : null,
                    completedAt: isAlreadyPaid ? firebase.firestore.FieldValue.serverTimestamp() : null,
                    notes: ''
                });
            }

            await batch.commit();

            // עדכון שדות סיכום בלקוח
            let paidTotal = 0;
            let plannedTotal = 0;
            for (let i = 0; i < totalMonths; i++) {
                let thisAmount = (monthlyAmounts && monthlyAmounts[i] !== undefined)
                    ? parseFloat(monthlyAmounts[i]) : amount;
                plannedTotal += thisAmount;
                if (i < paidAlready) paidTotal += thisAmount;
            }
            await db.collection('recurring_billing').doc(docId).update({
                totalActualPaid: paidTotal,
                totalPlannedAmount: plannedTotal,
                completedPaymentsCount: paidAlready,
                billingIdPrefix: billingPrefix || ''
            });
        }

        function formatDateHebrew(dateStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return day + '/' + month + '/' + year;
            } catch(e) {
                return dateStr;
            }
        }

        function renderPaymentModal(client, payments) {
            const amount = parseFloat(client.recurringMonthlyAmount) || 0;
            const totalPlanned = payments.reduce(function(sum, p) { return sum + (parseFloat(p.plannedAmount) || amount); }, 0);
            const completedPayments = payments.filter(function(p) { return p.status === 'בוצע'; });
            const totalActualPaid = completedPayments.reduce(function(sum, p) {
                return sum + (parseFloat(p.actualAmountPaid) || parseFloat(p.plannedAmount) || 0);
            }, 0);
            const remaining = totalPlanned - totalActualPaid;
            const completedCount = completedPayments.length;
            const totalMonths = payments.length;

            // סרגל סיכום
            document.getElementById('pmClientSummary').innerHTML =
                '<div class="pm-summary-item">' +
                    '<div class="pm-summary-label">סה"כ עסקה <span style="font-size:10px;color:#94a3b8;">(כולל מע"מ)</span></div>' +
                    '<div class="pm-summary-value">₪' + totalPlanned.toLocaleString('he-IL') + '</div>' +
                '</div>' +
                '<div class="pm-summary-item">' +
                    '<div class="pm-summary-label">שולם בפועל</div>' +
                    '<div class="pm-summary-value" style="color:#10b981;">₪' + totalActualPaid.toLocaleString('he-IL') + '</div>' +
                '</div>' +
                '<div class="pm-summary-item">' +
                    '<div class="pm-summary-label">יתרה</div>' +
                    '<div class="pm-summary-value" style="color:#ef4444;">₪' + Math.max(0, remaining).toLocaleString('he-IL') + '</div>' +
                '</div>' +
                '<div class="pm-summary-item">' +
                    '<div class="pm-summary-label">תשלומים</div>' +
                    '<div class="pm-summary-value">' + completedCount + '/' + totalMonths + '</div>' +
                '</div>';

            // רשימת תשלומים
            var container = document.getElementById('pmPaymentsList');
            container.innerHTML = payments.map(function(p) {
                var isCompleted = p.status === 'בוצע';
                var isOverdue = p.status === 'באיחור';
                var isCancelled = p.status === 'בוטל';
                var rowClass = isCompleted ? 'completed' : (isOverdue ? 'overdue' : (isCancelled ? 'cancelled' : ''));
                var plannedAmt = parseFloat(p.plannedAmount) || amount;

                // בדיקה אם תאריך חלף (לסימון אוטומטי כבאיחור)
                if (!isCompleted && !isCancelled && !isOverdue && p.plannedDate) {
                    var pDate = new Date(p.plannedDate);
                    var today = new Date();
                    today.setHours(0,0,0,0);
                    if (pDate < today) {
                        rowClass = 'overdue';
                    }
                }

                var actualAmt = parseFloat(p.actualAmountPaid) || plannedAmt;

                return '<div class="pm-payment-row ' + rowClass + '" data-payment-id="' + p.id + '">' +
                    '<div class="pm-month-num">' + p.monthNumber + '</div>' +
                    '<div style="font-size:13px;">' +
                        formatDateHebrew(p.plannedDate) +
                        (isCompleted && p.actualPaymentDate ?
                            '<br><span style="font-size:11px;color:var(--gray-400);">שולם: ' + formatDateHebrew(p.actualPaymentDate) + '</span>' : '') +
                    '</div>' +
                    '<div style="text-align:center;">' +
                        (isCancelled
                            ? '<span style="font-size:13px;">₪' + plannedAmt.toLocaleString('he-IL') + '</span>'
                            : '<input type="number" class="pm-amount-input" value="' + plannedAmt + '" ' +
                              'onchange="updatePlannedAmount(\'' + p.id + '\', this.value)" min="0" step="0.01">') +
                    '</div>' +
                    '<div style="text-align:center;">' +
                        (isCompleted
                            ? '<input type="number" class="pm-amount-input" value="' + actualAmt + '" ' +
                              'onchange="updateActualAmount(\'' + p.id + '\', this.value)" min="0" step="0.01" ' +
                              'style="color:#10b981;font-weight:600;">'
                            : '<span style="color:var(--gray-300);font-size:13px;">—</span>') +
                    '</div>' +
                    '<div style="text-align:center;display:flex;gap:4px;align-items:center;justify-content:center;">' +
                        (isCompleted
                            ? '<button class="pm-mark-btn already-done" onclick="editCompletedPayment(\'' +
                              currentPaymentDocId + '\',\'' + p.id + '\')" style="cursor:pointer;" title="לחץ לעריכה">&#10004; בוצע</button>'
                            : (isCancelled
                                ? '<span style="color:var(--gray-400);font-size:11px;">בוטל</span>'
                                : '<button class="pm-mark-btn mark-done" onclick="markSinglePayment(\'' +
                                  currentPaymentDocId + '\',\'' + p.id + '\')">סמן כבוצע</button>')) +
                        '<button onclick="deletePayment(\'' + currentPaymentDocId + '\',\'' + p.id + '\',' + p.monthNumber + ')" ' +
                            'style="background:none;border:none;color:#cbd5e1;cursor:pointer;font-size:14px;padding:2px 4px;line-height:1;" ' +
                            'title="הסר תשלום מהסדרה">&#10005;</button>' +
                    '</div>' +
                '</div>';
            }).join('');

            // סיכום חשבונאי
            renderAccountingSummary(client, payments);

            // עדכון כפתור "סמן הבא"
            var nextPending = payments.find(function(p) { return p.status === 'ממתין' || p.status === 'באיחור'; });
            var markBtn = document.getElementById('pmMarkAllBtn');
            if (!nextPending) {
                markBtn.disabled = true;
                markBtn.textContent = 'כל התשלומים בוצעו';
            } else {
                markBtn.disabled = false;
                markBtn.textContent = 'סמן תשלום #' + nextPending.monthNumber + ' כבוצע';
            }
        }

        function renderAccountingSummary(client, payments) {
            var amount = parseFloat(client.recurringMonthlyAmount) || 0;
            var totalPlanned = payments.reduce(function(sum, p) { return sum + (parseFloat(p.plannedAmount) || amount); }, 0);
            var completedPayments = payments.filter(function(p) { return p.status === 'בוצע'; });
            var totalActualPaid = completedPayments.reduce(function(sum, p) {
                return sum + (parseFloat(p.actualAmountPaid) || parseFloat(p.plannedAmount) || 0);
            }, 0);
            var totalPlannedForCompleted = completedPayments.reduce(function(sum, p) {
                return sum + (parseFloat(p.plannedAmount) || 0);
            }, 0);
            var difference = totalActualPaid - totalPlannedForCompleted;
            var remaining = totalPlanned - totalActualPaid;

            document.getElementById('pmAccounting').innerHTML =
                '<div class="pm-accounting-title">סיכום חשבונאי <span style="font-size:11px;font-weight:400;color:#94a3b8;">(כל הסכומים כוללים מע"מ)</span></div>' +
                '<div class="pm-accounting-row">' +
                    '<span>סה"כ מתוכנן (כל התשלומים)</span>' +
                    '<span>₪' + totalPlanned.toLocaleString('he-IL') + '</span>' +
                '</div>' +
                '<div class="pm-accounting-row">' +
                    '<span>סה"כ שולם בפועל</span>' +
                    '<span style="color:#10b981;">₪' + totalActualPaid.toLocaleString('he-IL') + '</span>' +
                '</div>' +
                (difference !== 0 ?
                '<div class="pm-accounting-row">' +
                    '<span>הפרש (בפועל לעומת מתוכנן)</span>' +
                    '<span style="color:' + (difference >= 0 ? '#10b981' : '#ef4444') + ';">₪' +
                    difference.toLocaleString('he-IL') + '</span>' +
                '</div>' : '') +
                '<div class="pm-accounting-row total">' +
                    '<span>יתרת גבייה</span>' +
                    '<span style="color:#ef4444;">₪' + Math.max(0, remaining).toLocaleString('he-IL') + '</span>' +
                '</div>';
        }

        async function markSinglePayment(clientDocId, paymentDocId) {
            var paymentRow = document.querySelector('[data-payment-id="' + paymentDocId + '"]');
            var amountInput = paymentRow ? paymentRow.querySelector('.pm-amount-input') : null;
            var payData = currentPayments.find(function(p) { return p.id === paymentDocId; });
            var plannedAmount = amountInput ? parseFloat(amountInput.value) : (payData ? parseFloat(payData.plannedAmount) : 0);

            // prompt לסכום בפועל
            var actualAmountStr = prompt('סכום ששולם בפועל:', plannedAmount ? plannedAmount.toString() : '');
            if (actualAmountStr === null) return;

            var actualAmount = parseFloat(actualAmountStr);
            if (isNaN(actualAmount) || actualAmount < 0) {
                alert('סכום לא תקין');
                return;
            }

            // prompt לתאריך תשלום
            var today = new Date().toISOString().split('T')[0];
            var actualDate = prompt('תאריך תשלום (YYYY-MM-DD):', today);
            if (actualDate === null) return;

            try {
                // 1. עדכון Firebase subcollection
                var payRef = db.collection('recurring_billing').doc(clientDocId)
                    .collection('payments').doc(paymentDocId);

                await payRef.update({
                    status: 'בוצע',
                    actualAmountPaid: actualAmount,
                    actualPaymentDate: actualDate,
                    completedBy: currentUser || 'webapp',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. חישוב מחדש של כל הסיכומים מ-subcollection (מקור אמת יחיד)
                await recalcClientSummary(clientDocId);

                // 3. רענון המודאל
                await openPaymentModal(clientDocId);

            } catch (error) {
                console.error('Error marking payment:', error);
                alert('שגיאה בסימון תשלום: ' + error.message);
            }
        }

        async function updatePlannedAmount(paymentDocId, newValue) {
            var newAmount = parseFloat(newValue);
            if (isNaN(newAmount) || newAmount < 0) return;

            try {
                var payRef = db.collection('recurring_billing').doc(currentPaymentDocId)
                    .collection('payments').doc(paymentDocId);
                var payDoc = await payRef.get();
                var payData = payDoc.data();

                await payRef.update({ plannedAmount: newAmount });

                // עדכון סיכומים - תמיד מ-subcollection (מקור אמת יחיד)
                await recalcClientSummary(currentPaymentDocId);
            } catch (error) {
                console.error('Error updating amount:', error);
            }
        }

        // עדכון סכום ששולם בפועל (עבור תשלום שכבר בוצע)
        async function updateActualAmount(paymentDocId, newValue) {
            var newAmount = parseFloat(newValue);
            if (isNaN(newAmount) || newAmount < 0) return;

            try {
                var payRef = db.collection('recurring_billing').doc(currentPaymentDocId)
                    .collection('payments').doc(paymentDocId);
                await payRef.update({ actualAmountPaid: newAmount });

                // עדכון סיכומי הלקוח
                await recalcClientSummary(currentPaymentDocId);

                // רענון סיכום חשבונאי במודאל
                var clientDoc = await db.collection('recurring_billing').doc(currentPaymentDocId).get();
                var refreshSnap = await db.collection('recurring_billing').doc(currentPaymentDocId)
                    .collection('payments').orderBy('monthNumber').get();
                var refreshPayments = [];
                refreshSnap.forEach(function(d) { refreshPayments.push({ id: d.id, ...d.data() }); });
                currentPayments = refreshPayments;
                renderAccountingSummary({ id: currentPaymentDocId, ...clientDoc.data() }, refreshPayments);

                // עדכון סרגל סיכום
                var completedP = refreshPayments.filter(function(p) { return p.status === 'בוצע'; });
                var totalActual = completedP.reduce(function(s, p) { return s + (parseFloat(p.actualAmountPaid) || 0); }, 0);
                var totalPlanned = refreshPayments.reduce(function(s, p) { return s + (parseFloat(p.plannedAmount) || 0); }, 0);
                var remaining = totalPlanned - totalActual;
                var summaryItems = document.querySelectorAll('.pm-summary-value');
                if (summaryItems.length >= 3) {
                    summaryItems[1].innerHTML = '₪' + totalActual.toLocaleString('he-IL');
                    summaryItems[2].innerHTML = '₪' + Math.max(0, remaining).toLocaleString('he-IL');
                }
            } catch (error) {
                console.error('Error updating actual amount:', error);
            }
        }

        // עריכת תשלום שכבר בוצע (שינוי תאריך תשלום)
        async function editCompletedPayment(clientDocId, paymentDocId) {
            var payData = currentPayments.find(function(p) { return p.id === paymentDocId; });
            if (!payData) return;

            var currentDate = payData.actualPaymentDate || payData.plannedDate || '';
            var newDate = prompt('תאריך תשלום בפועל (YYYY-MM-DD):', currentDate);
            if (newDate === null) return; // ביטול

            // אפשרות לביטול סימון
            if (newDate === '' && confirm('האם לבטל סימון תשלום זה כבוצע?')) {
                try {
                    var payRef = db.collection('recurring_billing').doc(clientDocId)
                        .collection('payments').doc(paymentDocId);
                    await payRef.update({
                        status: 'ממתין',
                        actualAmountPaid: null,
                        actualPaymentDate: null,
                        completedBy: null,
                        completedAt: null
                    });
                    await recalcClientSummary(clientDocId);
                    await openPaymentModal(clientDocId);
                } catch (error) {
                    console.error('Error reverting payment:', error);
                    alert('שגיאה בביטול: ' + error.message);
                }
                return;
            }

            // עדכון תאריך
            if (newDate) {
                try {
                    var payRef = db.collection('recurring_billing').doc(clientDocId)
                        .collection('payments').doc(paymentDocId);
                    await payRef.update({ actualPaymentDate: newDate });
                    await recalcClientSummary(clientDocId);
                    await openPaymentModal(clientDocId);
                } catch (error) {
                    console.error('Error updating payment date:', error);
                    alert('שגיאה בעדכון: ' + error.message);
                }
            }
        }

        // חישוב מחדש של סיכומי הלקוח מתוך subcollection
        async function recalcClientSummary(docId) {
            var snap = await db.collection('recurring_billing').doc(docId)
                .collection('payments').get();
            var totalPaid = 0;
            var totalPlanned = 0;
            var paidCount = 0;
            var activeCount = 0;
            var lastDate = null;
            snap.forEach(function(d) {
                var p = d.data();
                if (p.status !== 'בוטל') {
                    totalPlanned += parseFloat(p.plannedAmount) || 0;
                    activeCount++;
                }
                if (p.status === 'בוצע') {
                    totalPaid += parseFloat(p.actualAmountPaid) || parseFloat(p.plannedAmount) || 0;
                    paidCount++;
                    if (p.actualPaymentDate && (!lastDate || p.actualPaymentDate > lastDate)) {
                        lastDate = p.actualPaymentDate;
                    }
                }
            });
            await db.collection('recurring_billing').doc(docId).update({
                totalActualPaid: totalPaid,
                totalPlannedAmount: totalPlanned,
                completedPaymentsCount: paidCount,
                recurringMonthsCount: activeCount.toString(),
                lastPaymentDate: lastDate || ''
            });
        }

        // מחיקת תשלום מהסדרה
        async function deletePayment(clientDocId, paymentDocId, monthNumber) {
            if (!confirm('האם להסיר את תשלום #' + monthNumber + ' מהסדרה?\nפעולה זו לא ניתנת לביטול.')) return;

            try {
                // מחיקת המסמך מ-subcollection
                await db.collection('recurring_billing').doc(clientDocId)
                    .collection('payments').doc(paymentDocId).delete();

                // חישוב מחדש של כל הסיכומים מ-subcollection (מקור אמת יחיד)
                await recalcClientSummary(clientDocId);

                // רענון המודאל
                await openPaymentModal(clientDocId);
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('שגיאה במחיקה: ' + error.message);
            }
        }

        async function markNextPayment() {
            var nextPending = currentPayments.find(function(p) { return p.status === 'ממתין' || p.status === 'באיחור'; });
            if (!nextPending) {
                alert('אין תשלומים ממתינים');
                return;
            }
            await markSinglePayment(currentPaymentDocId, nextPending.id);
        }

        function closePaymentModal() {
            document.getElementById('pmOverlay').classList.remove('show');
            currentPaymentDocId = null;
            currentPayments = [];
            loadBillingData();
        }

        async function quickMarkPayment(docId) {
            try {
                var snap = await db.collection('recurring_billing').doc(docId)
                    .collection('payments').orderBy('monthNumber', 'asc').get();

                if (snap.empty) {
                    openPaymentModal(docId);
                    return;
                }

                var payments = [];
                snap.forEach(function(d) { payments.push({ id: d.id, ...d.data() }); });

                var next = payments.find(function(p) { return p.status === 'ממתין' || p.status === 'באיחור'; });
                if (!next) {
                    alert('אין תשלומים ממתינים');
                    return;
                }

                var planned = parseFloat(next.plannedAmount) || 0;
                if (!confirm('לסמן תשלום #' + next.monthNumber + ' (₪' + planned.toLocaleString('he-IL') + ') כבוצע?')) {
                    return;
                }

                currentPaymentDocId = docId;
                currentPayments = payments;
                await markSinglePayment(docId, next.id);
                currentPaymentDocId = null;
                currentPayments = [];

            } catch (error) {
                console.error('Error in quick mark:', error);
                alert('שגיאה: ' + error.message);
            }
        }

        async function cancelBillingSeriesUI() {
            if (!currentPaymentDocId) return;
            var pendingCount = currentPayments.filter(function(p) { return p.status === 'ממתין' || p.status === 'באיחור'; }).length;
            if (pendingCount === 0) {
                alert('אין תשלומים ממתינים לביטול');
                return;
            }
            if (!confirm('האם לבטל ' + pendingCount + ' תשלומים ממתינים? פעולה זו לא ניתנת לביטול.')) return;

            try {
                var batch = db.batch();
                currentPayments.forEach(function(p) {
                    if (p.status === 'ממתין' || p.status === 'באיחור') {
                        var ref = db.collection('recurring_billing').doc(currentPaymentDocId)
                            .collection('payments').doc(p.id);
                        batch.update(ref, { status: 'בוטל' });
                    }
                });
                await batch.commit();

                // עדכון סטטוס לקוח
                await db.collection('recurring_billing').doc(currentPaymentDocId).update({
                    status: 'בוטל'
                });

                // חישוב מחדש של סיכומים מ-subcollection
                await recalcClientSummary(currentPaymentDocId);

                alert('הסדרה בוטלה בהצלחה');
                await openPaymentModal(currentPaymentDocId);
            } catch (error) {
                console.error('Error cancelling series:', error);
                alert('שגיאה בביטול: ' + error.message);
            }
        }

        async function extendBillingSeriesUI() {
            if (!currentPaymentDocId) return;

            var additionalMonths = prompt('כמה חודשים להוסיף?', '');
            if (!additionalMonths || isNaN(parseInt(additionalMonths))) return;
            additionalMonths = parseInt(additionalMonths);

            var clientDoc = await db.collection('recurring_billing').doc(currentPaymentDocId).get();
            var client = clientDoc.data();
            var amount = parseFloat(client.recurringMonthlyAmount) || 0;

            var amountStr = prompt('סכום חודשי לחודשים החדשים:', amount.toString());
            if (!amountStr || isNaN(parseFloat(amountStr))) return;
            var monthlyAmount = parseFloat(amountStr);

            try {
                var currentTotal = parseInt(client.recurringMonthsCount) || currentPayments.length;
                var newTotal = currentTotal + additionalMonths;

                // עדכון סטטוס לפעיל (מספר חודשים יתעדכן ב-recalcClientSummary)
                await db.collection('recurring_billing').doc(currentPaymentDocId).update({
                    status: 'פעיל'
                });

                // חישוב התאריך הבא לפי התשלום האחרון
                var lastPayment = currentPayments[currentPayments.length - 1];
                var lastDate = lastPayment ? new Date(lastPayment.plannedDate) : new Date();
                var dayOfMonth = parseInt(client.recurringDayOfMonth) || lastDate.getDate();
                var billingPrefix = client.billingIdPrefix || '';

                // יצירת מסמכי תשלום חדשים ב-Firebase
                var batch = db.batch();
                for (var i = 0; i < additionalMonths; i++) {
                    var monthIndex = currentTotal + i;
                    var chargeDate = new Date(lastDate.getFullYear(), lastDate.getMonth() + i + 1, dayOfMonth);
                    if (chargeDate.getDate() !== dayOfMonth) {
                        chargeDate.setDate(0);
                    }

                    var payRef = db.collection('recurring_billing').doc(currentPaymentDocId)
                        .collection('payments').doc();
                    batch.set(payRef, {
                        monthNumber: monthIndex + 1,
                        plannedAmount: monthlyAmount,
                        plannedDate: chargeDate.toISOString().split('T')[0],
                        billingIdSuffix: billingPrefix ? billingPrefix + '-' + (monthIndex + 1) : '',
                        status: 'ממתין',
                        actualAmountPaid: null,
                        actualPaymentDate: null,
                        completedBy: null,
                        completedAt: null,
                        notes: ''
                    });
                }
                await batch.commit();

                // חישוב מחדש של סיכומים מ-subcollection (מקור אמת יחיד)
                await recalcClientSummary(currentPaymentDocId);

                alert('נוספו ' + additionalMonths + ' חודשים בהצלחה');
                await openPaymentModal(currentPaymentDocId);
            } catch (error) {
                console.error('Error extending series:', error);
                alert('שגיאה בהוספת חודשים: ' + error.message);
            }
        }

        // === טבלת סכומים לכל חודש בטופס הוספה ===
        function generateAmountsPreview() {
            var totalDealInput = document.getElementById('billingTotalDeal');
            var monthsInput = document.getElementById('billingMonths');
            var amountInput = document.getElementById('billingAmount');
            var preview = document.getElementById('billingAmountsPreview');
            var tableDiv = document.getElementById('billingAmountsTable');
            var summaryDiv = document.getElementById('billingAmountsSummary');

            var totalDeal = parseFloat(totalDealInput.value);
            var months = parseInt(monthsInput.value);

            if (!totalDeal || !months || months < 1) {
                preview.style.display = 'none';
                amountInput.value = '';
                return;
            }

            // חישוב סכום לכל תשלום (חלוקה שווה)
            var perMonth = Math.round((totalDeal / months) * 100) / 100;
            amountInput.value = perMonth;

            preview.style.display = 'block';
            summaryDiv.innerHTML = '<strong>סה"כ לגבייה:</strong> ₪' + totalDeal.toLocaleString('he-IL') + ' (' + months + ' תשלומים × ₪' + perMonth.toLocaleString('he-IL') + ')';

            // Generate table rows
            var startDate = document.getElementById('billingStartDate').value;
            var dayOfMonth = parseInt(document.getElementById('billingDayOfMonth').value) || 1;
            var baseDate = startDate ? new Date(startDate) : new Date();

            // חלוקה: תשלומים שווים, עם השלמה בתשלום האחרון
            var amounts = [];
            var runningTotal = 0;
            for (var i = 0; i < months; i++) {
                if (i === months - 1) {
                    // תשלום אחרון - השלמה למלוא הסכום
                    amounts.push(Math.round((totalDeal - runningTotal) * 100) / 100);
                } else {
                    amounts.push(perMonth);
                    runningTotal += perMonth;
                }
            }

            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr style="background:#0f172a;color:#fff;">';
            html += '<th style="padding:6px 8px;border-radius:0 6px 0 0;text-align:center;">תשלום</th>';
            html += '<th style="padding:6px 8px;text-align:center;">תאריך חיוב</th>';
            html += '<th style="padding:6px 8px;border-radius:6px 0 0 0;text-align:center;">סכום (₪)</th>';
            html += '</tr></thead><tbody>';

            for (var i = 0; i < months; i++) {
                var chargeDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, dayOfMonth);
                if (chargeDate.getDate() !== dayOfMonth) {
                    chargeDate.setDate(0);
                }
                var dateStr = chargeDate.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                var bgColor = i % 2 === 0 ? '#fff' : '#f8fafc';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;text-align:center;font-weight:600;color:#0f172a;">' + (i + 1) + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;color:#64748b;">' + dateStr + '</td>';
                html += '<td style="padding:4px 6px;text-align:center;">';
                html += '<input type="number" class="billing-month-amount" data-month="' + i + '" value="' + amounts[i] + '" ';
                html += 'style="width:90px;text-align:center;border:1px solid #e2e8f0;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Heebo,sans-serif;" ';
                html += 'onchange="balanceAmounts(' + i + ')">';
                html += '</td></tr>';
            }
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
            tableDiv.style.display = 'block';
            document.getElementById('billingAmountsToggle').textContent = 'הסתר טבלה';
            document.getElementById('billingAmountsToggle').style.background = '#0f172a';
            document.getElementById('billingAmountsToggle').style.color = '#fff';

            updateAmountsSummary();
        }

        function toggleAmountsTable() {
            var tableDiv = document.getElementById('billingAmountsTable');
            var toggleBtn = document.getElementById('billingAmountsToggle');
            if (tableDiv.style.display === 'none' || !tableDiv.style.display) {
                tableDiv.style.display = 'block';
                toggleBtn.textContent = 'הסתר טבלה';
                toggleBtn.style.background = 'var(--primary-blue)';
                toggleBtn.style.color = '#fff';
            } else {
                tableDiv.style.display = 'none';
                toggleBtn.textContent = 'ערוך סכומים';
                toggleBtn.style.background = 'none';
                toggleBtn.style.color = 'var(--primary-blue)';
            }
        }

        // השלמה אוטומטית - כשמשנים תשלום אחד, האחרון מתאזן
        function balanceAmounts(changedIndex) {
            var inputs = document.querySelectorAll('.billing-month-amount');
            var totalDeal = parseFloat(document.getElementById('billingTotalDeal').value) || 0;
            if (!totalDeal || inputs.length === 0) return;

            // חישוב סכום כל התשלומים חוץ מהאחרון
            var sumExceptLast = 0;
            for (var i = 0; i < inputs.length - 1; i++) {
                sumExceptLast += parseFloat(inputs[i].value) || 0;
            }

            // עדכון התשלום האחרון כהשלמה
            var lastAmount = Math.round((totalDeal - sumExceptLast) * 100) / 100;
            inputs[inputs.length - 1].value = lastAmount;

            // אם האחרון יצא שלילי - התראה
            if (lastAmount < 0) {
                inputs[inputs.length - 1].style.borderColor = '#ef4444';
                inputs[inputs.length - 1].style.color = '#ef4444';
            } else {
                inputs[inputs.length - 1].style.borderColor = '#e2e8f0';
                inputs[inputs.length - 1].style.color = '';
            }

            updateAmountsSummary();
        }

        function updateAmountsSummary() {
            var inputs = document.querySelectorAll('.billing-month-amount');
            var summaryDiv = document.getElementById('billingAmountsSummary');
            var totalDeal = parseFloat(document.getElementById('billingTotalDeal').value) || 0;
            var total = 0;
            var allSame = true;
            var firstVal = inputs.length > 0 ? parseFloat(inputs[0].value) : 0;

            inputs.forEach(function(inp) {
                var val = parseFloat(inp.value) || 0;
                total += val;
                if (Math.abs(val - firstVal) > 0.01) allSame = false;
            });

            var diff = Math.round((total - totalDeal) * 100) / 100;
            var text = '<strong>סה"כ לגבייה:</strong> ₪' + total.toLocaleString('he-IL') + ' (' + inputs.length + ' תשלומים)';
            if (!allSame) {
                text += ' <span style="color:#0f172a;font-weight:600;">⚡ תשלומים לא שווים</span>';
            }
            if (diff !== 0) {
                text += ' <span style="color:#ef4444;font-weight:600;">⚠ הפרש: ₪' + diff.toLocaleString('he-IL') + '</span>';
            } else {
                text += ' <span style="color:#16a34a;">✓ מאוזן</span>';
            }
            summaryDiv.innerHTML = text;
        }

        // === טבלת סכומים לכל חודש בטופס עריכה ===
        var editPaymentsCache = []; // שמירת תשלומים שנטענו מ-Firebase

        async function loadEditAmountsTable(docId, clientData) {
            var preview = document.getElementById('editAmountsPreview');
            var tableDiv = document.getElementById('editAmountsTable');
            var summaryDiv = document.getElementById('editAmountsSummary');

            // טעינת תשלומים מ-subcollection
            var snap = await db.collection('recurring_billing').doc(docId)
                .collection('payments').orderBy('monthNumber', 'asc').get();

            if (snap.empty) {
                // אין subcollection - הצגת חישוב מהנתוני לקוח
                var totalDeal = parseFloat(document.getElementById('editTotalDeal').value) || 0;
                var months = parseInt(document.getElementById('editMonths').value) || 0;
                if (totalDeal && months) {
                    generateEditAmountsPreview();
                } else {
                    preview.style.display = 'none';
                }
                return;
            }

            editPaymentsCache = [];
            snap.forEach(function(d) {
                editPaymentsCache.push({ id: d.id, ...d.data() });
            });

            preview.style.display = 'block';

            var startDate = document.getElementById('editStartDate').value;
            var dayOfMonth = parseInt(document.getElementById('editDayOfMonth').value) || 1;

            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr style="background:#0f172a;color:#fff;">';
            html += '<th style="padding:6px 8px;border-radius:0 6px 0 0;text-align:center;">תשלום</th>';
            html += '<th style="padding:6px 8px;text-align:center;">תאריך חיוב</th>';
            html += '<th style="padding:6px 8px;text-align:center;">סטטוס</th>';
            html += '<th style="padding:6px 8px;border-radius:6px 0 0 0;text-align:center;">סכום (₪)</th>';
            html += '</tr></thead><tbody>';

            editPaymentsCache.forEach(function(p, i) {
                var dateStr = p.plannedDate ? new Date(p.plannedDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                var bgColor = i % 2 === 0 ? '#fff' : '#f8fafc';
                var statusColor = p.status === 'בוצע' ? '#16a34a' : (p.status === 'באיחור' ? '#ef4444' : (p.status === 'בוטל' ? '#9ca3af' : '#f59e0b'));
                var isEditable = p.status !== 'בוצע' && p.status !== 'בוטל';

                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;text-align:center;font-weight:600;color:#0f172a;">' + p.monthNumber + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;color:#64748b;">' + dateStr + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;"><span style="color:' + statusColor + ';font-size:11px;font-weight:600;">' + (p.status || 'ממתין') + '</span></td>';
                html += '<td style="padding:4px 6px;text-align:center;">';
                if (isEditable) {
                    html += '<input type="number" class="edit-month-amount" data-index="' + i + '" data-payment-id="' + p.id + '" value="' + (parseFloat(p.plannedAmount) || 0) + '" ';
                    html += 'style="width:90px;text-align:center;border:1px solid #e2e8f0;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Heebo,sans-serif;" ';
                    html += 'onchange="balanceEditAmounts(' + i + ')">';
                } else {
                    html += '<span style="color:' + statusColor + ';font-weight:600;">₪' + (parseFloat(p.plannedAmount) || 0).toLocaleString('he-IL') + '</span>';
                }
                html += '</td></tr>';
            });

            html += '</tbody></table>';
            tableDiv.innerHTML = html;
            tableDiv.style.display = 'block';

            var toggleBtn = document.getElementById('editAmountsToggle');
            toggleBtn.textContent = 'הסתר טבלה';
            toggleBtn.style.background = '#0f172a';
            toggleBtn.style.color = '#fff';

            updateEditAmountsSummary();
        }

        function generateEditAmountsPreview() {
            var totalDeal = parseFloat(document.getElementById('editTotalDeal').value) || 0;
            var months = parseInt(document.getElementById('editMonths').value) || 0;
            var preview = document.getElementById('editAmountsPreview');
            var tableDiv = document.getElementById('editAmountsTable');

            if (!totalDeal || !months) {
                preview.style.display = 'none';
                return;
            }

            // אם יש כבר תשלומים מ-subcollection, לא ליצור חדשים
            if (editPaymentsCache.length > 0) {
                updateEditAmountsSummary();
                return;
            }

            var perMonth = Math.round((totalDeal / months) * 100) / 100;
            document.getElementById('editAmount').value = perMonth;
            preview.style.display = 'block';

            var startDate = document.getElementById('editStartDate').value;
            var dayOfMonth = parseInt(document.getElementById('editDayOfMonth').value) || 1;
            var baseDate = startDate ? new Date(startDate) : new Date();

            var amounts = [];
            var runningTotal = 0;
            for (var i = 0; i < months; i++) {
                if (i === months - 1) {
                    amounts.push(Math.round((totalDeal - runningTotal) * 100) / 100);
                } else {
                    amounts.push(perMonth);
                    runningTotal += perMonth;
                }
            }

            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr style="background:#0f172a;color:#fff;">';
            html += '<th style="padding:6px 8px;border-radius:0 6px 0 0;text-align:center;">תשלום</th>';
            html += '<th style="padding:6px 8px;text-align:center;">תאריך חיוב</th>';
            html += '<th style="padding:6px 8px;border-radius:6px 0 0 0;text-align:center;">סכום (₪)</th>';
            html += '</tr></thead><tbody>';

            for (var i = 0; i < months; i++) {
                var chargeDate = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, dayOfMonth);
                if (chargeDate.getDate() !== dayOfMonth) chargeDate.setDate(0);
                var dateStr = chargeDate.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                var bgColor = i % 2 === 0 ? '#fff' : '#f8fafc';
                html += '<tr style="background:' + bgColor + ';">';
                html += '<td style="padding:6px 8px;text-align:center;font-weight:600;color:#0f172a;">' + (i + 1) + '</td>';
                html += '<td style="padding:6px 8px;text-align:center;color:#64748b;">' + dateStr + '</td>';
                html += '<td style="padding:4px 6px;text-align:center;">';
                html += '<input type="number" class="edit-month-amount" data-index="' + i + '" value="' + amounts[i] + '" ';
                html += 'style="width:90px;text-align:center;border:1px solid #e2e8f0;border-radius:4px;padding:4px 6px;font-size:12px;font-family:Heebo,sans-serif;" ';
                html += 'onchange="balanceEditAmounts(' + i + ')">';
                html += '</td></tr>';
            }
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
            tableDiv.style.display = 'block';
            document.getElementById('editAmountsToggle').textContent = 'הסתר טבלה';
            document.getElementById('editAmountsToggle').style.background = '#0f172a';
            document.getElementById('editAmountsToggle').style.color = '#fff';
            updateEditAmountsSummary();
        }

        function toggleEditAmountsTable() {
            var tableDiv = document.getElementById('editAmountsTable');
            var toggleBtn = document.getElementById('editAmountsToggle');
            if (tableDiv.style.display === 'none' || !tableDiv.style.display) {
                tableDiv.style.display = 'block';
                toggleBtn.textContent = 'הסתר טבלה';
                toggleBtn.style.background = '#0f172a';
                toggleBtn.style.color = '#fff';
            } else {
                tableDiv.style.display = 'none';
                toggleBtn.textContent = 'ערוך סכומים';
                toggleBtn.style.background = 'none';
                toggleBtn.style.color = 'var(--primary-blue)';
            }
        }

        function balanceEditAmounts(changedIndex) {
            var inputs = document.querySelectorAll('.edit-month-amount');
            var totalDeal = parseFloat(document.getElementById('editTotalDeal').value) || 0;
            if (!totalDeal || inputs.length === 0) return;

            // סכום כל התשלומים חוץ מהאחרון הניתן לעריכה
            var editableInputs = [];
            inputs.forEach(function(inp) { editableInputs.push(inp); });

            var sumExceptLast = 0;
            for (var i = 0; i < editableInputs.length - 1; i++) {
                sumExceptLast += parseFloat(editableInputs[i].value) || 0;
            }

            // הוספת סכום תשלומים שבוצעו (לא ניתנים לעריכה)
            var completedSum = 0;
            editPaymentsCache.forEach(function(p) {
                if (p.status === 'בוצע' || p.status === 'בוטל') {
                    if (p.status === 'בוצע') completedSum += parseFloat(p.plannedAmount) || 0;
                }
            });

            var lastAmount = Math.round((totalDeal - completedSum - sumExceptLast) * 100) / 100;
            editableInputs[editableInputs.length - 1].value = lastAmount;

            if (lastAmount < 0) {
                editableInputs[editableInputs.length - 1].style.borderColor = '#ef4444';
                editableInputs[editableInputs.length - 1].style.color = '#ef4444';
            } else {
                editableInputs[editableInputs.length - 1].style.borderColor = '#e2e8f0';
                editableInputs[editableInputs.length - 1].style.color = '';
            }

            updateEditAmountsSummary();
        }

        function updateEditAmountsSummary() {
            var inputs = document.querySelectorAll('.edit-month-amount');
            var summaryDiv = document.getElementById('editAmountsSummary');
            var totalDeal = parseFloat(document.getElementById('editTotalDeal').value) || 0;

            // סכום תשלומים שניתנים לעריכה
            var editableTotal = 0;
            inputs.forEach(function(inp) {
                editableTotal += parseFloat(inp.value) || 0;
            });

            // סכום תשלומים שבוצעו
            var completedTotal = 0;
            editPaymentsCache.forEach(function(p) {
                if (p.status === 'בוצע') completedTotal += parseFloat(p.plannedAmount) || 0;
            });

            var grandTotal = editableTotal + completedTotal;
            var diff = Math.round((grandTotal - totalDeal) * 100) / 100;
            var totalPayments = (inputs.length || 0) + editPaymentsCache.filter(function(p) { return p.status === 'בוצע'; }).length;
            // if we have editPaymentsCache, total is its full length minus cancelled
            if (editPaymentsCache.length > 0) {
                totalPayments = editPaymentsCache.filter(function(p) { return p.status !== 'בוטל'; }).length;
            }

            var text = '<strong>סה"כ:</strong> ₪' + grandTotal.toLocaleString('he-IL') + ' (' + totalPayments + ' תשלומים)';
            if (diff !== 0) {
                text += ' <span style="color:#ef4444;font-weight:600;">⚠ הפרש: ₪' + diff.toLocaleString('he-IL') + '</span>';
            } else {
                text += ' <span style="color:#16a34a;">✓ מאוזן</span>';
            }
            summaryDiv.innerHTML = text;
        }

        function getEditMonthlyAmountsFromTable() {
            var inputs = document.querySelectorAll('.edit-month-amount');
            if (inputs.length === 0 && editPaymentsCache.length === 0) return null;

            var amounts = {};
            // סכומים מתשלומים שבוצעו (לא ניתנים לעריכה)
            editPaymentsCache.forEach(function(p) {
                if ((p.status === 'בוצע' || p.status === 'בוטל') && p.id) {
                    amounts[p.id] = parseFloat(p.plannedAmount) || 0;
                }
            });
            // סכומים מ-inputs
            inputs.forEach(function(inp) {
                var payId = inp.getAttribute('data-payment-id');
                if (payId) {
                    amounts[payId] = parseFloat(inp.value) || 0;
                }
            });

            return Object.keys(amounts).length > 0 ? amounts : null;
        }

        function getMonthlyAmountsFromTable() {
            var inputs = document.querySelectorAll('.billing-month-amount');
            if (inputs.length === 0) return null;

            var baseAmount = parseFloat(document.getElementById('billingAmount').value) || 0;
            var amounts = [];
            var hasCustom = false;

            inputs.forEach(function(inp) {
                var val = parseFloat(inp.value) || 0;
                amounts.push(val);
                if (val !== baseAmount) hasCustom = true;
            });

            return hasCustom ? amounts : null;
        }

        // Card number formatting in edit modal
        document.addEventListener('DOMContentLoaded', function() {
            var editCardInput = document.getElementById('editCardNumber');
            if (editCardInput) {
                editCardInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 16);
                    e.target.value = val.replace(/(\d{4})(?=\d)/g, '$1 ');
                });
            }
            var editExpiryInput = document.getElementById('editCardExpiry');
            if (editExpiryInput) {
                editExpiryInput.addEventListener('input', function(e) {
                    var val = e.target.value.replace(/\D/g, '').substring(0, 4);
                    if (val.length >= 3) val = val.substring(0, 2) + '/' + val.substring(2);
                    e.target.value = val;
                });
            }

            // Event listeners לטבלת סכומים בטופס הוספת גבייה
            var billingTotalDealField = document.getElementById('billingTotalDeal');
            var billingMonthsField = document.getElementById('billingMonths');
            var billingStartDateField = document.getElementById('billingStartDate');
            var billingDayOfMonthField = document.getElementById('billingDayOfMonth');

            if (billingTotalDealField) {
                billingTotalDealField.addEventListener('input', generateAmountsPreview);
            }
            if (billingMonthsField) {
                billingMonthsField.addEventListener('input', generateAmountsPreview);
            }
            if (billingStartDateField) {
                billingStartDateField.addEventListener('change', generateAmountsPreview);
            }
            if (billingDayOfMonthField) {
                billingDayOfMonthField.addEventListener('input', generateAmountsPreview);
            }

            // Edit modal - auto-calculate per-payment amount
            var editTotalDealField = document.getElementById('editTotalDeal');
            var editMonthsField = document.getElementById('editMonths');
            function calcEditPerPayment() {
                var total = parseFloat(editTotalDealField.value) || 0;
                var months = parseInt(editMonthsField.value) || 0;
                document.getElementById('editAmount').value = (total && months) ? Math.round(total / months) : '';
                // עדכון תצוגת טבלה אם אין subcollection קיים
                if (editPaymentsCache.length === 0) {
                    generateEditAmountsPreview();
                } else {
                    updateEditAmountsSummary();
                }
            }
            if (editTotalDealField) editTotalDealField.addEventListener('input', calcEditPerPayment);
            if (editMonthsField) editMonthsField.addEventListener('input', calcEditPerPayment);
        });

        // Initialize
        updateProgress();

        // ========== Bottom Navigation ==========
        function setActiveNav(id) {
            document.querySelectorAll('.bottom-nav-item').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function navHome() {
            hideBillingManagement();
            document.getElementById('mainContainer').style.display = '';
            document.getElementById('userSelection').classList.remove('hidden');
            document.getElementById('mainForm').classList.add('hidden');
            document.getElementById('successScreen').classList.remove('show');
            setActiveNav('navHomeBtn');
        }

        function navNewSale() {
            hideBillingManagement();
            document.getElementById('mainContainer').style.display = '';
            if (!currentUser) {
                document.getElementById('userSelection').classList.remove('hidden');
                document.getElementById('mainForm').classList.add('hidden');
            }
            setActiveNav('navNewSaleBtn');
        }

        function navAddBilling() {
            openBillingModal();
            setActiveNav('navAddBillingBtn');
        }

        function navBillingMgmt() {
            showBillingManagement();
            setActiveNav('navBillingMgmtBtn');
        }

        function navInvoices() {
            showInvoicesManagement();
            setActiveNav('navInvoicesBtn');
        }

        function navLogout() {
            handleLogout();
        }

        // ========== Invoices Management ==========
        var invoicesList = [];
        var invSearchTimeout = null;

        function showInvoicesManagement() {
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('billingManagement').classList.remove('active');
            document.getElementById('invoicesManagement').classList.add('active');
            loadInvoicesData();
        }

        function hideInvoicesManagement() {
            document.getElementById('invoicesManagement').classList.remove('active');
            document.getElementById('mainContainer').style.display = '';
        }

        async function loadInvoicesData() {
            var loading = document.getElementById('invLoading');
            var empty = document.getElementById('invEmpty');
            var tableView = document.getElementById('invTableView');

            loading.style.display = '';
            empty.style.display = 'none';
            tableView.style.display = 'none';

            try {
                var snapshot = await db.collection('invoices').orderBy('createdAt', 'desc').get();
                invoicesList = [];
                snapshot.forEach(function(doc) {
                    invoicesList.push({ id: doc.id, ...doc.data() });
                });

                loading.style.display = 'none';

                if (invoicesList.length === 0) {
                    empty.style.display = '';
                    tableView.style.display = 'none';
                } else {
                    empty.style.display = 'none';
                    tableView.style.display = '';
                }

                updateInvoicesSummary();
                renderInvoicesTable(invoicesList);
            } catch (error) {
                console.error('Error loading invoices:', error);
                loading.style.display = 'none';
                empty.style.display = '';
            }
        }

        function updateInvoicesSummary() {
            var totalCount = invoicesList.length;
            var totalAmount = 0;
            var thisMonth = new Date().toISOString().slice(0, 7);
            var monthCount = 0;

            invoicesList.forEach(function(inv) {
                totalAmount += parseFloat(inv.total) || 0;
                if (inv.date && inv.date.slice(0, 7) === thisMonth) monthCount++;
            });

            document.getElementById('invStatTotal').textContent = totalCount;
            document.getElementById('invStatAmount').textContent = '₪' + totalAmount.toLocaleString('he-IL');
            document.getElementById('invStatMonth').textContent = monthCount;
        }

        function filterInvoices() {
            clearTimeout(invSearchTimeout);
            invSearchTimeout = setTimeout(function() {
                var term = (document.getElementById('invSearch').value || '').trim().toLowerCase();
                var monthFilter = document.getElementById('invMonthFilter').value || '';

                var filtered = invoicesList.filter(function(inv) {
                    var matchSearch = !term ||
                        (inv.clientName || '').toLowerCase().indexOf(term) > -1 ||
                        String(inv.invoiceNumber || '').indexOf(term) > -1;
                    var matchMonth = !monthFilter || (inv.date || '').slice(0, 7) === monthFilter;
                    return matchSearch && matchMonth;
                });

                renderInvoicesTable(filtered);
            }, 200);
        }

        function renderInvoicesTable(list) {
            var tbody = document.getElementById('invTableBody');
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#94a3b8;padding:24px;">לא נמצאו חשבונות</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(function(inv) {
                var subtotal = parseFloat(inv.subtotal) || 0;
                var vat = parseFloat(inv.vatAmount) || 0;
                var total = parseFloat(inv.total) || 0;
                var statusClass = inv.status === 'שולם' ? 'paid' : (inv.status === 'נשלח' ? 'sent' : 'draft');
                var statusText = inv.status || 'טיוטה';
                var dateStr = inv.date ? new Date(inv.date).toLocaleDateString('he-IL') : '';

                return '<tr>' +
                    '<td><strong>' + (inv.invoiceNumber || '') + '</strong></td>' +
                    '<td>' + dateStr + '</td>' +
                    '<td>' + (inv.clientName || '') + '</td>' +
                    '<td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (inv.subject || '') + '</td>' +
                    '<td style="font-weight:600;">₪' + subtotal.toLocaleString('he-IL') + '</td>' +
                    '<td>₪' + vat.toLocaleString('he-IL') + '</td>' +
                    '<td style="font-weight:700;color:#0f172a;">₪' + total.toLocaleString('he-IL') + '</td>' +
                    '<td><span class="inv-badge ' + statusClass + '">' + statusText + '</span></td>' +
                    '<td style="white-space:nowrap;">' +
                        '<div style="display:flex;gap:4px;flex-wrap:wrap;">' +
                            '<button class="inv-action-btn primary" onclick="downloadInvoicePDF(\'' + inv.id + '\')">PDF</button>' +
                            '<button class="inv-action-btn whatsapp" onclick="sendInvoiceWhatsApp(\'' + inv.id + '\')">WhatsApp</button>' +
                            '<button class="inv-action-btn" onclick="sendInvoiceEmail(\'' + inv.id + '\')">מייל</button>' +
                            '<button class="inv-action-btn" onclick="toggleInvoiceStatus(\'' + inv.id + '\')">' +
                                (inv.status === 'שולם' ? 'בטל שולם' : 'סמן שולם') +
                            '</button>' +
                            '<button class="inv-action-btn danger" onclick="deleteInvoice(\'' + inv.id + '\')">מחק</button>' +
                        '</div>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        // ========== Invoice Modal ==========
        var invClientSearchTimeout = null;

        function openInvoiceModal() {
            document.getElementById('invModalOverlay').classList.add('show');
            // Reset form
            document.getElementById('invClientSearch').value = '';
            document.getElementById('invClientName').value = '';
            document.getElementById('invClientIdNumber').value = '';
            document.getElementById('invClientPhone').value = '';
            document.getElementById('invClientEmail').value = '';
            document.getElementById('invBillingClientId').value = '';
            document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invDueDate').value = '';
            document.getElementById('invAttorney').value = '';
            document.getElementById('invSubject').value = '';
            document.getElementById('invAutocomplete').style.display = 'none';

            // Reset line items to one empty row
            document.getElementById('invLineItems').innerHTML =
                '<tr class="inv-line-row">' +
                    '<td><input type="text" class="inv-line-desc" placeholder="תיאור השירות"></td>' +
                    '<td><input type="number" class="inv-line-qty" value="1" min="0" step="0.01" onchange="calcInvoiceTotals()" oninput="calcInvoiceTotals()"></td>' +
                    '<td><input type="number" class="inv-line-price" value="0" min="0" step="0.01" onchange="calcInvoiceTotals()" oninput="calcInvoiceTotals()"></td>' +
                    '<td class="inv-line-total">₪0</td>' +
                    '<td><button class="inv-remove-line" onclick="removeInvoiceLine(this)" title="הסר שורה">✕</button></td>' +
                '</tr>';
            calcInvoiceTotals();

            // Get next invoice number
            getNextInvoiceNumber();

            // Restore form view
            document.getElementById('invModalBody').style.display = '';
            document.getElementById('invModalFooter').style.display = '';
            document.getElementById('invModalTitle').textContent = 'חשבון עסקה חדש';
        }

        function closeInvoiceModal() {
            document.getElementById('invModalOverlay').classList.remove('show');
        }

        async function getNextInvoiceNumber() {
            try {
                var snap = await db.collection('invoices')
                    .orderBy('invoiceNumber', 'desc')
                    .limit(1)
                    .get();

                var nextNum = 1; // default - start from 1
                if (!snap.empty) {
                    var lastNum = parseInt(snap.docs[0].data().invoiceNumber) || 0;
                    nextNum = lastNum + 1;
                }
                document.getElementById('invNumber').value = nextNum;
            } catch (e) {
                document.getElementById('invNumber').value = 1;
            }
        }

        // Autocomplete from billing clients
        document.getElementById('invClientSearch').addEventListener('input', function(e) {
            var term = e.target.value.trim();
            clearTimeout(invClientSearchTimeout);
            var autocomplete = document.getElementById('invAutocomplete');

            if (term.length < 2) {
                autocomplete.style.display = 'none';
                return;
            }

            invClientSearchTimeout = setTimeout(async function() {
                try {
                    var snap = await db.collection('recurring_billing').get();
                    var results = [];
                    snap.forEach(function(doc) {
                        var d = doc.data();
                        if ((d.clientName || '').indexOf(term) > -1 ||
                            (d.idNumber || '').indexOf(term) > -1 ||
                            (d.phone || '').indexOf(term) > -1) {
                            results.push({ id: doc.id, ...d });
                        }
                    });

                    if (results.length === 0) {
                        autocomplete.style.display = 'none';
                        return;
                    }

                    autocomplete.innerHTML = results.slice(0, 8).map(function(r) {
                        return '<div style="padding:10px 14px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:13px;" ' +
                            'onmouseover="this.style.background=\'#f8fafc\'" onmouseout="this.style.background=\'white\'" ' +
                            'onclick="selectInvClient(\'' + r.id + '\',\'' + (r.clientName || '').replace(/'/g, "\\'") + '\',\'' + (r.idNumber || '') + '\',\'' + (r.phone || '') + '\',\'' + (r.email || '') + '\')">' +
                            '<strong>' + (r.clientName || '') + '</strong>' +
                            (r.idNumber ? ' <span style="color:#94a3b8;">(' + r.idNumber + ')</span>' : '') +
                        '</div>';
                    }).join('');
                    autocomplete.style.display = 'block';
                } catch (err) {
                    autocomplete.style.display = 'none';
                }
            }, 300);
        });

        function selectInvClient(id, name, idNumber, phone, email) {
            document.getElementById('invClientName').value = name;
            document.getElementById('invClientIdNumber').value = idNumber;
            document.getElementById('invClientPhone').value = phone;
            document.getElementById('invClientEmail').value = email;
            document.getElementById('invBillingClientId').value = id;
            document.getElementById('invClientSearch').value = name;
            document.getElementById('invAutocomplete').style.display = 'none';
        }

        function addInvoiceLine() {
            var tbody = document.getElementById('invLineItems');
            var row = document.createElement('tr');
            row.className = 'inv-line-row';
            row.innerHTML =
                '<td><input type="text" class="inv-line-desc" placeholder="תיאור השירות"></td>' +
                '<td><input type="number" class="inv-line-qty" value="1" min="0" step="0.01" onchange="calcInvoiceTotals()" oninput="calcInvoiceTotals()"></td>' +
                '<td><input type="number" class="inv-line-price" value="0" min="0" step="0.01" onchange="calcInvoiceTotals()" oninput="calcInvoiceTotals()"></td>' +
                '<td class="inv-line-total">₪0</td>' +
                '<td><button class="inv-remove-line" onclick="removeInvoiceLine(this)" title="הסר שורה">✕</button></td>';
            tbody.appendChild(row);
        }

        function removeInvoiceLine(btn) {
            var rows = document.querySelectorAll('.inv-line-row');
            if (rows.length <= 1) return; // keep at least one row
            btn.closest('tr').remove();
            calcInvoiceTotals();
        }

        function calcInvoiceTotals() {
            var rows = document.querySelectorAll('.inv-line-row');
            var subtotal = 0;

            rows.forEach(function(row) {
                var qty = parseFloat(row.querySelector('.inv-line-qty').value) || 0;
                var price = parseFloat(row.querySelector('.inv-line-price').value) || 0;
                var lineTotal = qty * price;
                row.querySelector('.inv-line-total').textContent = '₪' + lineTotal.toLocaleString('he-IL');
                subtotal += lineTotal;
            });

            var vatRate = 18;
            var vatAmount = Math.round(subtotal * vatRate / 100);
            var grandTotal = subtotal + vatAmount;

            document.getElementById('invSubtotal').textContent = '₪' + subtotal.toLocaleString('he-IL');
            document.getElementById('invVatAmount').textContent = '₪' + vatAmount.toLocaleString('he-IL');
            document.getElementById('invGrandTotal').textContent = '₪' + grandTotal.toLocaleString('he-IL');
        }

        async function submitInvoice() {
            var clientName = document.getElementById('invClientName').value.trim();
            var invDate = document.getElementById('invDate').value;
            var subject = document.getElementById('invSubject').value.trim();

            if (!clientName || !invDate || !subject) {
                alert('נא למלא שם לקוח, תאריך ונושא');
                return;
            }

            var btn = document.getElementById('invSubmitBtn');
            btn.disabled = true;
            document.getElementById('invSubmitText').textContent = 'שומר...';

            try {
                // Collect line items
                var rows = document.querySelectorAll('.inv-line-row');
                var lineItems = [];
                var subtotal = 0;

                rows.forEach(function(row) {
                    var desc = row.querySelector('.inv-line-desc').value.trim();
                    var qty = parseFloat(row.querySelector('.inv-line-qty').value) || 0;
                    var price = parseFloat(row.querySelector('.inv-line-price').value) || 0;
                    var total = qty * price;
                    if (desc || total > 0) {
                        lineItems.push({ description: desc, quantity: qty, unitPrice: price, total: total });
                        subtotal += total;
                    }
                });

                if (lineItems.length === 0) {
                    alert('נא להוסיף לפחות שורת פירוט אחת');
                    btn.disabled = false;
                    document.getElementById('invSubmitText').textContent = 'שמור ויצור PDF';
                    return;
                }

                var vatRate = 18;
                var vatAmount = Math.round(subtotal * vatRate / 100);
                var grandTotal = subtotal + vatAmount;
                var invoiceNumber = parseInt(document.getElementById('invNumber').value) || 1;

                var invoiceData = {
                    invoiceNumber: invoiceNumber,
                    date: invDate,
                    dueDate: document.getElementById('invDueDate').value || '',
                    clientName: clientName,
                    clientIdNumber: document.getElementById('invClientIdNumber').value || '',
                    clientPhone: document.getElementById('invClientPhone').value || '',
                    clientEmail: document.getElementById('invClientEmail').value || '',
                    billingClientId: document.getElementById('invBillingClientId').value || null,
                    attorney: document.getElementById('invAttorney').value || '',
                    subject: subject,
                    lineItems: lineItems,
                    subtotal: subtotal,
                    vatRate: vatRate,
                    vatAmount: vatAmount,
                    total: grandTotal,
                    status: 'טיוטה',
                    createdBy: authUser ? authUser.email : (currentUser || 'לא ידוע'),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                var docRef = await db.collection('invoices').add(invoiceData);

                // Show success + generate PDF
                document.getElementById('invModalBody').innerHTML =
                    '<div style="text-align:center;padding:30px 0;">' +
                        '<div style="width:60px;height:60px;background:#d1fae5;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px;color:#16a34a;">✓</div>' +
                        '<h3 style="margin:0 0 8px;color:#1f2937;">חשבון עסקה ' + invoiceNumber + ' נוצר בהצלחה!</h3>' +
                        '<p style="color:#6b7280;margin:0 0 4px;">' + clientName + '</p>' +
                        '<p style="color:#0f172a;font-weight:700;font-size:18px;margin:0;">סה"כ לתשלום: ₪' + grandTotal.toLocaleString('he-IL') + '</p>' +
                        '<div style="margin-top:20px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">' +
                            '<button class="inv-new-btn" onclick="downloadInvoicePDF(\'' + docRef.id + '\')" style="font-size:13px;padding:8px 16px;">הורד PDF</button>' +
                            '<button class="inv-action-btn whatsapp" onclick="sendInvoiceWhatsApp(\'' + docRef.id + '\')" style="padding:8px 16px;">שלח WhatsApp</button>' +
                            '<button class="inv-action-btn" onclick="sendInvoiceEmail(\'' + docRef.id + '\')" style="padding:8px 16px;">שלח מייל</button>' +
                        '</div>' +
                    '</div>';
                document.getElementById('invModalFooter').innerHTML =
                    '<button class="inv-new-btn" onclick="closeInvoiceModal();loadInvoicesData();" style="width:100%;">סגור</button>';

            } catch (error) {
                console.error('Error saving invoice:', error);
                alert('שגיאה בשמירה: ' + error.message);
                btn.disabled = false;
                document.getElementById('invSubmitText').textContent = 'שמור ויצור PDF';
            }
        }

        // ========== Invoice Actions ==========
        async function toggleInvoiceStatus(docId) {
            var inv = invoicesList.find(function(i) { return i.id === docId; });
            if (!inv) return;
            var newStatus = inv.status === 'שולם' ? 'נשלח' : 'שולם';
            try {
                await db.collection('invoices').doc(docId).update({ status: newStatus });
                loadInvoicesData();
            } catch (e) {
                alert('שגיאה: ' + e.message);
            }
        }

        async function deleteInvoice(docId) {
            if (!confirm('האם למחוק חשבון עסקה זה? פעולה זו לא ניתנת לביטול.')) return;
            try {
                await db.collection('invoices').doc(docId).delete();
                loadInvoicesData();
            } catch (e) {
                alert('שגיאה: ' + e.message);
            }
        }

        function sendInvoiceWhatsApp(docId) {
            var inv = invoicesList.find(function(i) { return i.id === docId; });
            if (!inv) return;
            var phone = (inv.clientPhone || '').replace(/\D/g, '');
            if (phone.startsWith('0')) phone = '972' + phone.slice(1);
            var text = 'שלום ' + (inv.clientName || '') + ',\n' +
                'מצורף חשבון עסקה מספר ' + inv.invoiceNumber + '\n' +
                'סה"כ לתשלום: ₪' + (inv.total || 0).toLocaleString('he-IL') + '\n' +
                'בברכה, משרד עו"ד גיא הרשקוביץ';
            window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(text), '_blank');

            // Update status to sent
            if (inv.status === 'טיוטה') {
                db.collection('invoices').doc(docId).update({ status: 'נשלח' });
                inv.status = 'נשלח';
                renderInvoicesTable(invoicesList);
            }
        }

        function sendInvoiceEmail(docId) {
            var inv = invoicesList.find(function(i) { return i.id === docId; });
            if (!inv) return;
            var email = inv.clientEmail || '';
            var subject = 'חשבון עסקה ' + inv.invoiceNumber + ' - משרד עו"ד גיא הרשקוביץ';
            var body = 'שלום ' + (inv.clientName || '') + ',\n\n' +
                'מצורף חשבון עסקה מספר ' + inv.invoiceNumber + '\n' +
                'נושא: ' + (inv.subject || '') + '\n' +
                'סה"כ לתשלום: ₪' + (inv.total || 0).toLocaleString('he-IL') + '\n\n' +
                'בברכה,\nמשרד עו"ד גיא הרשקוביץ\n' +
                'טלפון: 03-685-55-58\n' +
                'מייל: ACC@ghlawoffice.co.il';
            window.open('mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body), '_blank');

            if (inv.status === 'טיוטה') {
                db.collection('invoices').doc(docId).update({ status: 'נשלח' });
                inv.status = 'נשלח';
                renderInvoicesTable(invoicesList);
            }
        }

        // ========== Invoice PDF Generation ==========
        // Logo as base64 data URI
        var INV_LOGO_BASE64 = 'data:image/png;base64,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';

        async function downloadInvoicePDF(docId) {
            var inv = invoicesList.find(function(i) { return i.id === docId; });
            if (!inv) {
                var doc = await db.collection('invoices').doc(docId).get();
                if (!doc.exists) { alert('חשבון לא נמצא'); return; }
                inv = { id: doc.id, ...doc.data() };
            }

            var dateStr = inv.date ? new Date(inv.date).toLocaleDateString('he-IL') : '';
            var dueDateStr = inv.dueDate ? new Date(inv.dueDate).toLocaleDateString('he-IL') : '';
            var nowStr = new Date().toLocaleString('he-IL');

            // Build line items rows
            var linesHtml = '';
            (inv.lineItems || []).forEach(function(item, idx) {
                var bgColor = idx % 2 === 0 ? '#ffffff' : '#f8fafb';
                linesHtml += '<tr style="background:' + bgColor + ';">' +
                    '<td style="padding:12px 16px;border-bottom:1px solid #e8ecf0;text-align:right;font-size:13px;color:#374151;">' + (item.description || '') + '</td>' +
                    '<td style="padding:12px 16px;border-bottom:1px solid #e8ecf0;text-align:center;font-size:13px;color:#374151;">' + (item.quantity || 0) + '</td>' +
                    '<td style="padding:12px 16px;border-bottom:1px solid #e8ecf0;text-align:center;font-size:13px;color:#374151;">' + Number(item.unitPrice || 0).toLocaleString('he-IL') + ' &#8362;</td>' +
                    '<td style="padding:12px 16px;border-bottom:1px solid #e8ecf0;text-align:center;font-size:13px;font-weight:600;color:#1f2937;">' + Number(item.total || 0).toLocaleString('he-IL') + ' &#8362;</td>' +
                '</tr>';
            });

            var html = '' +
            '<div style="font-family:Heebo,Arial,sans-serif;direction:rtl;width:794px;box-sizing:border-box;background:white;position:relative;">' +

                // ===== TOP GREEN BAR =====
                '<div style="height:6px;background:linear-gradient(90deg,#059669,#10b981,#34d399);"></div>' +

                // ===== HEADER SECTION =====
                '<div style="padding:32px 40px 24px 40px;">' +
                    '<table style="width:100%;border-collapse:collapse;"><tr>' +
                        // Right side - Logo
                        '<td style="width:160px;vertical-align:top;">' +
                            '<img src="' + INV_LOGO_BASE64 + '" style="width:120px;height:auto;">' +
                        '</td>' +
                        // Center - Firm details
                        '<td style="vertical-align:top;text-align:center;padding:0 10px;">' +
                            '<div style="font-size:15px;font-weight:700;color:#1e293b;margin-bottom:6px;">גיא הרשקוביץ חברת עורכי דין</div>' +
                            '<div style="font-size:11px;color:#64748b;line-height:1.7;">' +
                                'עוסק מורשה (ח.פ): 515577161<br>' +
                                'מנחם בגין 144, מגדל מידטאון, תל אביב - יפו<br>' +
                                'טל: 03-685-55-58 | פקס: 03-620-77-71<br>' +
                                'ACC@ghlawoffice.co.il | ghlawoffice.co.il' +
                            '</div>' +
                        '</td>' +
                        // Left side - Client info
                        '<td style="width:200px;vertical-align:top;text-align:left;">' +
                            '<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:14px 16px;">' +
                                '<div style="font-size:10px;color:#059669;font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">לכבוד</div>' +
                                '<div style="font-size:15px;font-weight:700;color:#1e293b;margin-bottom:4px;">' + (inv.clientName || '') + '</div>' +
                                (inv.clientIdNumber ? '<div style="font-size:11px;color:#64748b;">ח.פ/ת.ז: ' + inv.clientIdNumber + '</div>' : '') +
                                (inv.clientPhone ? '<div style="font-size:11px;color:#64748b;">טלפון: ' + inv.clientPhone + '</div>' : '') +
                            '</div>' +
                        '</td>' +
                    '</tr></table>' +
                '</div>' +

                // ===== INVOICE TITLE BAR =====
                '<div style="background:linear-gradient(135deg,#065f46,#059669);padding:20px 40px;margin:0;">' +
                    '<table style="width:100%;border-collapse:collapse;"><tr>' +
                        '<td style="text-align:right;">' +
                            '<div style="font-size:24px;font-weight:700;color:#ffffff;letter-spacing:1px;">חשבון עסקה מס\' ' + inv.invoiceNumber + '</div>' +
                            '<div style="font-size:12px;color:#a7f3d0;margin-top:4px;">מקור</div>' +
                        '</td>' +
                        '<td style="text-align:left;">' +
                            '<div style="font-size:12px;color:#a7f3d0;">תאריך: ' + dateStr + '</div>' +
                            (dueDateStr ? '<div style="font-size:12px;color:#a7f3d0;margin-top:3px;">לתשלום עד: ' + dueDateStr + '</div>' : '') +
                        '</td>' +
                    '</tr></table>' +
                '</div>' +

                // ===== SUBJECT =====
                '<div style="padding:20px 40px 16px 40px;">' +
                    '<div style="font-size:15px;font-weight:700;color:#1e293b;text-align:center;padding:12px 20px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;">' +
                        'בגין: ' + (inv.subject || '') +
                    '</div>' +
                '</div>' +

                // ===== LINE ITEMS TABLE =====
                '<div style="padding:0 40px;">' +
                    '<table style="width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08);">' +
                        '<thead>' +
                            '<tr style="background:linear-gradient(135deg,#065f46,#059669);">' +
                                '<th style="padding:12px 16px;text-align:right;font-weight:600;font-size:12px;color:#ffffff;letter-spacing:0.3px;">פירוט</th>' +
                                '<th style="padding:12px 16px;text-align:center;font-weight:600;font-size:12px;color:#ffffff;width:70px;">כמות</th>' +
                                '<th style="padding:12px 16px;text-align:center;font-weight:600;font-size:12px;color:#ffffff;width:100px;">מחיר ליחידה</th>' +
                                '<th style="padding:12px 16px;text-align:center;font-weight:600;font-size:12px;color:#ffffff;width:110px;">סה"כ</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody>' + linesHtml + '</tbody>' +
                    '</table>' +
                '</div>' +

                // ===== TOTALS =====
                '<div style="padding:20px 40px 16px 40px;">' +
                    '<table style="width:280px;margin-right:0;margin-left:auto;border-collapse:collapse;">' +
                        '<tr>' +
                            '<td style="padding:8px 16px;font-size:13px;color:#64748b;text-align:right;">סה"כ לפני מע"מ</td>' +
                            '<td style="padding:8px 16px;font-size:13px;color:#1e293b;font-weight:600;text-align:left;width:120px;">' + Number(inv.subtotal || 0).toLocaleString('he-IL') + ' &#8362;</td>' +
                        '</tr>' +
                        '<tr>' +
                            '<td style="padding:8px 16px;font-size:13px;color:#64748b;text-align:right;">מע"מ 18%</td>' +
                            '<td style="padding:8px 16px;font-size:13px;color:#1e293b;text-align:left;">' + Number(inv.vatAmount || 0).toLocaleString('he-IL') + ' &#8362;</td>' +
                        '</tr>' +
                        '<tr>' +
                            '<td colspan="2" style="padding:0;"><div style="border-top:2px solid #059669;margin:4px 0;"></div></td>' +
                        '</tr>' +
                        '<tr style="background:#f0fdf4;">' +
                            '<td style="padding:12px 16px;font-size:16px;font-weight:700;color:#065f46;text-align:right;border-radius:8px 0 0 8px;">סה"כ לתשלום</td>' +
                            '<td style="padding:12px 16px;font-size:18px;font-weight:700;color:#059669;text-align:left;border-radius:0 8px 8px 0;">' + Number(inv.total || 0).toLocaleString('he-IL') + ' &#8362;</td>' +
                        '</tr>' +
                    '</table>' +
                '</div>' +

                // ===== DIVIDER =====
                '<div style="padding:0 40px;"><div style="border-top:1px solid #e2e8f0;margin:8px 0 16px 0;"></div></div>' +

                // ===== PAYMENT INSTRUCTIONS =====
                '<div style="padding:0 40px 20px 40px;">' +
                    '<div style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:10px;">שלום, ' + (inv.clientName || '').split(' ')[0] + '</div>' +
                    '<div style="font-size:12px;color:#475569;line-height:1.9;">' +
                        'מצורף חשבון עסקה בגין ' + (inv.subject || '') + '.<br>' +
                        'ניתן להסדיר את התשלום באחת מהדרכים הבאות:' +
                    '</div>' +

                    // Payment methods
                    '<table style="width:100%;border-collapse:collapse;margin-top:12px;">' +
                        '<tr>' +
                            // Credit card
                            '<td style="width:50%;vertical-align:top;padding-left:8px;">' +
                                '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px 16px;">' +
                                    '<div style="font-size:12px;font-weight:700;color:#059669;margin-bottom:4px;">&#128179; כרטיס אשראי</div>' +
                                    '<div style="font-size:11px;color:#64748b;">עד 4 תשלומים</div>' +
                                '</div>' +
                            '</td>' +
                            // Bank transfer
                            '<td style="width:50%;vertical-align:top;padding-right:8px;">' +
                                '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px 16px;">' +
                                    '<div style="font-size:12px;font-weight:700;color:#059669;margin-bottom:4px;">&#127974; העברה בנקאית</div>' +
                                    '<div style="font-size:11px;color:#64748b;line-height:1.7;">' +
                                        'בנק מזרחי טפחות<br>' +
                                        'סניף 421 - גן העיר<br>' +
                                        'חשבון: 333177<br>' +
                                        'ע"ש: גיא הרשקוביץ חברת עו"ד' +
                                    '</div>' +
                                '</div>' +
                            '</td>' +
                        '</tr>' +
                    '</table>' +

                    '<div style="font-size:11px;color:#94a3b8;margin-top:10px;font-style:italic;">' +
                        'לאחר ביצוע העברה בנקאית, יש להעביר אסמכתא למשרד לצורך שיוך התשלום.' +
                    '</div>' +
                '</div>' +

                // ===== FOOTER =====
                '<div style="background:#f8fafc;border-top:1px solid #e2e8f0;padding:14px 40px;">' +
                    '<table style="width:100%;border-collapse:collapse;"><tr>' +
                        '<td style="text-align:right;font-size:10px;color:#94a3b8;">' +
                            'הופק ב-' + nowStr + ' | חשבון עסקה ' + inv.invoiceNumber +
                        '</td>' +
                        '<td style="text-align:left;font-size:10px;color:#94a3b8;">' +
                            '<span style="background:#059669;color:white;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:600;">&#128274; חתימה דיגיטלית מאובטחת</span>' +
                        '</td>' +
                    '</tr></table>' +
                '</div>' +

                // ===== BOTTOM GREEN BAR =====
                '<div style="height:4px;background:linear-gradient(90deg,#059669,#10b981,#34d399);"></div>' +

            '</div>';

            // Render to PDF using html2canvas
            var preview = document.getElementById('invPdfPreview');
            preview.innerHTML = html;
            preview.style.display = 'block';

            try {
                var canvas = await html2canvas(preview, {
                    scale: 2.5,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: 794,
                    windowWidth: 794
                });

                var imgData = canvas.toDataURL('image/jpeg', 0.95);
                var jsPDFLib = window.jspdf || window.jsPDF;
                if (!jsPDFLib) { throw new Error('jsPDF library not loaded'); }
                var jsPDFClass = jsPDFLib.jsPDF || jsPDFLib;
                var pdf = new jsPDFClass('p', 'mm', 'a4');
                var pdfWidth = pdf.internal.pageSize.getWidth();
                var pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                var pageHeight = pdf.internal.pageSize.getHeight();
                if (pdfHeight <= pageHeight) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                } else {
                    var position = 0;
                    var remaining = pdfHeight;
                    while (remaining > 0) {
                        pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, pdfHeight);
                        remaining -= pageHeight;
                        if (remaining > 0) {
                            position -= pageHeight;
                            pdf.addPage();
                        }
                    }
                }

                pdf.save('חשבון_עסקה_' + inv.invoiceNumber + '.pdf');
            } catch (err) {
                console.error('Error generating PDF:', err);
                alert('שגיאה ביצירת PDF: ' + err.message);
            }

            preview.style.display = 'none';
            preview.innerHTML = '';
        }

        // Show/hide bottom nav based on auth state
        function updateBottomNav(show) {
            var nav = document.getElementById('bottomNav');
            if (nav) {
                nav.classList.toggle('bottom-nav-hidden', !show);
            }
        }

        // Hook into auth state
        var _origAuthCallback = null;
        var authUnsub = auth.onAuthStateChanged(function(user) {
            updateBottomNav(!!user);
        });
    </script>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav bottom-nav-hidden" id="bottomNav">
        <button class="bottom-nav-item active" id="navHomeBtn" onclick="navHome()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="bottom-nav-label">ראשי</span>
        </button>
        <button class="bottom-nav-item" id="navNewSaleBtn" onclick="navNewSale()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
            <span class="bottom-nav-label">טופס מכר</span>
        </button>
        <button class="bottom-nav-item" id="navAddBillingBtn" onclick="navAddBilling()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></svg>
            <span class="bottom-nav-label">הוספת גבייה</span>
        </button>
        <button class="bottom-nav-item" id="navBillingMgmtBtn" onclick="navBillingMgmt()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            <span class="bottom-nav-label">ניהול גבייה</span>
        </button>
        <button class="bottom-nav-item" id="navInvoicesBtn" onclick="navInvoices()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            <span class="bottom-nav-label">חשבונות</span>
        </button>
        <button class="bottom-nav-item" onclick="navLogout()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            <span class="bottom-nav-label">התנתק</span>
        </button>
    </nav>
</body>
</html>
